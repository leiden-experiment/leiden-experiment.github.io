(()=>{"use strict";var t,e={852:(t,e,i)=>{i.d(e,{Ny:()=>ri,lW:()=>wi,ID:()=>mi,QW:()=>xi,vh:()=>bi});var s=i(440),n=i.n(s);function a(t){let e="layerID,noteID,loopNumber,playerTime,correctTime,classification\n";for(const i of t.layersStats){const s=t.layersStats.indexOf(i);for(const t of i.hits)e+=`${s},${t.noteID},${t.loopNumber},${o(t.playerTime)},${o(t.correctTime)},${t.classification}\n`}return e}function o(t,e=3){return parseFloat((t/1e3).toFixed(e))}const r=Phaser.Math.Vector2,h=Phaser.GameObjects.Group,l=Phaser.GameObjects.Graphics,c=Phaser.Time.TimerEvent,d=Phaser.GameObjects.GameObject,u=Phaser.Geom.Rectangle,g=(Phaser.Geom.Circle,Phaser.Input.Pointer,Phaser.GameObjects.Text),p=(Phaser.GameObjects.Sprite,Phaser.GameObjects.Video,Phaser.GameObjects.RenderTexture,Phaser.Events.EventEmitter,Phaser.GameObjects.Image,Phaser.Scene),f=(Phaser.Tilemaps.Tile,Phaser.Tweens.Tween,Phaser.GameObjects.Particles.ParticleEmitter,Phaser.Physics.Matter.Sprite),m=(Phaser.Physics.Arcade.Sprite,"levels/"),v=m+"list.json",y=".mp3",b="assets/sounds/ui/menu_ding"+y,w="finger",x="previewVideoBackground",T="songNameBackground",k="layerScoreBackground",S="scoreboardBackground",P="menuCalibrateButton",L="menuSelectButton",C="optionsButton",B="targetInner",D="background1",O="mainBackground",I="playButton",_="easyButton",H="mediumButton",M="hardButton",V="backButton",A="buttonDing",E="calibrationBackground",F="menuLogo",K="resetButton",N="muteButton",j="unmuteButton",z="leftArrow",R="rightArrow",W="saveCSVButton",q="defaultLevelbackground",$="defaultPreviewbackground",G="assets/sprites/defaultTargetInner.png",J="assets/ui/back_button.png",U="assets/ui/mute_button.png",X="assets/ui/unmute_button.png",Z="data/config.json",Q={thumb:16777215,index:14948892,middle:38655,ring:16771584,pinky:14315734},Y={lineWidth:5,color:11393254,alpha:.5},tt={lineWidth:5,color:11393254,alpha:1,radius:.1},et="thumb",it="index",st=it,nt=16777215,at=14948892,ot=B,rt="targetOuter",ht=G,lt={scale:1.03,color:16777215,ease:"linear"},ct={scale:.78,color:5091146,ease:"linear"},dt={scale:.3,color:16744192,ease:"linear"},ut={scale:0,color:8421504,ease:"cubic.in"},gt="keydown-ESC",pt={font:"32px Courier",color:"#00ff00"},ft={position:ie(new r(.05,.05)),color:"white",scale:1,font:"30px Arial",depth:40,strokeThickness:0,shadowOffset:new r(2,2),shadowColor:"black",shadowBlurRadius:2},mt={color:[16436258,16291840,16266752,10421252],colorEase:"quad.out",lifespan:500,scale:{start:.7,end:0,ease:"sine.out"},speed:200,advance:500,frequency:50,blendMode:"ADD",duration:0},vt="flare",yt={position:ie(new r(.5,0)),size:ie(new r(.4,.04)),requiredTint:524543,completedRequiredTint:2840741,completedTint:ct.color,extraTint:ct.color,path:"assets/ui/progress_bar_segment.png",key:"segment",tintByNode:!1},bt={highKey:"metronome/high",highPath:"assets/sounds/metronome/high"+y,lowKey:"metronome/low",lowPath:"assets/sounds/metronome/low"+y},wt="countdown",xt={position:ie(new r(.5,.5)),color:"white",scale:1,ease:"Power0",font:"240px Arial",depth:30},Tt={position:ie(new r(.835,0)),size:new r(.16*window.innerWidth,.2684*window.innerHeight),textureKey:"infoBackground",opacity:.3,path:"assets/ui/info_background.png"},kt={position:ie(new r(.93,.9)),scale:new r(.3,.3),soundKey:A,textureKey:"skipButton",path:"assets/ui/skip_button.png"},St={position:ie(new r(.85,.02)),color:"white",font:"20px Arial",scale:1,depth:40},Pt={position:ie(new r(.85,.07)),color:"white",font:"20px Arial",scale:1,depth:40},Lt={position:ie(new r(.85,.12)),color:"white",font:"20px Arial",scale:1,depth:40},Ct={position:ie(new r(.85,.17)),color:"white",font:"20px Arial",scale:1,depth:40},Bt={position:ie(new r(.85,.22)),color:"white",font:"20px Arial",scale:1,depth:40},Dt=.115,Ot=new r(.43,.43),It=new r(.6,.6),_t=new r(1.5,1.5),Ht=new r(-32,-32),Mt=new r(32,-32),Vt=.07,At=.71,Et=.75,Ft="loading",Kt="level",Nt="scoreboard",jt="mainMenu",zt="levelSelect",Rt="calibration",Wt="options",qt=jt,$t={visible:!1,flip:!0,opacity:0,width:window.innerWidth,height:window.innerHeight,objectFit:"fill"},Gt={video:{width:{ideal:640},height:{ideal:360}},audio:!1},Jt={baseOptions:{delegate:"GPU"},runningMode:"VIDEO",numHands:1,minHandDetectionConfidence:.5,minHandPresenceConfidence:.5,minTrackingConfidence:.5},Ut="UNDEFINED";var Xt=function(t,e,i,s){return new(i||(i=Promise))((function(n,a){function o(t){try{h(s.next(t))}catch(t){a(t)}}function r(t){try{h(s.throw(t))}catch(t){a(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,r)}h((s=s.apply(t,e||[])).next())}))};function Zt(t){return new Promise(((e,i)=>Xt(this,void 0,void 0,(function*(){var s;yield(s=t,new Promise((function(t,e){const i=new XMLHttpRequest;i.open("GET",s),i.onload=function(){this.status>=200&&this.status<300?t(i):e({status:this.status,statusText:i.statusText})},i.onerror=function(){e({status:this.status,statusText:i.statusText})},i.send()}))).then((t=>{e(JSON.parse(t.responseText.toString("utf8")))})).catch((()=>{i()}))}))))}function Qt(t,e="no error message provided"){if(!t)throw new Error("Assertion failed: "+e)}function Yt(t,e=""){const i="".replace(/\\/g,"/")+e;return t=t.replace(/\\/g,"/"),"/"==Array.from(t)[0]?i+t:i+"/"+t}function te(t){return Yt(t,"")}function ee(t){return te(t),!0}function ie(t){return t instanceof r?new r(t.x*window.innerWidth,t.y*window.innerHeight):new r(t[0]*window.innerWidth,t[1]*window.innerHeight)}var se=i(213),ne=i.n(se);let ae,oe;function re(t){ae=t}function he(t){return new Promise(((e,i)=>{return s=this,n=void 0,o=function*(){let s=!1;ri?ae?(s=!1,e(ae)):yield wi().then((t=>{const[i,n]=t;console.info('INFO: Playing as "'+mi()+'" with config: "'+n+'"'),s=!1,re(i),e(i)})).catch((t=>{console.info("INFO: "+t),s=!0})):s=!0,s&&(console.info("INFO: Playing as guest"),yield Zt(te(t)).then((t=>{const i=t;re(i),e(i)})).catch((()=>{i()})))},new((a=void 0)||(a=Promise))((function(t,e){function i(t){try{h(o.next(t))}catch(t){e(t)}}function r(t){try{h(o.throw(t))}catch(t){e(t)}}function h(e){var s;e.done?t(e.value):(s=e.value,s instanceof a?s:new a((function(t){t(s)}))).then(i,r)}h((o=o.apply(s,n||[])).next())}));var s,n,a,o}))}function le(t){if(ri){const e=JSON.parse(JSON.stringify(t));bi(t.id,e).then((t=>{console.info("INFO: "+t)})).catch((t=>{console.info("INFO: "+t)}))}}var ce=function(t,e,i,s){return new(i||(i=Promise))((function(n,a){function o(t){try{h(s.next(t))}catch(t){a(t)}}function r(t){try{h(s.throw(t))}catch(t){a(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,r)}h((s=s.apply(t,e||[])).next())}))};const de=new class{init(t,e){return ce(this,void 0,void 0,(function*(){return new Promise(((i,s)=>ce(this,void 0,void 0,(function*(){e("Loading webcam..."),this.setupVideoElement(t),yield navigator.mediaDevices.getUserMedia(Gt).then((t=>{"srcObject"in this.video?(this.video.srcObject=t,this.video.addEventListener("loadeddata",(()=>{i(!0)}))):s("srcObject does not exist on older browsers")})).catch((t=>{s(t)}))}))))}))}found(){return null!=this.video.srcObject}setVisibility(t){this.video.style.visibility="",this.video.style.visibility=t?"shown":"hidden"}setWidth(t){this.video.width=t}setHeight(t){this.video.height=t}setupVideoElement(t){this.video=document.body.appendChild(document.createElement("video")),this.video.autoplay=!0,this.video.muted=!0,this.video.playsInline=!0,this.video.style.objectFit=t.objectFit,this.setWidth(t.width),this.setHeight(t.height),t.flip&&(this.video.style.cssText+="-moz-transform: scale(-1, 1);          -webkit-transform: scale(-1, 1); -o-transform: scale(-1, 1);          transform: scale(-1, 1); filter: FlipH;"),this.setVisibility(!1)}get video(){return Qt(null!=this.video_),this.video_}set video(t){this.video_=t}};var ue=i(260),ge=function(t,e,i,s){return new(i||(i=Promise))((function(n,a){function o(t){try{h(s.next(t))}catch(t){a(t)}}function r(t){try{h(s.throw(t))}catch(t){a(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,r)}h((s=s.apply(t,e||[])).next())}))};const pe=new class{constructor(){this.lastVideoTime=-1}init(t){return ge(this,void 0,void 0,(function*(){return new Promise(((e,i)=>ge(this,void 0,void 0,(function*(){let s;yield ue.Ps.forVisionTasks(Yt("models/wasm")).then((t=>s=t)).catch((t=>{i(t)})),t("Loading hand landmarker..."),Jt.baseOptions.modelAssetPath=te("models/hand_landmarker.task"),yield ue.Vb.createFromOptions(s,Jt).then((t=>this.handLandmarker_=t)).catch((t=>{t instanceof Event&&"error"==t.type&&i("Failed to fetch vision_wasm_internal.js in specified wasm directory"),t instanceof TypeError&&i("Failed to fetch hand_landmark.task file"),i(t)})),e(!0)}))))}))}precache(t){t("Pre-caching landmarks..."),this.update()}found(){return null!=this.handLandmarker_}update(){this.lastVideoTime!=de.video.currentTime&&(this.lastVideoTime=de.video.currentTime,this.results_=this.handLandmarker.detectForVideo(de.video,performance.now()))}get results(){return Qt(null!=this.results_),this.results_}get handLandmarker(){return Qt(null!=this.handLandmarker_),this.handLandmarker_}landmarksFound(t=0){return null!=this.results&&t<this.results.landmarks.length}landmarkFound(t,e=0){if(!this.landmarksFound(e))return!1;const i=this.results.landmarks[e][t];return i.x>=0&&i.x<=1&&i.y>=0&&i.y<=1}getLandmarkPosition(t,e=0){if(!this.landmarksFound(e))return;const i=this.results.landmarks[e][t],s=ie(new r(i.x,i.y));return new r(window.innerWidth-s.x,s.y)}forEachLandmarkPosition(t,e=0){for(let i=0;i<21;++i){const s=this.getLandmarkPosition(i,e);void 0!==s&&t(s)}}};var fe=function(t,e,i,s){return new(i||(i=Promise))((function(n,a){function o(t){try{h(s.next(t))}catch(t){a(t)}}function r(t){try{h(s.throw(t))}catch(t){a(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,r)}h((s=s.apply(t,e||[])).next())}))};let me;function ve(t,e){null!=t&&(t.setVisible(e),e?t.setInteractive():t.disableInteractive())}class ye extends f{constructor(t,e,i,s,n){super(t.matter.world,0,0,e,void 0,{render:{visible:!0}}),this.name=i,this.landmarkIndex=s,this.scene.add.existing(this),this.setScale(n),this.setTint(Q[this.name]),this.setDepth(100),this.setCircle(this.displayWidth/2,{label:this.name}),this.setSensor(!0),ve(this,!1)}}var be,we;!function(t){t[t.hover=0]="hover",t[t.pinch=1]="pinch"}(be||(be={})),function(t){t[t.start=0]="start",t[t.continue=1]="continue",t[t.end=2]="end"}(we||(we={}));class xe extends d{getFinger(t){const e=this.fingers.findIndex((e=>e.name==t));if(-1!==e)return this.fingers[e]}getFingersOtherThan(t){const e=[];for(const i of this.fingers)i.name!=t&&e.push(i);return e}get observers(){return this.observers_}isObserver(t){return void 0!==this.observers_.find((e=>e.fingerName===t.fingerName&&e.object==t.object))}wasObserverHovering(t){return Qt(this.isObserver(t)),this.observers_.find((e=>e.fingerName===t.fingerName&&e.object==t.object)).wasHovering}setObserverHover(t,e){const i=this.observers_.findIndex((e=>e.fingerName===t.fingerName&&e.object==t.object));Qt(-1!==i,"Cannot set observer hover before observer is pushed"),this.observers_[i].wasHovering=e}pushNewObserversOnly(t){this.isObserver(t)||(this.observers.push(t),this.setObserverHover(t,!1))}removeObserver(t){const e=this.observers_.findIndex((e=>e.fingerName===t.fingerName&&e.object==t.object));e>-1&&this.observers_.splice(e,1)}constructor(t){super(t,"hand"),this.fingers=[],this.observers_=[],this.fingers=[],this.observers_=[];const e=(t,e)=>{const i=new ye(this.scene,w,t,e,.3*ae.fingerSize);return this.fingers.push(i),i},i=e(et,4),s=(e(it,8),e("middle",12),e("ring",16),e("pinky",20),(t,e)=>{t((t=>{const s=this.getFinger(t.bodyB.label);if(void 0!==s)for(const t of this.observers)t.fingerName==s.name&&null!=t.object&&t.object.input&&t.object.input.enabled&&t.object.emit(s.name+be.pinch+e);else if(t.bodyB.gameObject){const s=t.bodyB.gameObject;for(const n of this.fingers){if(n==i)continue;const a={object:s,fingerName:n.name};if(!this.isObserver(a))continue;const o=this.scene.matter.overlap(t.bodyB,[n]);if(e===we.start&&o)s.emit(n.name+be.hover+we.start),this.setObserverHover(a,!0);else if(e===we.continue){const t=this.wasObserverHovering(a);o&&t?(s.emit(n.name+be.hover+we.continue),this.setObserverHover(a,!0)):o&&!t?(s.emit(n.name+be.hover+we.start),this.setObserverHover(a,!0)):!o&&t&&(s.emit(n.name+be.hover+we.end),this.setObserverHover(a,!1))}else e===we.end&&this.wasObserverHovering(a)&&(s.emit(n.name+be.hover+we.end),this.setObserverHover(a,!1))}}}))});s(i.setOnCollide.bind(i),we.start),s(i.setOnCollideActive.bind(i),we.continue),s(i.setOnCollideEnd.bind(i),we.end)}setFingerScale(t){for(const e of this.fingers)e.setScale(.3*t)}addPinchCheck(t,e,i){this.pushNewObserversOnly({object:e,fingerName:t});const s=t=>{const i=this.getFinger(et),s=this.getFinger(t);if(void 0===i)return!1;if(void 0===s)return!1;const n=this.scene.matter.overlap(e,[i]),a=this.scene.matter.overlap(e,[s]);return n&&a},n=t=>{const e=this.getFingersOtherThan(t),i=this.getFinger(et);if(void 0===i)return!1;for(const t of e)if(t!=i&&void 0!==t&&this.scene.matter.overlap(i,[t]))return!0;return!1};null!=i.startPinch&&e.on(t+be.pinch+we.start,(()=>{var e;s(t)&&(!ae.singlePinchRequirement||ae.singlePinchRequirement&&!n(t))&&(null===(e=i.startPinch)||void 0===e||e.call(i))})),null!=i.pinched&&e.on(t+be.pinch+we.continue,(()=>{var e;s(t)&&(!ae.singlePinchRequirement||ae.singlePinchRequirement&&!n(t))&&(null===(e=i.pinched)||void 0===e||e.call(i))})),null!=i.endPinch&&e.on(t+be.pinch+we.end,(()=>{var e;s(t)&&(!ae.singlePinchRequirement||ae.singlePinchRequirement&&!n(t))&&(null===(e=i.endPinch)||void 0===e||e.call(i))})),null!=i.startHover&&e.on(t+be.hover+we.start,(()=>{var t;null===(t=i.startHover)||void 0===t||t.call(i)})),null!=i.hovering&&e.on(t+be.hover+we.continue,(()=>{var t;null===(t=i.hovering)||void 0===t||t.call(i)})),null!=i.endHover&&e.on(t+be.hover+we.end,(()=>{var t;null===(t=i.endHover)||void 0===t||t.call(i)}))}removePinchCheck(t,e){this.removeObserver({fingerName:t,object:e}),e.off(t+be.pinch+we.start),e.off(t+be.pinch+we.continue),e.off(t+be.pinch+we.end),e.off(t+be.hover+we.start),e.off(t+be.hover+we.continue),e.off(t+be.hover+we.end)}update(){this.observers_=this.observers_.filter((t=>null!=t)),pe.update();const t=this.scene.matter.add.circle(this.scene.input.mousePointer.x,this.scene.input.mousePointer.y,1,{circleRadius:1,isSensor:!0,render:{visible:!1}});for(const e of this.fingers){const i=pe.getLandmarkPosition(e.landmarkIndex),s=void 0!==i;if(s&&e.setPosition(i.x,i.y),ve(e,s),!s&&null!=t)for(const i of this.observers)null!=t&&null!=i.object&&i.object.active&&null!=this.scene&&(i.object.emit(e.name+be.pinch+we.end),this.scene.matter.overlap(t,[i.object])||i.object.emit(e.name+be.hover+we.end))}this.scene.matter.world.remove(t)}calculateHandDistance(t=0){const e=pe.getLandmarkPosition(5,t),i=pe.getLandmarkPosition(17,t),s=pe.getLandmarkPosition(0,t);let n=0,a=0;const o=innerWidth*innerHeight;if(void 0!==e&&void 0!==i){const t=new r((e.x+i.x)/2,(e.y+i.y)/2);n=Math.sqrt(Math.pow((i.x-e.x)/o,2)+Math.pow((i.y-e.y)/o,2)),void 0!==s&&(a=Math.sqrt(Math.pow((s.x-t.x)/o,2)+Math.pow((s.y-t.y)/o,2)))}return 0==n||0==a?0:8.2*.7/Math.max(n/8.2,a/10)/o*100}}const Te=new Set([[0,1],[0,5],[9,13],[13,17],[5,9],[0,17],[1,2],[2,3],[3,4],[5,6],[6,7],[7,8],[9,10],[10,11],[11,12],[13,14],[14,15],[15,16],[17,18],[18,19],[19,20]]);class ke extends p{constructor(t){super(t),this.bg=document.getElementById("background_image")}preload(){}create(t=ae.enableCameraVisibility,e=ae.cameraOpacity){de.setVisibility(t),me.setVisible(!1),document.getElementById("background_image"),this.bg.style.backgroundSize="cover",this.bg.style.opacity="1",this.clearBackgroundTint(),this.setOpacity(e),this.sound.pauseOnBlur=!1,this.graphics=this.add.graphics(),this.graphics.setDepth(99),this.hand=new xe(this)}update(t,e){this.graphics.clear(),this.hand.update(),function(t,e,i=0){t.setDepth(99),pe.forEachLandmarkPosition((i=>{t.lineStyle(e.lineWidth,e.color,e.alpha),t.strokeCircle(i.x,i.y,e.radius)}),i)}(this.graphics,tt,0),function(t,e,i=0){t.setDepth(98),Te.forEach((s=>{const n=pe.getLandmarkPosition(s[0],i);if(void 0!==n){const a=pe.getLandmarkPosition(s[1],i);void 0!==a&&(t.lineStyle(e.lineWidth,e.color,e.alpha),t.lineBetween(n.x,n.y,a.x,a.y))}}))}(this.graphics,Y,0),me.setDisplaySize(document.body.clientWidth,document.body.clientHeight+1)}setOpacity(t){if(null==t)return;Qt(t>=0&&t<=1);const e=1-t;me.setAlpha(e),this.bg.style.opacity=e.toString()}setBackgroundTexture(t){me.setTexture(t),this.bg.style.backgroundSize="0 0",me.setVisible(!0)}setBackgroundTint(t){me.setTint(t)}clearBackgroundTint(){me.clearTint()}}class Se extends f{constructor(t,e,i,s,n,a){super(t.matter.world,e.x,e.y,s,void 0,{render:{visible:!0},label:"button-"+s}),this.scene=t,this.scene.add.existing(this),this.sound=this.scene.sound.add(n,{volume:ae.sonificationLevel}),this.setSensor(!0),this.setOrigin(.5,.5),this.setScale(i.x,i.y),this.setDepth(93),ve(this,a),this.on("destroy",(()=>{this.scene.hand.removePinchCheck(st,this)}))}removePinchCallbacks(){this.scene.hand.removePinchCheck(st,this)}addPinchCallbacks(t){const e={startPinch:()=>{var e;null===(e=t.startPinch)||void 0===e||e.call(t),this.sound.play({volume:ae.sonificationLevel})},pinched:t.pinched,endPinch:t.endPinch,startHover:t.startHover,endHover:t.endHover};this.scene.hand.addPinchCheck(st,this,e),this.on("pointerdown",e.startPinch),e.startHover&&this.on("pointermove",e.startHover),e.endHover&&this.on("pointerout",e.endHover)}}class Pe{constructor(t){this.trackKey=Ut,this.bpm=0,this.beatLength_=1,this.trackKey=t}get beatLength(){return this.beatLength_}setBPM(t){Qt(null!=this.data,"preload JSON before setting BPM"),Qt(t<this.data.bpm.length,"BPM index out of range"),this.bpm=this.data.bpm[t];const e=16/this.data.timeSignatureDenominator;this.beatLength_=this.songTimePositionToTime({bar:1,step:1+e,tick:0})}getBPM(){return Qt(null!=this.data,"preload JSON before retrieving BPM"),Qt(0!=this.bpm,"Track BPM has not been set"),this.bpm}preload(t){this.preloadJson(t)}unload(t){this.unloadJson(t)}preloadNotes(t){Qt(null!=this.trackDir,"Preload track before preloading notes"),this.forEachLayer(void 0,(e=>{e.nodes.forEach(((i,s)=>{const n=this.getSoundKey(e,i.soundKey),a=this.trackDir+e.id+"/"+i.soundKey+y;t.cache.audio.exists(n)||""===i.soundKey||t.load.audio(n,te(a))}))}))}unloadNotes(t){this.forEachLayer(void 0,(e=>{e.nodes.forEach(((i,s)=>{t.cache.audio.remove(this.getSoundKey(e,i.soundKey))}))}))}preloadLoops(t){this.forEachLayer((e=>{Qt(void 0!==e.soundLoopKeys),Qt(e.soundLoopKeys.length>0),e.soundLoopKeys.forEach((i=>{const s=this.getSoundKey(e,i),n=this.trackDir+e.id+"/"+i+y;t.cache.audio.exists(s)||""===i||t.load.audio(s,te(n))}))}))}unloadLoops(t){this.forEachLayer((e=>{e.soundLoopKeys.forEach((i=>{t.cache.audio.remove(this.getSoundKey(e,i))}))}))}getSoundKey(t,e){return Qt(void 0!==e),this.trackKey+"/"+t.id+"/"+e}forEachLayer(t,e){Qt(null!=this.data,"JSON has not finished preloading");let i=0;this.data.layers.forEach(((s,n)=>{s.playable||i++,null==t||t(s,n),s.playable&&(null==e||e(s,n-i))}))}addBackgroundAudioTracks(t,e,i,s){const n=[];return this.forEachLayer(((a,o)=>{(null==s||s(a,o))&&(Qt(void 0!==a.soundLoopKeys),Qt(i<a.soundLoopKeys.length,"BPM index out of range of layer sound loop keys"),n.push(t.sound.add(this.getSoundKey(a,a.soundLoopKeys[i]),e)))})),n}timeToSongTimePosition(t){Qt(0!=this.bpm,"set BPM before retrieving song times");const e=t/(6e4/this.bpm),i=Math.floor(e/this.data.timeSignatureNumerator)+1,s=e%this.data.timeSignatureNumerator,n=4*s%1;return{bar:i,step:Math.floor(s*(4/this.data.timeSignatureDenominator)*4)+1,tick:Math.floor(n*(this.data.timeBasePPQ/4))}}songTimePositionToTime(t){return Qt(0!=this.bpm,"set BPM before retrieving song times"),((t.bar-1)*this.data.timeSignatureNumerator+(t.step-1)/(4/this.data.timeSignatureDenominator*4)+t.tick/this.data.timeBasePPQ)*(6e4/this.bpm)}preloadJson(t){const e=m+this.trackKey+"/";this.trackDir=e;const i=(e,i,s)=>{this.data=s,this.parseJson(),this.preloadLoops(t)};t.cache.json.exists(this.trackKey)?i(0,0,t.cache.json.get(this.trackKey)):(t.load.json(this.trackKey,te(e+"info.json")),t.load.on("filecomplete-json-"+this.trackKey,i,this))}unloadJson(t){this.unloadLoops(t),t.cache.json.remove(this.trackKey)}parseJson(){this.setTimePositionDefaults(),this.sortNodes()}setTimePositionDefaults(){this.forEachLayer(void 0,(t=>{const e=(t,e,i,s)=>{t.bar||(t.bar=e),t.step||(t.step=i),t.tick||(t.tick=s)};Qt(t.progressCount<=t.nodes.length,"Progress count threshold for layer '"+t.id+"' of track '"+this.trackKey+"' cannot be higher than the node count."),e(t.previewTime,0,0,0),t.nodes.forEach((t=>{e(t.timePosition,1,1,0)}))}))}sortNodes(){this.forEachLayer(void 0,(t=>{t.nodes.sort(((t,e)=>t.timePosition.bar!==e.timePosition.bar?t.timePosition.bar-e.timePosition.bar:t.timePosition.step!==e.timePosition.step?t.timePosition.step-e.timePosition.step:t.timePosition.tick-e.timePosition.tick))}))}}class Le extends f{static preload(t){t.load.image(ot,te(ht)),t.load.image(rt,te("assets/sprites/defaultTargetOuter.png"))}static unload(t){t.textures.remove(ot),t.textures.remove(rt)}constructor(t,e,i,s,n,a,o,r){super(t.matter.world,i.x,i.y,a.data.spriteKeyInner,void 0,{render:{visible:!0}}),this.scene=t,this.lifetime=s,this.fingerId=o,this.nodeIndex=r,this.spriteScale=ae.targetSize,this.scene.add.existing(this),this.songTime=this.lifetime+e,this.lateDuration=ae.lateTimeDuration,this.onTimeDuration=ae.onTimeDuration,this.earlyDuration=this.lifetime-this.onTimeDuration/2,this.sound=this.scene.sound.add(n,{volume:ae.sonificationLevel}),this.setScale(this.spriteScale),this.setTint(Q[this.fingerId]),this.setDepth(95),ve(this,!0),this.setCircle(this.displayWidth/2,{label:a.level.trackKey+"-"+a.data.id+"-node-"+r.toString()}),this.setSensor(!0),ae.fancyEffectsDisabled||(this.glow=this.postFX.addGlow(16777215,0,0,!1,.05,24)),this.outerRing=this.scene.add.sprite(i.x,i.y,a.data.spriteKeyOuter),this.outerRing.setScale(.5*this.spriteScale),this.outerRing.setDepth(96),this.targetText=new g(this.scene,0,0,Ut,{}),this.addTargetText(),this.setupTweens()}setOnTargetMiss(t){this.onTargetMiss=t}setOnTargetHit(t){this.scene.hand.addPinchCheck(this.fingerId,this,{startPinch:t}),this.once("pointerdown",t)}addTargetText(){this.targetText=this.scene.add.text(this.x,this.y,(this.nodeIndex+1).toString(),{font:"20px Arial",color:"white"}),this.targetText.setOrigin(.5,.5),this.targetText.setDepth(97)}createTween(t,e,i){for(const i of t)i.tint=e.color;return this.scene.tweens.add({targets:t,displayWidth:this.displayWidth*e.scale,displayHeight:this.displayHeight*e.scale,ease:e.ease,duration:i,repeat:0})}setupTweens(){ae.fancyEffectsDisabled||(this.rotateTween=this.scene.tweens.add({targets:[this],rotation:2*Math.PI,ease:"linear",duration:1e3,repeat:-1})),this.earlyTween=this.createTween([this.outerRing],lt,this.earlyDuration),this.earlyTween.on("complete",(()=>{this.onTimeTween=this.createTween([this],Object.assign(Object.assign({},ct),{scale:1}),this.onTimeDuration),ae.fancyEffectsDisabled||null==this.glow||(this.glowTween=this.scene.tweens.add({targets:this.glow,outerStrength:4,yoyo:!0,duration:this.onTimeDuration/2,ease:"linear"})),this.onTimeTween.on("complete",(()=>{null!=this.glow&&this.glow.destroy(),this.lateTween=this.createTween([this,this.outerRing],Object.assign(Object.assign({},dt),{scale:1}),this.lateDuration),this.lateTween.on("complete",(()=>{ve(this,!1),this.deathTween=this.createTween([this,this.outerRing,this.targetText],ut,400),null!=this.onTargetMiss&&this.deathTween.on("complete",this.onTargetMiss)}))}))}))}destroyTarget(){this.scene.hand.removePinchCheck(this.fingerId,this),this.off("pointerdown"),null!=this.rotateTween&&this.scene.tweens.remove(this.rotateTween),null!=this.earlyTween&&this.scene.tweens.remove(this.earlyTween),null!=this.onTimeTween&&this.scene.tweens.remove(this.onTimeTween),null!=this.lateTween&&this.scene.tweens.remove(this.lateTween),null!=this.deathTween&&this.scene.tweens.remove(this.deathTween),null!=this.glowTween&&this.scene.tweens.remove(this.glowTween),null!=this.glow&&this.glow.destroy(),null!=this.targetText&&this.targetText.destroy(),this.outerRing.destroy(),this.destroy()}}class Ce extends d{constructor(t){super(t,"metronome"),this.beat=0,this.timer=new c({}),this.countdownText=this.scene.add.text(xt.position.x,xt.position.y,Ut,{font:xt.font,color:xt.color}).setOrigin(.5,.5).setScale(xt.scale).setDepth(xt.depth),this.setVisible(!1)}preload(){this.scene.load.image(wt,te("assets/sprites/countdown.png")),this.scene.load.audio(bt.highKey,te(bt.highPath)),this.scene.load.audio(bt.lowKey,te(bt.lowPath))}unload(){this.scene.cache.audio.remove(bt.highKey),this.scene.cache.audio.remove(bt.lowKey)}setup(){this.countdownTexture=this.scene.add.sprite(xt.position.x,xt.position.y,wt).setScale(1).setVisible(!1).setOrigin(.5,.5).setAlpha(.3).setDepth(30)}setVisible(t){null!=this.countdownText&&this.countdownText.setVisible(t),null!=this.countdownTexture&&this.countdownTexture.setVisible(t)}stop(){this.setVisible(!1),null!=this.scene&&(this.scene.time.removeEvent(this.timer),this.scene.sound.stopByKey(bt.highKey),this.scene.sound.stopByKey(bt.lowKey),null!=this.shrinkTween&&this.scene.tweens.remove(this.shrinkTween))}play(t,e,i){this.beat=0,this.stop(),this.timer=this.scene.time.addEvent({callback:this.tick.bind(this,t,e,i),delay:e,loop:!0,startAt:e})}tick(t,e,i){Qt(i>=1,"Cannot display metronome for less than minimum bar count");const s=t*i,n=this.beat%t,a=0==n?bt.highKey:bt.lowKey;this.beat>=s?this.setVisible(!1):(this.countdownText.active&&this.scene.sound.play(a,{volume:ae.backgroundMusicLevel}),Qt(s-t>=0),this.beat>=s-t&&this.countdownText.active&&!ae.disableVisualMetronome&&this.display(n+1,e),this.beat++)}display(t,e){this.countdownText.setText(t.toString()),this.countdownText.setScale(xt.scale),this.countdownTexture.setScale(1),this.setVisible(!0),this.shrinkTween=this.scene.tweens.add({targets:[this.countdownText,this.countdownTexture],ease:xt.ease,duration:.9*e,scale:0,repeat:0})}}class Be extends h{constructor(t){super(t),this.current_=0,this.requiredProgress=-1,this.nodeCount=1,this.tints=[],Qt(this.current_>=0),this.tints=[],this.scene.add.existing(this),this.setVisible(!1)}preload(){this.scene.load.image(yt.key,te(yt.path))}setup(t,e,i,s){Qt(i<=e),Qt(s.length===e,"Must pass tints equal in number to nodes"),Qt(e>0),Qt(i>0),Qt(t>=0),this.current_=t,this.nodeCount=e,this.tints=s,this.requiredProgress=i;const n=yt.size.x/this.nodeCount;this.clear(),this.createMultiple({quantity:this.nodeCount,key:yt.key,visible:!0,setXY:{x:yt.position.x-yt.size.x/2+n/2,y:yt.position.y+yt.size.y/2,stepX:n}}),this.propertyValueSet("displayWidth",n),this.propertyValueSet("displayHeight",yt.size.y),this.setDepth(61),this.redraw()}setToStarting(){this.current_=0,Qt(this.current_>=0),this.redraw()}redraw(){if(this.current<=this.nodeCount){this.getChildren().forEach(((t,e)=>{t.clearTint()}));const t=-1===this.requiredProgress?this.nodeCount:this.requiredProgress-1,e=this.current;this.getChildren().forEach(((i,s)=>{const n=i;yt.tintByNode&&n.setTint(this.tints[s]),s<e&&(s<=t?n.setTint(yt.completedTint):n.setTint(yt.extraTint)),s===t&&(e>t?n.setTint(yt.completedRequiredTint):n.setTint(yt.requiredTint))}),this)}}canProgress(){const t=-1===this.requiredProgress;return t&&this.current>=this.nodeCount||!t&&this.current>=this.requiredProgress}changeBy(t){this.current_=Math.max(0,Math.min(this.current+t,this.nodeCount))}get current(){return this.current_}}class De extends d{constructor(t,e){super(t,"infoHUD"),this.scene=t,this.level=e}setup(){this.addTexts(),this.addSkipButton(),this.setVisible(!1)}addSkipButton(){this.skipButton=new Se(this.scene,kt.position,kt.scale,kt.textureKey,kt.soundKey,!1),this.skipButton.addPinchCallbacks({startPinch:()=>{ve(this.skipButton,!1),this.level.transitionLayers()},startHover:()=>{this.skipButton.setTintFill(nt)},endHover:()=>{this.skipButton.clearTint()}}),this.updateSkipButtonAvailability(!1)}preload(){this.scene.load.image(kt.textureKey,te(kt.path)),this.scene.load.image(Tt.textureKey,te(Tt.path))}setVisible(t){null!=this.trackText&&this.trackText.setVisible(t),null!=this.difficultyText&&this.difficultyText.setVisible(t),null!=this.bpmText&&this.bpmText.setVisible(t),null!=this.layerText&&this.layerText.setVisible(t),null!=this.loopText&&this.loopText.setVisible(t),null!=this.infoBackground&&this.infoBackground.setVisible(t),this.updateSkipButtonAvailability(t)}addText(t,e){return this.scene.add.text(t.position.x,t.position.y,e,{font:t.font,color:t.color}).setScale(t.scale).setDepth(t.depth)}getLoopText(){return"Loop: "+this.level.score.getLoopCount().toString()}addTexts(){this.loopText=this.addText(Bt,this.getLoopText());const t="Track: "+this.level.track.data.displayName;this.trackText=this.addText(St,t);const e="Layer: "+(this.level.activeLayerIndex+1).toString()+"/"+this.level.playableLayers.length.toString();let i=Ut;switch(this.level.bpmIndex){case 0:i="Easy";break;case 1:i="Medium";break;case 2:i="Hard"}Qt(i!=Ut,"Extend the switch statement to have a difficulty text for the given track bpmIndex"),this.difficultyText=this.addText(Pt,"Difficulty: "+i),this.bpmText=this.addText(Lt,"BPM: "+this.level.track.getBPM()),this.layerText=this.addText(Ct,e),this.infoBackground=this.scene.add.sprite(Tt.position.x,Tt.position.y,Tt.textureKey).setAlpha(Tt.opacity).setOrigin(0,0).setDisplaySize(Tt.size.x,Tt.size.y)}updateLoopText(){this.loopText.setText(this.getLoopText()),this.updateSkipButtonAvailability(!0)}updateSkipButtonAvailability(t){const e=ae.enableSkipButton&&this.level.score.getLoopCount()>=ae.skipLoopThreshold&&t;null!=this.skipButton&&ve(this.skipButton,e)}}class Oe{constructor(){this.targets=[]}start(){this.destroyTargets()}destroyTarget(t){t.destroyTarget();const e=this.targets.indexOf(t,0);e>-1&&this.targets.splice(e,1)}destroyTargets(){const t=[...this.targets];for(const e of t)this.destroyTarget(e)}addTarget(t){this.targets.push(t)}getPreviousTargets(t){return this.targets.filter((e=>e.songTime<t.songTime))}}class Ie{constructor(t,e){this.level=t,this.data=e}getDuration(){return this.level.track.songTimePositionToTime({bar:this.data.lengthInBars+1,step:1,tick:0})}}class _e extends Ie{constructor(t,e,i){super(e,i),this.nextNodeIndex=0,this.songTime_=0,this.oldTimePosition=0,this.startTime=0,this.time=0,this.ready=!1,this.scene=t,this.data=i,this.metronome=new Ce(this.scene),this.progress=new Be(this.scene),this.infoHud=new De(this.scene,this.level),this.targetManager=new Oe}get songTime(){return this.songTime_}preload(){this.infoHud.preload(),this.metronome.preload(),this.progress.preload()}unload(){this.metronome.unload(),this.infoHud.destroy()}start(t){this.targetManager.start(),this.level.score.delay=t,this.ready=!0,this.startTime=this.time+t,this.nextNodeIndex=0,this.oldTimePosition=0;const e=Math.max(this.data.previewTime.bar,1),i=[];this.data.nodes.forEach(((t,e)=>{const s=ae.indexFingerOnly?it:t.finger;i.push(Q[s])})),this.progress.setup(0,this.data.nodes.length,this.data.progressCount,i),this.metronome.setup(),this.infoHud.setup(),this.progress.setVisible(!0),this.infoHud.setVisible(!0),this.metronome.play(this.level.track.data.timeSignatureNumerator,this.level.track.beatLength,e)}createTarget(t,e,i){const s=ae.indexFingerOnly?it:t.finger,n=new Le(this.scene,this.songTime_,ie(t.normalizedPosition),this.getPreviewTime(),this.level.track.getSoundKey(this.data,t.soundKey),this,s,i);n.setOnTargetMiss((()=>{this.level.score.missedPinch(n),this.progress.changeBy(-1),this.progress.redraw(),this.level.streak.stop(),this.targetManager.destroyTarget(n),this.checkForTransition(e,i)})),n.setOnTargetHit((()=>{const t=this.targetManager.getPreviousTargets(n);for(const i of t)Qt(i!=n),this.progress.changeBy(-1),this.level.score.skippedPinch(i),this.checkForTransition(e,i.nodeIndex),this.targetManager.destroyTarget(i);t.length>0&&this.level.streak.stop();const s=this.songTime-n.songTime,a=n.onTimeDuration/2,o=s>a;s<-a?(this.level.streak.stop(),this.progress.changeBy(0),this.level.score.earlyPinch(n,this.songTime)):o?(this.level.streak.stop(),this.progress.changeBy(0),this.level.score.latePinch(n,this.songTime)):(this.level.streak.changeBy(1),this.progress.changeBy(1),this.level.score.onTimePinch(n,this.songTime,this.level.streak.current)),this.progress.redraw(),this.level.streak.check(),ae.disableSonification||n.sound.play({volume:ae.sonificationLevel}),this.targetManager.destroyTarget(n),this.checkForTransition(e,i)})),this.targetManager.addTarget(n)}checkForTransition(t,e){e==this.data.nodes.length-1&&this.level.activeLayerIndex==t&&(ae.enableAutoSkip&&this.level.score.getLoopCount()>=ae.autoSkipThreshold||this.progress.canProgress()&&!ae.disableLayerProgression?this.level.transitionLayers():(this.level.score.incrementLoopCount(),this.progress.setToStarting(),this.infoHud.updateLoopText(),ae.autoSaveCSV&&le(this.level.score.levelStats)))}handleTargetCreation(){if(!this.ready)return;const t=this.getDuration();let e=this.songTime_+this.getPreviewTime();if(this.songTime_>0&&(e%=t),this.data.nodes.length<=this.nextNodeIndex){if(!(e<this.oldTimePosition))return;this.nextNodeIndex=0}const i=this.data.nodes[this.nextNodeIndex];this.level.track.songTimePositionToTime(i.timePosition)%t<=e&&(void 0!==i.finger&&this.createTarget(i,this.level.activeLayerIndex,this.nextNodeIndex),this.nextNodeIndex++),this.oldTimePosition=e}preDelayStop(){this.ready=!1,this.metronome.stop(),this.targetManager.destroyTargets()}postDelayStop(){this.infoHud.setVisible(!1),this.progress.setVisible(!1)}stop(){this.preDelayStop(),this.postDelayStop()}update(t){this.time=t,this.songTime_=this.ready?this.time-this.startTime:0,this.handleTargetCreation()}getPreviewTime(){return this.level.track.songTimePositionToTime({bar:this.data.previewTime.bar+1,step:this.data.previewTime.step+1,tick:this.data.previewTime.tick})}}class He extends d{constructor(t){super(t,"streak"),this.current_=0,this.onFire=!1,this.hsv=Phaser.Display.Color.HSVColorWheel(),this.streakText=this.scene.add.text(ft.position.x,ft.position.y,Ut,{font:ft.font,color:ft.color}).setVisible(!1).setOrigin(.5,.5).setScale(ft.scale).setDepth(ft.depth).setStroke(ft.color,ft.strokeThickness).setShadow(ft.shadowOffset.x,ft.shadowOffset.y,ft.shadowColor,ft.shadowBlurRadius,!0,!0)}preload(){this.scene.load.image(vt,te("assets/sprites/flare.png"))}unload(){this.scene.textures.remove(vt)}get current(){return this.current_}changeBy(t){this.current_=Math.max(0,this.current+t)}check(){1===this.current_?this.start():this.current_>1?this.continue():this.stop()}updateStreakText(){this.streakText.setText("Streak: "+this.current_.toString())}start(){this.updateStreakText(),this.streakText.setVisible(!0)}stop(){this.current_=0,this.onFire=!1,null!=this.onFireTween&&this.scene.tweens.remove(this.onFireTween),null!=this.streakText&&this.streakText.clearTint(),null!=this.streakText&&this.streakText.setVisible(!1),null!=this.flame&&this.flame.destroy()}continue(){this.updateStreakText();const t=this.onFire;this.onFire=this.current_>=2,!t&&this.onFire&&(Qt(!0,"Streak color wheel extent must be from 1 to 255"),this.onFireTween=this.scene.tweens.addCounter({from:0,to:30,duration:1e3,yoyo:!0,onUpdate:t=>{if(null!=this&&null!=this.hsv){const e=Math.floor(t.getValue()),i=this.hsv[e].color,s=this.hsv[30-e].color;null!=this.streakText&&this.streakText.setTint(i,i,s,s)}},onStop:()=>{null!=this.onFireTween&&this.scene.tweens.remove(this.onFireTween)}}),ae.fancyEffectsDisabled||(null!=this.flame&&this.flame.destroy(),null!=this.streakText&&(this.flame=this.scene.add.particles(this.streakText.x,this.streakText.y,vt,mt),Qt(0!=ft.depth),this.flame.setDepth(ft.depth-1))))}}class Me{constructor(){this.total=1,this.required=1,this.correct=0,this.early=0,this.late=0,this.miss=0,this.loop=1,this.hits=[]}}class Ve{constructor(t){this.maxStreak=0,this.layersStats=[],this.id=`${t.data.displayName.replace(/\s/g,"")}@${t.getBPM()}bpm_${(new Date).toLocaleString("en-GB").replace(/\s/g,"").replace(/,/g,"_").replace(/[:/]/g,"-")}`}}class Ae{constructor(t){this.levelStats=new Ve(t),this.layerStats=new Me}getLoopCount(){return this.layerStats.loop}incrementLoopCount(){this.layerStats.correct=0,this.layerStats.early=0,this.layerStats.late=0,this.layerStats.miss=0,this.layerStats.loop++}saveLayerScores(){this.levelStats.layersStats.push(this.layerStats)}resetLayerScores(t,e){this.layerStats=new Me,this.layerStats.total=t,this.layerStats.required=e}addHit(t,e,i){this.layerStats.hits.push({loopNumber:this.getLoopCount(),noteID:t.nodeIndex+1,correctTime:t.songTime+this.delay,playerTime:e,classification:i})}onTimePinch(t,e,i){this.addHit(t,e+this.delay,"correct"),this.layerStats.correct++,this.levelStats.maxStreak=Math.max(i,this.levelStats.maxStreak)}earlyPinch(t,e){this.addHit(t,e+this.delay,"early"),this.layerStats.early++}latePinch(t,e){this.addHit(t,e+this.delay,"late"),this.layerStats.late++}skippedPinch(t){this.addHit(t,-1e3,"skipped"),this.layerStats.miss++}missedPinch(t){this.addHit(t,-1e3,"missed"),this.layerStats.miss++}}class Ee{constructor(t){this.trackKey_=Ut,this.finishCallback=()=>{},this.abortCallback=()=>{},this.activeLayerIndex=0,this.playableLayers=[],this.activeAudioTracks=[],this.bpmIndex_=-1,this.trackKey_=t,this.track=new Pe(this.trackKey_)}setBPM(t){Qt(-1!=t,"BPM must be set before starting the level"),this.track.setBPM(t),this.bpmIndex_=t}get bpmIndex(){return this.bpmIndex_}get trackKey(){return this.trackKey_}init(t){this.scene=t,this.streak=new He(this.scene),this.score=new Ae(this.track),this.preloadLayers()}hasCustomBackground(){return ee(m+this.getBackgroundTextureKey())}hasPreviewVideo(){return ee(m+this.getPreviewVideoKey())}getBackgroundTextureKey(){return this.trackKey+"/background.png"}getPreviewVideoKey(){return this.trackKey+"/preview.mp4"}preloadTrack(t){const e=m+this.getPreviewVideoKey(),i=m+this.getBackgroundTextureKey();ee(e)&&t.load.video(this.getPreviewVideoKey(),te(e),!0),ee(i)&&t.load.image(this.getBackgroundTextureKey(),te(i)),this.track.preload(t)}unloadTrack(t){this.track.unload(t)}preloadLayers(){this.track.preloadNotes(this.scene),Le.preload(this.scene),this.streak.preload(),this.playableLayers=[],this.track.forEachLayer(void 0,((t,e)=>{const i=new _e(this.scene,this,t);i.preload(),this.playableLayers.push(i)}))}unloadLayers(){this.playableLayers.forEach((t=>{t.unload()})),this.track.unloadNotes(this.scene),Le.unload(this.scene),this.streak.unload()}start(t,e){this.activeLayerIndex=0,this.removeBackgroundAudio(this.scene),this.playableLayers.forEach((t=>{t.stop()})),this.streak.stop(),this.setBPM(this.bpmIndex_),this.finishCallback=t,this.abortCallback=e,this.scene.time.delayedCall(1e3,(()=>{this.startLayer()}))}addBackgroundAudio(t,e,i){Qt(-1!=this.bpmIndex_,"Set BPM before adding background audio to level"),this.removeBackgroundAudio(t),this.activeAudioTracks=this.track.addBackgroundAudioTracks(t,e,this.bpmIndex_,i)}removeBackgroundAudio(t){this.activeAudioTracks.forEach((e=>{e.stop(),t.sound.remove(e)})),this.activeAudioTracks=[]}playBackgroundAudio(){this.activeAudioTracks.forEach((t=>{t.setMute(!1),t.play()}))}setBackgroundAudioMute(t){this.activeAudioTracks.forEach((e=>{e.setMute(t)}))}startLayer(){const t=this.getActiveLayer(),e=this.activeLayerIndex;this.score.resetLayerScores(t.data.nodes.length,t.data.progressCount);const i=this.track.songTimePositionToTime({bar:2,step:1,tick:0}),s=Math.max(i,t.getPreviewTime());t.start(s);const n=[...t.data.backgroundLayers];ae.disableSonification&&n.push(t.data.id),this.addBackgroundAudio(this.scene,{loop:!0,volume:ae.backgroundMusicLevel},((t,e)=>n.includes(t.id))),this.scene.time.delayedCall(s,(()=>{this.activeLayerIndex==e&&this.playBackgroundAudio()}))}getActiveLayer(){return Qt(this.activeLayerIndex<this.playableLayers.length,"Active layer index cannot exceed number of playable layers"),this.playableLayers[this.activeLayerIndex]}transitionLayers(){if(ae.autoSaveCSV&&le(this.score.levelStats),this.activeLayerIndex<this.playableLayers.length){const t=this.getActiveLayer();t.preDelayStop(),this.removeBackgroundAudio(this.scene),this.activeLayerIndex++;const e=this.activeLayerIndex;if(this.activeLayerIndex>=this.playableLayers.length)return this.score.saveLayerScores(),t.postDelayStop(),void this.end();this.scene.time.delayedCall(1e3,(()=>{this.activeLayerIndex==e&&(this.score.saveLayerScores(),t.postDelayStop(),this.startLayer())}))}}stop(){this.removeBackgroundAudio(this.scene),this.streak.stop(),this.unloadLayers()}end(){this.stop(),this.finishCallback()}abort(){ae.autoSaveCSV&&(this.score.saveLayerScores(),le(this.score.levelStats)),this.stop(),this.abortCallback()}update(t){this.activeLayerIndex<this.playableLayers.length&&this.getActiveLayer().update(t)}getAudioLoopTime(){return this.activeAudioTracks.at(-1).duration}}class Fe extends Se{constructor(t,e,i,s,n,a,o,r=!0){super(t,e,i,s,a,o),this.onSpriteKey=s,this.offSpriteKey=n,this.toggleState=r,this.setTexture(this.getSpriteKey())}setToggleState(t){var e;this.toggleState=t,this.setTexture(this.getSpriteKey()),null===(e=this.toggleCallback)||void 0===e||e.call(this,this.toggleState)}addToggleCallback(t){this.toggleCallback=t,this.toggleCallback(this.toggleState)}toggle(){var t;this.toggleState=!this.toggleState,this.setTexture(this.getSpriteKey()),null===(t=this.toggleCallback)||void 0===t||t.call(this,this.toggleState)}getToggleState(){return this.toggleState}updateTint(){this.toggleState?this.setTintFill(at):this.clearTint()}getSpriteKey(){return this.toggleState?this.onSpriteKey:this.offSpriteKey}}class Ke extends Fe{constructor(t,e,i,s,n,a,o,r,h,l=!0){super(t,e,i,s,n,a,o,l),this.bpmTextOptions={font:"20px Courier New",color:16777215},this.bpmIndex_=r,this.bpm=h,this.bpmText=this.scene.add.text(0,0,Ut,{font:this.bpmTextOptions.font}),this.bpmText.setText("BPM: "+this.bpm.toString()),this.bpmText.setPosition(e.x-this.bpmText.displayWidth/2,e.y-this.bpmText.displayHeight/2+.023*window.innerHeight),this.updateTint(),this.on("destroy",(()=>{this.bpmText.destroy()}))}updateTint(){this.toggleState?(this.bpmText.setTintFill(at),this.setTintFill(at)):(this.bpmText.setTintFill(this.bpmTextOptions.color),this.clearTint())}get bpmIndex(){return this.bpmIndex_}}var Ne=n().Math.Vector2,je=n().Math.RoundTo;class ze extends l{constructor(t,e,i,s,n,a,o,r){super(t),this.isDragging=!1,this.range=new Ne(0,1),this.isInteger=!1,this.x=e.x,this.y=e.y,this.width=i.x,this.height=i.y,this.key=a,this.updateSliderCallback=r,this.range=o,this.value=.5,this.box=new u(0,0,i.x,i.y),this.handle=new u(0,0,i.y,i.y),this.updateHandle(),null!=s&&(this.label=this.scene.add.text(this.x+s.x,this.y+s.y,Ut,{color:"#ffffff",fontSize:"24px"})),this.setInteractive(this.box,u.Contains),this.on("pointerdown",this.startDrag,this),this.scene.input.on("pointerup",this.stopDrag,this),this.scene.input.on("pointermove",this.doDrag,this),Qt("number"==typeof n[this.key]),this.setValue(n[this.key]),this.draw()}reset(t){Qt("number"==typeof t[this.key]),this.setValue(t[this.key]),this.draw()}startDrag(){this.isDragging=!0}doDrag(t){this.isDragging&&(this.value=n().Math.Clamp((t.x-this.x-this.handle.width/2)/(this.width-this.handle.width),0,1),this.updateHandle(),this.draw())}stopDrag(){this.isDragging=!1}updateHandle(){this.handle.x=this.value*(this.width-this.handle.width)}draw(){this.clear(),null!=this.input&&(this.input.enabled||this.setInteractive(this.box,u.Contains),this.updateSliderCallback(this)),this.fillStyle(11184810),this.fillRectShape(this.box),this.fillStyle(16777215),this.fillRectShape(this.handle)}getStringValue(){const t=this.getValue();return this.isInteger?t.toFixed(0):t.toFixed(2)}getValue(){const t=this.value*(this.range.y-this.range.x)+this.range.x;return this.isInteger?je(t,0):t}setIsInteger(t){return this.isInteger=t,this.draw(),this}setValue(t){this.value=(t-this.range.x)/(this.range.y-this.range.x),this.updateHandle(),this.draw()}hide(t){return this.clear(),null!=this.input&&this.disableInteractive(),null!=this.label&&null!=this.label&&this.label.active&&(null!=t?this.label.setText(t):this.label.setText("")),this}}class Re extends l{constructor(t,e,i,s,n,a,o,r){super(t),this.labelText=Ut,this.x=e.x,this.y=e.y,this.key=o,null!=s&&(this.labelText=n,this.label=this.scene.add.text(e.x+s.x,e.y+s.y,this.labelText,{color:"#ffffff",fontSize:"24px"})),this.toggleCallback=r,Qt("boolean"==typeof a[this.key]),this.isChecked_=a[this.key],this.box=new u(0,0,i,i),this.check=new u(.25*i,.25*i,.5*i,.5*i),this.setInteractive(this.box,u.Contains),this.toggleCallback(this),this.on("pointerdown",this.toggleCheck,this),this.draw()}reset(t){Qt("boolean"==typeof t[this.key]),this.isChecked_=t[this.key],this.toggleCallback(this),this.draw()}resetLabel(){null!=this.label&&this.label.setText(this.labelText)}setLabel(t){null!=this.label&&this.label.setText(t),this.draw()}toggleCheck(){this.isChecked_=!this.isChecked_,this.toggleCallback(this),this.draw()}draw(){this.clear(),null==this.input||this.input.enabled||this.setInteractive(this.box,u.Contains),this.lineStyle(2,16777215),this.strokeRectShape(this.box),this.isChecked_&&(this.fillStyle(16777215),this.fillRectShape(this.check))}setToggled(t){"boolean"==typeof t&&(this.isChecked_=t,this.toggleCallback(this),this.draw())}hide(){return this.clear(),this.disableInteractive(),null!=this.label&&this.label.setText(""),this}get isChecked(){return this.isChecked_}}var We=function(t,e,i,s){return new(i||(i=Promise))((function(n,a){function o(t){try{h(s.next(t))}catch(t){a(t)}}function r(t){try{h(s.throw(t))}catch(t){a(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,r)}h((s=s.apply(t,e||[])).next())}))};const qe=window.innerWidth,$e=window.innerHeight,Ge=.5*qe,Je=.1*qe,Ue=.64*qe,Xe=.1*$e,Ze=.08*$e,Qe=.32*$e,Ye=.08*$e,ti=.57*$e,ei=.08*$e,ii=new r(.26*qe,.03*$e);var si=i(223),ni=i(43),ai=i(769),oi=function(t,e,i,s){return new(i||(i=Promise))((function(n,a){function o(t){try{h(s.next(t))}catch(t){a(t)}}function r(t){try{h(s.throw(t))}catch(t){a(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,r)}h((s=s.apply(t,e||[])).next())}))};let ri=null;const hi={type:n().WEBGL,scale:{mode:n().Scale.RESIZE},transparent:!0,physics:{default:"matter",matter:{debug:!1,gravity:{x:0,y:0}}},scene:[class extends p{constructor(){super("electron")}create(){return fe(this,void 0,void 0,(function*(){yield new Promise(((t,e)=>{t()})).then((()=>{this.scene.start(Ft)}))}))}},class extends p{constructor(){super(Ft)}preload(){this.load.image(w,te("assets/sprites/finger.png")),this.load.image(O,te("assets/ui/menu_background.png"))}create(){return fe(this,void 0,void 0,(function*(){me=this.add.sprite(0,0,O).setOrigin(0,0).setVisible(!1),me.displayWidth=window.innerWidth,me.displayHeight=window.innerWidth*me.height/me.width;const t=this.add.text(this.cameras.main.worldView.x+this.cameras.main.width/2,this.cameras.main.worldView.y+this.cameras.main.height/2,"",pt).setShadow(1,1).setDepth(1e3).setOrigin(.5);yield de.init($t,this.updateText.bind(this,t)).catch((e=>{this.updateText(t,e)})),de.found()&&(this.updateText(t,"Loading config data..."),yield he(Z).catch((e=>this.updateText(t,e))),yield he("data/default_config.json").then((t=>{oe=t})).catch((e=>this.updateText(t,e))),yield pe.init(this.updateText.bind(this,t)).catch((e=>this.updateText(t,e))),pe.found()&&(de.setVisibility($t.visible),yield xi().then((t=>{console.info("INFO: Week number: "+t.toString())})).catch((e=>this.updateText(t,e))),this.scene.launch(qt),pe.precache(this.updateText.bind(this,t)),this.updateText(t,"Loading game..."),this.scene.get(qt).load.on("complete",(()=>{t.destroy()}))))}))}updateText(t,e){console.info("INFO: "+e);let i=e;e instanceof DOMException&&(i="NotFoundError"==e.name?"Webcam not found":"PermissionError"==e.name?"Permission denied":"NotADirectoryError"==e.name?e.message:e.name+": "+e.message),t.setText(i)}},class extends ke{constructor(){super(jt),this.levels=[]}preload(){const t=Object.create(null,{preload:{get:()=>super.preload}});return e=this,i=void 0,n=function*(){t.preload.call(this),this.load.audio(A,te(b)),this.load.image(F,te("assets/ui/menu_logo.png")),this.load.image(C,te("assets/ui/menu_options.png")),this.load.image(L,te("assets/ui/menu_select_level.png")),this.load.image(P,te("assets/ui/menu_setup_camera.png")),yield function(t){return new Promise(((e,i)=>Xt(this,void 0,void 0,(function*(){yield Zt(te(t)).then((t=>{e(t)})).catch((()=>{i([])}))}))))}(te(v)).then((t=>{t.forEach(((t,e)=>{this.levels.push(new Ee(t))})),this.levels.forEach((t=>{t.preloadTrack(this)}))}))},new((s=void 0)||(s=Promise))((function(t,a){function o(t){try{h(n.next(t))}catch(t){a(t)}}function r(t){try{h(n.throw(t))}catch(t){a(t)}}function h(e){var i;e.done?t(e.value):(i=e.value,i instanceof s?i:new s((function(t){t(i)}))).then(o,r)}h((n=n.apply(e,i||[])).next())}));var e,i,s,n}create(){super.create(),this.levels.forEach((t=>{t.setBPM(0)}));const t=window.innerWidth,e=window.innerHeight,i=.5*t;this.menuCalibrate=new Se(this,new r(i-.25*t,Et*e),It,P,A,!0),this.levels.length>0&&(this.menuSelectLevel=new Se(this,new r(i,Et*e),It,L,A,!0),this.menuSelectLevel.addPinchCallbacks({startPinch:()=>{this.scene.start(zt,this.levels)},startHover:()=>{this.menuSelectLevel.setTintFill(nt)},endHover:()=>{this.menuSelectLevel.clearTint()}})),this.menuOptions=new Se(this,new r(i+.25*t,Et*e),It,C,A,!0),this.menuLogo=this.add.sprite(0,0,F).setOrigin(0,0).setScale(.7,.7),this.menuLogo.setPosition(i-this.menuLogo.displayWidth/2,.25*e),this.menuCalibrate.addPinchCallbacks({startPinch:()=>{this.scene.start(Rt)},startHover:()=>{this.menuCalibrate.setTintFill(nt)},endHover:()=>{this.menuCalibrate.clearTint()}}),this.menuOptions.addPinchCallbacks({startPinch:()=>{this.scene.start(Wt)},startHover:()=>{this.menuOptions.setTintFill(nt)},endHover:()=>{this.menuOptions.clearTint()}})}update(t,e){super.update(t,e)}},class extends ke{constructor(){super(Wt),this.options=[]}setConfig(){var t;t=this.configData,te(Z),JSON.stringify(t),re(t),de.setVisibility(this.configData.enableCameraVisibility)}saveAndExit(){this.setConfig(),null!=this.rotateTween&&this.rotateTween.destroy(),this.scene.start(jt)}preload(){return We(this,void 0,void 0,(function*(){this.load.audio(A,te(b)),this.load.image(D,te("assets/ui/options_background.png")),this.load.image(V,te(J)),this.load.image(K,te("assets/ui/reset_button.png")),this.load.image(B,te(G))}))}create(){const t=Object.create(null,{create:{get:()=>super.create}});return We(this,void 0,void 0,(function*(){t.create.call(this),this.defaultData=oe,this.configData=ae,this.createOptions()}))}createOptions(){this.backToMenu=new Se(this,new r(Ge-.1*qe,.9*$e),It,V,A,!0),this.resetConfig=new Se(this,new r(Ge+.1*qe,.9*$e),It,K,A,!0),this.input.keyboard.on(gt,(()=>{this.saveAndExit()})),this.add.sprite(.09*qe,.05*$e,D).setOrigin(0,0).setAlpha(.8).setDisplaySize(.28*qe,.185*$e),this.add.sprite(.09*qe,.26*$e,D).setOrigin(0,0).setAlpha(.8).setDisplaySize(.28*qe,.27*$e),this.add.sprite(.09*qe,.55*$e,D).setOrigin(0,0).setAlpha(.8).setDisplaySize(.28*qe,.23*$e),this.add.sprite(.63*qe,.05*$e,D).setOrigin(0,0).setAlpha(.8).setDisplaySize(.28*qe,.185*$e),this.add.sprite(.63*qe,.26*$e,D).setOrigin(0,0).setAlpha(.8).setDisplaySize(.28*qe,.27*$e),this.add.sprite(.63*qe,.55*$e,D).setOrigin(0,0).setAlpha(.8).setDisplaySize(.28*qe,.23*$e);const t=this.add.sprite(.5*qe,Xe+0*Ze+.15*$e,B).setTint(Q[et]).setScale(this.configData.targetSize);this.rotateTween=this.tweens.add({targets:[t],rotation:2*Math.PI,ease:"Power0",duration:1e3,repeat:-1}),this.configData.fancyEffectsDisabled&&null!=this.rotateTween&&this.rotateTween.pause();const e=new ze(this,new r(Je,Xe+0*Ze),ii,new r(0,Mt.y),this.configData,"targetSize",new r(.5,3),(e=>{e.label.setText("Target Scale: "+e.getStringValue());const i=e.getValue();this.configData[e.key]=i,t.setScale(i)}));this.options.push(e),this.add.existing(e);const i=new ze(this,new r(Je,Xe+1*Ze),ii,new r(0,Mt.y),this.configData,"fingerSize",new r(.5,3),(t=>{null!=t.label&&t.label.setText("Finger Scale: "+t.getStringValue());const e=t.getValue();this.configData[t.key]=e,this.hand.setFingerScale(e)}));this.options.push(i),this.add.existing(i);const s=t=>{null!=t&&t.active&&(null!=t.label&&t.label.active&&t.label.setText("Camera Opacity: "+t.getStringValue()),this.configData[t.key]=t.getValue(),this.setOpacity(this.configData[t.key]))},n=new ze(this,new r(Je,Qe+0*Ye),ii,Mt,this.configData,"cameraOpacity",new r(.01,1),s),a=new Re(this,new r(Je,Qe+0*Ye+Ht.y),25,void 0,Ut,this.configData,"enableCameraVisibility",(t=>{this.configData[t.key]=t.isChecked,de.setVisibility(t.isChecked),t.isChecked?n.draw():(n.setValue(this.configData.cameraOpacity),s(n),this.setOpacity(0),n.hide("Show Camera"))}));this.options.push(n),this.options.push(a),this.add.existing(n),this.add.existing(a);const o=new ze(this,new r(Je,Qe+1*Ye),ii,Mt,this.configData,"skipLoopThreshold",new r(1,16),(t=>{t.label.setText("Skip Button After Loop: "+t.getStringValue()),this.configData[t.key]=t.getValue()})).setIsInteger(!0),h=new Re(this,new r(Je,Qe+1*Ye+Ht.y),25,void 0,Ut,this.configData,"enableSkipButton",(t=>{this.configData[t.key]=t.isChecked,t.isChecked?o.draw():o.hide("Show Layer Skip Button")}));this.options.push(o),this.options.push(h),this.add.existing(o),this.add.existing(h);const l=new ze(this,new r(Je,Qe+2*Ye),ii,Mt,this.configData,"autoSkipThreshold",new r(1,16),(t=>{t.label.setText("Skip Layers After Loop: "+t.getStringValue()),this.configData[t.key]=t.getValue()})).setIsInteger(!0),c=new Re(this,new r(Je,Qe+2*Ye+Ht.y),25,void 0,Ut,this.configData,"enableAutoSkip",(t=>{this.configData[t.key]=t.isChecked,t.isChecked?l.draw():l.hide("Skip Layers Automatically")}));this.options.push(l),this.options.push(c),this.add.existing(l),this.add.existing(c);const d=new Re(this,new r(Je,ti+0*ei),25,new r(-Ht.x,0),"Disable Layer Progression",this.configData,"disableLayerProgression",(t=>{this.configData[t.key]=t.isChecked}));this.options.push(d),this.add.existing(d);const u=new Re(this,new r(Je,ti+1*ei),25,new r(-Ht.x,0),"Index Finger Pinches Only",this.configData,"indexFingerOnly",(t=>{this.configData[t.key]=t.isChecked}));this.options.push(u),this.add.existing(u);const g=new Re(this,new r(Je,ti+2*ei),25,new r(-Ht.x,0),"Disable Fancy Effects",this.configData,"fancyEffectsDisabled",(e=>{this.configData[e.key]=e.isChecked,e.isChecked?null!=this.rotateTween&&this.rotateTween.pause():e.isChecked||null!=this.rotateTween&&null!=t&&this.rotateTween.resume()}));this.options.push(g),this.add.existing(g);const p=new ze(this,new r(Ue,Xe+0*Ze),ii,new r(0,Mt.y),this.configData,"onTimeDuration",new r(50,1e3),(t=>{t.label.setText("On Time Duration: "+t.getStringValue()+" ms"),this.configData[t.key]=t.getValue()})).setIsInteger(!0);this.options.push(p),this.add.existing(p);const f=new ze(this,new r(Ue,Xe+1*Ze),ii,new r(0,Mt.y),this.configData,"lateTimeDuration",new r(50,1e3),(t=>{t.label.setText("Late Time Duration: "+t.getStringValue()+" ms"),this.configData[t.key]=t.getValue()})).setIsInteger(!0);this.options.push(f),this.add.existing(f);const m=new ze(this,new r(Ue,Qe+0*Ye),ii,new r(0,Mt.y),this.configData,"sonificationLevel",new r(0,1),(t=>{t.label.setText("Pinch Volume: "+t.getStringValue()),this.configData[t.key]=t.getValue()}));this.options.push(m),this.add.existing(m);const v=new ze(this,new r(Ue,Qe+1*Ye),ii,new r(0,Mt.y),this.configData,"backgroundMusicLevel",new r(0,1),(t=>{t.label.setText("Track Volume: "+t.getStringValue()),this.configData[t.key]=t.getValue()}));this.options.push(v),this.add.existing(v);const y=new Re(this,new r(Ue,Qe+2*Ye),25,new r(-Ht.x,0),"Require Single Pinches",this.configData,"singlePinchRequirement",(t=>{this.configData[t.key]=t.isChecked}));this.options.push(y),this.add.existing(y);const b=new Re(this,new r(Ue,ti+0*ei),25,new r(-Ht.x,0),"Disable Visual Metronome",this.configData,"disableVisualMetronome",(t=>{this.configData[t.key]=t.isChecked}));this.options.push(b),this.add.existing(b);const w=new Re(this,new r(Ue,ti+1*ei),25,new r(-Ht.x,0),"Disable Sonification",this.configData,"disableSonification",(t=>{this.configData[t.key]=t.isChecked}));this.options.push(w),this.add.existing(w),this.backToMenu.addPinchCallbacks({startPinch:()=>{this.saveAndExit()},startHover:()=>{this.backToMenu.setTintFill(nt)},endHover:()=>{this.backToMenu.clearTint()}}),this.resetConfig.addPinchCallbacks({startPinch:()=>We(this,void 0,void 0,(function*(){this.configData=structuredClone(this.defaultData);for(const t of this.options)t.reset(this.configData);this.setConfig()})),startHover:()=>{this.resetConfig.setTintFill(nt)},endHover:()=>{this.resetConfig.clearTint()}})}update(t,e){super.update(t,e)}},class extends ke{constructor(){super(zt),this.currentLevelIndex=0,this.difficultyButtons=[],this.levels=[],Qt(this.currentLevelIndex>=0,"Level select default level must be >= 0")}preload(){this.levels=this.scene.settings.data,Qt(this.currentLevelIndex<this.levels.length,"Cannot set defaut level select index above the number of levels"),this.load.image(_,te("assets/ui/easy_button.png")),this.load.image(H,te("assets/ui/medium_button.png")),this.load.image(M,te("assets/ui/hard_button.png")),this.load.image(N,te(U)),this.load.image(j,te(X)),this.load.image(V,te(J)),this.load.image(I,te("assets/ui/play_button.png")),this.load.image(z,te("assets/ui/left_arrow.png")),this.load.image(R,te("assets/ui/right_arrow.png")),this.load.image($,te("assets/ui/default_preview_background.png")),this.load.image(x,te("assets/ui/video_background.png")),this.load.image(T,te("assets/ui/song_name_background.png"))}create(){super.create();const t=window.innerWidth,e=window.innerHeight,i=.5*t;this.play=new Se(this,new r(i,.9*e),It,I,A,!0),this.previousLevel=new Se(this,new r(i-.235*t,Vt*e),new r(.4,.4),z,A,!0),this.nextLevel=new Se(this,new r(i+.235*t,Vt*e),new r(.4,.4),R,A,!0),this.backToMenu=new Se(this,new r(i-.4*t,.9*e),It,V,A,!0),this.muteButton=new Fe(this,new r(i+.45*t,.9*e),new r(1.5,1.5),N,j,A,!0,!0),this.input.keyboard.on(gt,(()=>{this.scene.start(jt),this.exit()})),this.add.sprite(.5*window.innerWidth,.5*window.innerHeight-window.innerHeight*Dt,x).setScale(Ot.x,Ot.y).setOrigin(.5,.5),this.backToMenu.addPinchCallbacks({startPinch:()=>{this.scene.start(jt),this.exit()},startHover:()=>{this.backToMenu.setTintFill(nt)},endHover:()=>{this.backToMenu.clearTint()}}),this.play.addPinchCallbacks({startPinch:()=>{this.startLevel(this.getCurrentLevel())},startHover:()=>{this.play.setTintFill(nt)},endHover:()=>{this.play.clearTint()}}),this.add.sprite(i,e*Vt,T).setTintFill(0).setScale(.4,.4).setOrigin(.5,.5),this.songName=this.add.text(i,e*Vt,Ut,{font:"50px Courier New"}).setColor("white").setOrigin(.5,.5),this.updateLevel(0),this.previousLevel.addPinchCallbacks({startPinch:()=>{this.updateLevel(-1)},startHover:()=>{this.previousLevel.setTintFill(nt)},endHover:()=>{this.previousLevel.clearTint()}}),this.nextLevel.addPinchCallbacks({startPinch:()=>{this.updateLevel(1)},startHover:()=>{this.nextLevel.setTintFill(nt)},endHover:()=>{this.nextLevel.clearTint()}}),this.muteButton.addToggleCallback((t=>{this.setBackgroundAudioMute(!t)})),this.muteButton.addPinchCallbacks({startPinch:()=>{this.muteButton.toggle()},startHover:()=>{this.muteButton.setTintFill(nt)},endHover:()=>{this.muteButton.clearTint()}})}exit(){this.stopAudio()}startLevel(t){this.exit(),this.scene.start(Kt,t)}createDifficultyButtons(t){const e=window.innerWidth,i=window.innerHeight,s=.5*e;for(const t of this.difficultyButtons)t.destroy();this.difficultyButtons=[];const n=t.track.data.bpm,a=[_,H,M],o=[new r(s-.2*e,At*i),new r(s,At*i),new r(s+.2*e,At*i)];Qt(a.length>=n.length,"buttonKeys array length must at least match the number of track bpms"),Qt(o.length>=n.length,"positions array length must at least match the number of track bpms");for(let e=0;e<n.length;e++){const i=e,s=n[e],h=a[e],l=0==e,c=new Ke(this,o[e],new r(.4,.4),h,h,A,!0,i,s,l);c.addToggleCallback((e=>{c.updateTint(),e&&(t.setBPM(c.bpmIndex),this.startPreview(t))})),c.addPinchCallbacks({startPinch:()=>{for(const t of this.getDifficultyButtons())t!=c&&t.setToggleState(!1);c.setToggleState(!0)},startHover:()=>{c.setTintFill(nt)},endHover:()=>{c.updateTint()}}),this.difficultyButtons.push(c)}}getDifficultyButtons(){return this.difficultyButtons}setBackgroundAudioMute(t){for(const e of this.levels)e.setBackgroundAudioMute(t)}startVideo(t){if(null!=this.videoPreview&&this.videoPreview.destroy(),t.hasPreviewVideo()){this.videoPreview=this.add.video(.5*window.innerWidth,.5*window.innerHeight-window.innerHeight*Dt,t.getPreviewVideoKey()).setScale(Ot.x,Ot.y).setOrigin(.5,.5);const e=t.track.data.bpm[t.bpmIndex]/t.track.data.bpm[0];this.videoPreview.video&&(this.videoPreview.video.playbackRate=e),this.videoPreview.play(!0)}else this.videoPreview=this.add.sprite(.5*window.innerWidth,.5*window.innerHeight-window.innerHeight*Dt,$).setScale(Ot.x,Ot.y).setOrigin(.5,.5)}startPreview(t){this.stopAudio(),t.addBackgroundAudio(this,{loop:!0,volume:.5*ae.backgroundMusicLevel}),t.playBackgroundAudio(),t.setBackgroundAudioMute(!this.muteButton.getToggleState());const e=1e3*t.getAudioLoopTime();this.videoRefreshEvent=this.time.addEvent({delay:e,callback:()=>{this.startVideo(t)},callbackScope:this,loop:!0,startAt:e})}stopAudio(){this.videoRefreshEvent&&this.videoRefreshEvent.destroy();for(const t of this.levels)t.removeBackgroundAudio(this)}updateLevel(t){this.cycleLevel(t);const e=this.getCurrentLevel();this.songName.setText(e.track.data.displayName),Qt(0<e.track.data.bpm.length,"Default difficulty button index must be in range of default track BPM"),e.setBPM(0),this.startPreview(e),this.createDifficultyButtons(e)}cycleLevel(t){const e=this.levels.length;this.currentLevelIndex=((this.currentLevelIndex+t)%e+e)%e}getCurrentLevel(){return Qt(this.currentLevelIndex<this.levels.length,"Current level index out of range of this.levels array"),this.levels[this.currentLevelIndex]}getCurrentLevelKey(){return"level"+(this.currentLevelIndex+1).toString()}update(t,e){super.update(t,e)}},class extends ke{constructor(){super(Kt)}preload(){this.level=this.scene.settings.data,this.level.init(this),this.load.image(q,te("assets/ui/default_level_background.png"))}create(){super.create(),this.level.hasCustomBackground()?this.setBackgroundTexture(this.level.getBackgroundTextureKey()):this.setBackgroundTexture(q),this.input.keyboard.on(gt,(()=>{this.level.abort()})),this.level.start((()=>{this.scene.start(Nt,this.level)}),(()=>{this.scene.start(jt)}))}update(t,e){super.update(t,e),this.level.update(t)}},class extends ke{constructor(){super(Nt)}exit(){this.level.removeBackgroundAudio(this),this.scene.start(jt)}preload(){this.load.audio(A,te(b)),this.load.image(V,te(J)),this.load.image(N,te(U)),this.load.image(j,te(X)),this.load.image(W,te("assets/ui/save_csv_button.png")),this.load.image(k,te("assets/ui/layer_score_background.png")),this.load.image(S,te("assets/ui/scoreboard_background.png")),this.level=this.scene.settings.data,this.levelStats=this.level.score.levelStats,ae.autoSaveCSV&&le(this.level.score.levelStats)}create(){super.create();const t=window.innerWidth,e=window.innerHeight,i=.5*t,s=Math.min(t/1920,e/1080);this.backToMenu=new Se(this,new r(i,.9*e),It,V,A,!0),this.muteButton=new Fe(this,new r(i+.45*t,.9*e),_t,N,j,A,!0,!0),this.level.addBackgroundAudio(this,{loop:!0,volume:.5*ae.backgroundMusicLevel}),this.level.playBackgroundAudio(),this.muteButton.addToggleCallback((t=>{this.level.setBackgroundAudioMute(!t)})),this.muteButton.addPinchCallbacks({startPinch:()=>{this.muteButton.toggle()},startHover:()=>{this.muteButton.setTintFill(nt)},endHover:()=>{this.muteButton.clearTint()}}),this.input.keyboard.on(gt,(()=>{this.exit()})),ae.autoSaveCSV||(this.saveButton=new Se(this,new r(i-.4*t,.9*e),new r(.6,.6),W,A,!0),this.saveButton.addPinchCallbacks({startPinch:()=>{!function(t){const e=new Blob([a(t)],{type:"text/plain;charset=utf-8"});ne().saveAs(e,t.id+".csv")}(this.levelStats)},startHover:()=>{this.saveButton.setTintFill(nt)},endHover:()=>{this.saveButton.clearTint()}})),this.add.sprite(0,0,S).setOrigin(.5,.5).setScale(1.35*s,1.25*s).setAlpha(.6).setPosition(i,.25*e);const n=this.add.text(i,0,"Scoreboard",{color:"#01c303",font:96*s+"px Arial"});n.setStroke("#000",6*s),n.setPosition(i-n.width/2,.07*e);const o=this.levelStats.layersStats.reduce(((t,e)=>t+e.total),0),h=this.levelStats.layersStats.reduce(((t,e)=>t+e.correct),0),l=this.levelStats.layersStats.reduce(((t,e)=>t+e.miss),0),c=this.levelStats.layersStats.reduce(((t,e)=>t+e.early),0),d=this.levelStats.layersStats.reduce(((t,e)=>t+e.late),0),u=this.add.text(i,0,`Total Correct: ${h.toString()}/${o.toString()}\nLongest Streak: ${this.levelStats.maxStreak}\nMissed: ${l}\nEarly: ${c}\nLate: ${d}`,{color:"#ffffff",align:"center",font:48*s+"px Arial"});u.setPosition(i-u.width/2,.19*e);const g=[.25,.5,.75],p=g;this.level.track.forEachLayer(void 0,((i,n)=>{this.add.sprite(0,0,k).setOrigin(.5,.5).setScale(1.35*s,1.15*s).setAlpha(.6).setPosition(t*g[n],.63*e);const a=this.add.text(0,0,`${o=i.id,o&&o[0].toUpperCase()+o.slice(1)||""}`,{color:"#01c303",align:"center",font:72*s+"px Arial",fontStyle:"bold"});var o;a.setStroke("#000",4*s),a.setPosition(t*p[n]-a.width/2,.53*e);const r=this.levelStats.layersStats[n];let h=0,l=0,c=0;null!=r&&(h=r.correct,l=r.total,c=r.loop);const d=this.add.text(0,0,`\nCorrect: ${h.toString()}/${l.toString()}\nLoops: ${c.toString()}`,{color:"#ffffff",align:"center",font:48*s+"px Arial"});d.setPosition(t*p[n]-d.width/2,.575*e+.01)})),this.backToMenu.addPinchCallbacks({startPinch:()=>{this.exit()},startHover:()=>{this.backToMenu.setTintFill(nt)},endHover:()=>{this.backToMenu.clearTint()}})}update(t,e){super.update(t,e)}},class extends ke{constructor(){super(Rt)}exit(){this.scene.start(jt)}preload(){this.load.image(V,te(J)),this.load.audio(A,te(b)),this.load.image(E,te("assets/ui/calibration_background.png"))}create(){super.create(!0,.8);const t=window.innerWidth,e=window.innerHeight,i=.5*t;this.backToMenu=new Se(this,new r(i,.9*e),It,V,A,!0),this.setBackgroundTexture(E),this.input.keyboard.on(gt,(()=>{this.exit()})),this.distanceText=this.add.text(i,.1*e,Ut,{color:"white",font:"60px Arial"}).setShadow(5,5,"rgba(0,0,0,0.5)",15).setOrigin(.5,.5),this.backToMenu.addPinchCallbacks({startPinch:()=>{this.exit()},startHover:()=>{this.backToMenu.setTintFill(nt)},endHover:()=>{this.backToMenu.clearTint()}})}update(t,e){super.update(t,e);const i=this.hand.calculateHandDistance();let s="Hand Not Recognized";if(i>0){let t=65280;i>40?(s="Too Far - Estimated Distance: ",t=16711680):i<20?(s="Too Close - Estimated Distance: ",t=255):s="Just Right - Estimated Distance: ",this.setBackgroundTint(t),s+=i.toFixed(0)+" cm"}else this.clearBackgroundTint();null!=this.distanceText&&this.distanceText.active&&this.distanceText.setText(s)}}]};function li(){document.body.removeChild(document.getElementById("login_screen")),new(n().Game)(hi)}const ci=(0,si.Wp)({apiKey:"AIzaSyAHkhSVhXo1qrE3lYqXEh2ozwOgZJhk960",authDomain:"pizzicato-1f765.firebaseapp.com",projectId:"pizzicato-1f765",storageBucket:"pizzicato-1f765.firebasestorage.app",messagingSenderId:"196367706867",appId:"1:196367706867:web:bb5cac34655842ac462586",databaseURL:"https://pizzicato-1f765-default-rtdb.europe-west1.firebasedatabase.app/"}),di=(0,ni.xI)(ci),ui=(0,ai.C3)(ci),gi={name:"",config:"",phase:"",experimentStart:"",week:0,lastLogin:""},pi="@pizzicato.com";function fi(t){return t.endsWith("pre")?t.slice(0,-3):t.endsWith("post")?t.slice(0,-4):t}function mi(){return ri?ri.email.replace(pi,""):"guest"}function vi(){const t=new Date;return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}function yi(t){alert(t)}function bi(t,e){return oi(this,void 0,void 0,(function*(){return new Promise(((i,s)=>{const n=(0,ai.KR)(ui,`users/${ri.uid}/data/${t}`);(0,ai.hZ)(n,e).then((()=>{i('Data written successfully for user "'+mi()+'"')})).catch((t=>{s('Data not found for user "'+mi()+'":'+t)}))}))}))}function wi(){return oi(this,void 0,void 0,(function*(){return new Promise(((t,e)=>{const i=(0,ai.KR)(ui);(0,ai.Jt)((0,ai.jf)(i,`users/${ri.uid}`)).then((i=>{if(i.exists()){const s=i.val();(function(t){return oi(this,void 0,void 0,(function*(){return new Promise(((e,i)=>{if(t){const s=(0,ai.KR)(ui);(0,ai.Jt)((0,ai.jf)(s,`configs/${t}`)).then((t=>{t.exists()?e(t.val()):i("Config name snapshot does not exist: resorting to default config")})).catch((t=>{i("Firebase get configs failed: "+t)}))}else i("Undefined config name: resorting to default config")}))}))})(s.config).then((i=>{s.config?t([i,s.config]):e("Undefined config name")})).catch((t=>{e("Failed to retrieve config: "+t)}))}else e("User id snapshot does not exist: resorting to default config")})).catch((t=>{e("Firebase get users failed: "+t)}))}))}))}function xi(){return oi(this,void 0,void 0,(function*(){return new Promise(((t,e)=>{const i=(0,ai.KR)(ui);(0,ai.Jt)((0,ai.jf)(i,`users/${ri.uid}`)).then((i=>{if(i.exists()){const e=i.val();t(e.week)}else e("Failed to identify week number")})).catch((t=>{e("Firebase get users failed: "+t)}))}))}))}{const t='\n    <div id="login_screen">\n      <div class="login-container">\n        <h2>Experiment Login</h2>\n        <div class="input-group">\n          <input type="text" id="name" name="name" placeholder="Name" required>\n        </div>\n        <div class="input-group">\n          <input type="password" id="password" name="password" placeholder="Password" required>\n        </div>\n        <div class="button-group">\n          <button id="login_button" class="login-button">Login</button>\n        </div>\n      </div>\n    </div>\n    <div id="background_image"></div>\n  ';document.body.innerHTML+=t,document.getElementById("login_button").addEventListener("click",(function(){return oi(this,void 0,void 0,(function*(){const[t,e,i]=function(){const t=document.getElementById("name").value,e=document.getElementById("password").value,i=function(t){return t+pi}(fi(t));return function(t){return/^[A-Za-z][A-Za-z0-9_]{3,29}$/.test(t)}(t)?function(t){return t.length>=6}(e)?function(t){return/^[^@]+@\w+(\.\w+)+\w$/.test(t)}(i)?[t,i,e]:(alert('Failed email creation "'+i+'" is invalid!'),alert("Failed to validate credentials!"),["","",""]):(alert("Password is invalid!"),["","",""]):(alert('Name "'+t+'" is invalid!'),["","",""])}();(0,ni.x9)(di,e,i).then((e=>{const i=function(t){const e=t.match(/^participant(\d+)(pre|post)?$/);return e?{number:parseInt(e[1],10),suffix:e[2]||"training"}:null}(t);if(null==i)return void yi("Invalid participant info");const s=function(t){if(t<0)throw new Error("Participant number cannot be negative.");switch(t%4){case 0:return"sonification";case 1:return"synchronization";case 2:return"both";case 3:return"none";default:return"unknown"}}(i.number);ri=e.user;const n=(0,ai.KR)(ui),a=(new Date).toUTCString(),o={lastLogin:a,config:s},r=`users/${ri.uid}`;gi.name=fi(t),gi.lastLogin=a,gi.config=s,gi.week=0,gi.phase=i.suffix,o.phase=i.suffix,"pre"==i.suffix&&(gi.experimentStart=vi(),o.experimentStart=vi()),(0,ai.Jt)((0,ai.jf)(n,r)).then((t=>{if(t.exists()){const e=t.val();if("pre"!=i.suffix&&""==e.experimentStart)return void yi("Cannot login with the provided credentials prior to experiment start being set");if("pre"==i.suffix)o.week=0;else{let t=e.experimentStart;null!=t&&""!=t||(t=o.experimentStart);const i=function(t,e){try{const i=new Date(t),s=new Date(e);if(isNaN(i.getTime())||isNaN(s.getTime()))return null;const n=s.getTime()-i.getTime(),a=Math.ceil(n/864e5);return a<=0?1:Math.ceil(a/7)}catch(t){return console.error("Error calculating week number:",t),null}}(t,vi());if(null==i)return void yi("Failed to calculate experiment week number");o.week=i}(0,ai.yo)((0,ai.jf)(n,r),o).then((()=>{li()}))}else{if(""==gi.experimentStart)return void yi("Cannot login with the provided credentials prior to experiment start being set");(0,ai.yo)((0,ai.jf)(n,r),gi).then((()=>{li()}))}})).catch((t=>{console.info("LOGIN ERROR: "+t)}))})).catch((t=>{"auth/invalid-credential"===t.code?alert("Invalid username or password. Please try again."):"auth/user-disabled"===t.code?alert("This user account has been disabled."):"auth/user-not-found"===t.code?alert("User not found. Please check your credentials."):"auth/wrong-password"===t.code?alert("Incorrect password. Please try again."):console.error("Firebase sign-in error:",t)}))}))}))}}},i={};function s(t){var n=i[t];if(void 0!==n)return n.exports;var a=i[t]={exports:{}};return e[t].call(a.exports,a,a.exports,s),a.exports}s.m=e,t=[],s.O=(e,i,n,a)=>{if(!i){var o=1/0;for(c=0;c<t.length;c++){for(var[i,n,a]=t[c],r=!0,h=0;h<i.length;h++)(!1&a||o>=a)&&Object.keys(s.O).every((t=>s.O[t](i[h])))?i.splice(h--,1):(r=!1,a<o&&(o=a));if(r){t.splice(c--,1);var l=n();void 0!==l&&(e=l)}}return e}a=a||0;for(var c=t.length;c>0&&t[c-1][2]>a;c--)t[c]=t[c-1];t[c]=[i,n,a]},s.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return s.d(e,{a:e}),e},s.d=(t,e)=>{for(var i in e)s.o(e,i)&&!s.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),(()=>{var t={792:0};s.O.j=e=>0===t[e];var e=(e,i)=>{var n,a,[o,r,h]=i,l=0;if(o.some((e=>0!==t[e]))){for(n in r)s.o(r,n)&&(s.m[n]=r[n]);if(h)var c=h(s)}for(e&&e(i);l<o.length;l++)a=o[l],s.o(t,a)&&t[a]&&t[a][0](),t[a]=0;return s.O(c)},i=self.webpackChunkPizzicato=self.webpackChunkPizzicato||[];i.forEach(e.bind(null,0)),i.push=e.bind(null,i.push.bind(i))})();var n=s.O(void 0,[96],(()=>s(852)));n=s.O(n)})();