(()=>{"use strict";var e,t={168:(e,t,i)=>{i.d(t,{Ny:()=>Ze,KE:()=>Je,lW:()=>ct,ID:()=>at,QW:()=>ut,pp:()=>dt,vh:()=>lt});var s=i(440),n=i.n(s);const o=Phaser.Math.Vector2,a=Phaser.GameObjects.Group,r=Phaser.GameObjects.Graphics,h=Phaser.Time.TimerEvent,l=Phaser.GameObjects.GameObject,d=Phaser.Geom.Rectangle,c=(Phaser.Geom.Circle,Phaser.Input.Pointer,Phaser.GameObjects.Text),u=(Phaser.GameObjects.Sprite,Phaser.GameObjects.Video,Phaser.GameObjects.RenderTexture,Phaser.Events.EventEmitter,Phaser.GameObjects.Image,Phaser.Scene),g=(Phaser.Tilemaps.Tile,Phaser.Tweens.Tween,Phaser.GameObjects.Particles.ParticleEmitter,Phaser.Physics.Matter.Sprite),p=(Phaser.Physics.Arcade.Sprite,"levels/"),m=p+"list.json",y=".mp3",f={thumb:16777215,index:14948892,middle:38655,ring:16771584,pinky:14315734},v={lineWidth:5,color:11393254,alpha:.5},w={lineWidth:5,color:11393254,alpha:1,radius:.1},b="thumb",x="index",T="middle",k="ring",S="pinky",P={align:"center",font:"50px Courier New",color:"#01C303"},C=x,L=16777215,B=L,E=14948892,O=E,I=16777215,D="linear",A={scale:1.03,color:16777215,ease:"linear"},N={scale:.78,color:5091146,ease:"linear"},M={scale:.3,color:16744192,ease:"linear"},F={scale:0,color:8421504,ease:"cubic.in"},V="keydown-ESC",z={color:"white",scale:1,font:"30px Courier New",depth:40,strokeThickness:0,shadowOffset:new o(2,2),shadowColor:"black",shadowBlurRadius:2},_={color:[16436258,16291840,16266752,10421252],colorEase:"quad.out",lifespan:500,scale:{start:.7,end:0,ease:"sine.out"},speed:200,advance:500,frequency:50,blendMode:"ADD",duration:0},R={requiredTint:524543,completedRequiredTint:2840741,completedTint:N.color,extraTint:N.color,tintByNode:!1},K="Easy",j="Medium",H="Hard",$=new o(-32,-32),G=new o(32,-32),q="continueScene",W=q,U={visible:!1,flip:!0,opacity:0,objectFit:"fill"},Y={video:{width:{ideal:640},height:{ideal:360}},audio:!1},X={baseOptions:{delegate:"GPU"},runningMode:"VIDEO",numHands:1,minHandDetectionConfidence:.5,minHandPresenceConfidence:.5,minTrackingConfidence:.5},J="UNDEFINED";function Z(e,t="no error message provided"){if(!e)throw new Error("Assertion failed: "+t)}function Q(e,t=""){const i="".replace(/\\/g,"/")+t;return e=e.replace(/\\/g,"/"),"/"==Array.from(e)[0]?i+e:i+"/"+e}function ee(e){return Q(e,"")}var te=function(e,t,i,s){return new(i||(i=Promise))((function(n,o){function a(e){try{h(s.next(e))}catch(e){o(e)}}function r(e){try{h(s.throw(e))}catch(e){o(e)}}function h(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,r)}h((s=s.apply(e,t||[])).next())}))};const ie=new class{init(e,t,i,s){return te(this,void 0,void 0,(function*(){return new Promise(((n,o)=>te(this,void 0,void 0,(function*(){s("LOADING WEBCAM..."),this.setupVideoElement(e,t,i),yield navigator.mediaDevices.getUserMedia(Y).then((e=>{"srcObject"in this.video?(this.video.srcObject=e,this.video.addEventListener("loadeddata",(()=>{n(!0)}))):o("srcObject does not exist on older browsers")})).catch((e=>{o(e)}))}))))}))}found(){return null!=this.video.srcObject}setVisibility(e){this.video.style.visibility="",this.video.style.visibility=e?"shown":"hidden"}setupVideoElement(e,t,i){this.video=document.body.appendChild(document.createElement("video")),this.video.autoplay=!0,this.video.muted=!0,this.video.playsInline=!0,this.video.width=t,this.video.height=i,e.flip&&(this.video.style.cssText+="-moz-transform: translate(-50%, -50%) scale(-1, 1);          -webkit-transform: translate(-50%, -50%) scale(-1, 1); -o-transform: translate(-50%, -50%) scale(-1, 1);          transform: translate(-50%, -50%) scale(-1, 1); filter: FlipH;"),this.setVisibility(!1)}get video(){return Z(null!=this.video_),this.video_}set video(e){this.video_=e}};var se=i(260),ne=function(e,t,i,s){return new(i||(i=Promise))((function(n,o){function a(e){try{h(s.next(e))}catch(e){o(e)}}function r(e){try{h(s.throw(e))}catch(e){o(e)}}function h(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,r)}h((s=s.apply(e,t||[])).next())}))};const oe=new class{constructor(){this.lastVideoTime=-1}init(e){return ne(this,void 0,void 0,(function*(){return new Promise(((t,i)=>ne(this,void 0,void 0,(function*(){let s;yield se.Ps.forVisionTasks(Q("models/wasm")).then((e=>s=e)).catch((e=>{i(e)})),e("LOADING HAND TRACKER..."),X.baseOptions.modelAssetPath=ee("models/hand_landmarker.task"),yield se.Vb.createFromOptions(s,X).then((e=>this.handLandmarker=e)).catch((e=>{e instanceof Event&&"error"==e.type&&i("Failed to fetch vision_wasm_internal.js in specified wasm directory"),e instanceof TypeError&&i("Failed to fetch hand_landmark.task file"),i(e)})),t(!0)}))))}))}precache(e){e("PRE-CACHING LANDMARKS..."),this.update()}found(){return null!=this.handLandmarker}update(){this.lastVideoTime!=ie.video.currentTime&&(this.lastVideoTime=ie.video.currentTime,this.results=this.handLandmarker.detectForVideo(ie.video,performance.now()))}landmarksFound(e=0){return null!=this.results&&e<this.results.landmarks.length}landmarkFound(e,t=0){if(!this.landmarksFound(t))return!1;const i=this.results.landmarks[t][e];return i.x>=0&&i.x<=1&&i.y>=0&&i.y<=1}getNormalizedLandmarkPosition(e,t=0){if(!this.landmarksFound(t))return;const i=this.results.landmarks[t][e];return new o(1-i.x,i.y)}forEachNormalizedLandmarkPosition(e,t=0){for(let i=0;i<21;++i){const s=this.getNormalizedLandmarkPosition(i,t);null!=s&&e(s)}}};function ae(e){let t="layerID,noteID,pinchType,loopNumber,playerTime,correctTime,classification,normalizedTargetRadius,normalizedTargetPositionX,normalizedTargetPositionY,normalizedFingerRadius,normalizedPinkyFingerPositionX,normalizedPinkyFingerPositionY,normalizedRingFingerPositionX,normalizedRingFingerPositionY,normalizedMiddleFingerPositionX,normalizedMiddleFingerPositionY,normalizedIndexFingerPositionX,normalizedIndexFingerPositionY,normalizedThumbFingerPositionX,normalizedThumbFingerPositionY\n";for(const i of e.layersStats){const s=e.layersStats.indexOf(i);for(const e of i.hits){const i=e.normalizedFingerRadius?e.normalizedFingerRadius:null,[n,o]=e.normalizedTargetPosition,[a,r]=e.normalizedPinkyFingerPosition?e.normalizedPinkyFingerPosition:[null,null],[h,l]=e.normalizedRingFingerPosition?e.normalizedRingFingerPosition:[null,null],[d,c]=e.normalizedMiddleFingerPosition?e.normalizedMiddleFingerPosition:[null,null],[u,g]=e.normalizedIndexFingerPosition?e.normalizedIndexFingerPosition:[null,null],[p,m]=e.normalizedThumbFingerPosition?e.normalizedThumbFingerPosition:[null,null];t+=`${s},${e.noteID},${e.pinchType},${e.loopNumber},${re(e.playerTime)},${re(e.correctTime)},${e.classification},${e.normalizedTargetRadius},${n},${o},${i},${a},${r},${h},${l},${d},${c},${u},${g},${p},${m}\n`}}return t}function re(e,t=3){return parseFloat((e/1e3).toFixed(t))}var he=i(213),le=i.n(he);let de,ce;function ue(e,t=!0){ce=structuredClone(e),t&&(console.info("INFO: Config set to:"),console.info(ce))}function ge(e,t){ce[e]=t}function pe(e){if(Ze){const t=JSON.parse(JSON.stringify(e));lt(e.id,t).then((e=>{console.info("INFO: "+e)})).catch((e=>{console.info("INFO: "+e)}))}}class me{constructor(e,t){this.trackKey=J,this.bpm=0,this.beatLength_=1,this.scene=e,this.trackKey=t,this.trackDir=p+this.trackKey+"/",this.scene.load.json(this.trackKey,ee(this.trackDir+"info.json"))}get beatLength(){return this.beatLength_}setBPM(e){Z(null!=this.data,"preload JSON before setting BPM"),Z(e<this.data.bpm.length,"BPM index out of range"),this.bpm=this.data.bpm[e];const t=16/this.data.timeSignatureDenominator;this.beatLength_=this.songTimePositionToTime({bar:1,step:1+t,tick:0})}getBPM(){return Z(null!=this.data,"preload JSON before retrieving BPM"),Z(0!=this.bpm,"Track BPM has not been set"),this.bpm}preloadNotes(){Z(null!=this.trackDir,"Preload track before preloading notes"),this.forEachLayer(void 0,(e=>{e.nodes.forEach(((t,i)=>{const s=this.getSoundKey(e,t.soundKey),n=this.trackDir+e.id+"/"+t.soundKey+y;this.scene.cache.audio.exists(s)||""===t.soundKey||this.scene.load.audio(s,ee(n))}))}))}unloadNotes(){this.forEachLayer(void 0,(e=>{e.nodes.forEach(((t,i)=>{this.scene.cache.audio.remove(this.getSoundKey(e,t.soundKey))}))}))}preloadLoops(){this.forEachLayer((e=>{Z(null!=e.soundLoopKeys),Z(e.soundLoopKeys.length>0),e.soundLoopKeys.forEach((t=>{const i=this.getSoundKey(e,t),s=this.trackDir+e.id+"/"+t+y;this.scene.cache.audio.exists(i)||""===t||this.scene.load.audio(i,ee(s))}))}))}unloadLoops(){this.forEachLayer((e=>{e.soundLoopKeys.forEach((t=>{this.scene.cache.audio.remove(this.getSoundKey(e,t))}))}))}getSoundKey(e,t){return Z(null!=t),this.trackKey+"/"+e.id+"/"+t}forEachLayer(e,t){Z(null!=this.data,"JSON has not finished preloading");let i=0;this.data.layers.forEach(((s,n)=>{s.playable||i++,null==e||e(s,n),s.playable&&(null==t||t(s,n-i))}))}addBackgroundAudioTracks(e,t,i,s){const n=[];return this.forEachLayer(((o,a)=>{(null==s||s(o,a))&&(o.playable&&ce.playableBackingTracksEnabled||!o.playable&&ce.unplayableBackingTracksEnabled)&&(Z(null!=o.soundLoopKeys),Z(i<o.soundLoopKeys.length,"BPM index out of range of layer sound loop keys"),n.push(e.sound.add(this.getSoundKey(o,o.soundLoopKeys[i]),t)))})),n}timeToSongTimePosition(e){Z(0!=this.bpm,"set BPM before retrieving song times");const t=e/(6e4/this.bpm),i=Math.floor(t/this.data.timeSignatureNumerator)+1,s=t%this.data.timeSignatureNumerator,n=4*s%1;return{bar:i,step:Math.floor(s*(4/this.data.timeSignatureDenominator)*4)+1,tick:Math.floor(n*(this.data.timeBasePPQ/4))}}songTimePositionToTime(e){return Z(0!=this.bpm,"set BPM before retrieving song times"),((e.bar-1)*this.data.timeSignatureNumerator+(e.step-1)/(4/this.data.timeSignatureDenominator*4)+e.tick/this.data.timeBasePPQ)*(6e4/this.bpm)}preload(e){this.scene=e,this.data=this.scene.cache.json.get(this.trackKey),Z(null!=this.data,"Failed to retrieve JSON for track"),this.parseJson(),this.preloadLoops(),this.preloadNotes()}unload(){this.unloadLoops(),this.unloadNotes()}parseJson(){this.setTimePositionDefaults(),this.sortNodes()}setTimePositionDefaults(){this.forEachLayer(void 0,(e=>{const t=(e,t,i,s)=>{e.bar||(e.bar=t),e.step||(e.step=i),e.tick||(e.tick=s)};Z(e.progressCount<=e.nodes.length,"Progress count threshold for layer '"+e.id+"' of track '"+this.trackKey+"' cannot be higher than the node count."),t(e.previewTime,0,0,0),e.nodes.forEach((e=>{t(e.timePosition,1,1,0)}))}))}sortNodes(){this.forEachLayer(void 0,(e=>{e.nodes.sort(((e,t)=>e.timePosition.bar!==t.timePosition.bar?e.timePosition.bar-t.timePosition.bar:e.timePosition.step!==t.timePosition.step?e.timePosition.step-t.timePosition.step:e.timePosition.tick-t.timePosition.tick))}))}}class ye extends l{constructor(e){super(e,"metronome"),this.beat=0,this.timer=new h({}),this.countdownText=this.scene.add.text(e.center.x,e.center.y,J,{font:"240px Courier New",color:"white"}).setOrigin(.5,.5).setDepth(30),this.setVisible(!1),this.on("destroy",(()=>{this.shrinkTween&&this.shrinkTween.destroy(),this.countdownTexture&&this.countdownTexture.destroy(),this.countdownText&&this.countdownText.destroy(),this.timer&&this.timer.destroy()}))}setup(){this.countdownTexture=this.scene.add.sprite(this.countdownText.getCenter().x,this.countdownText.getCenter().y,"countdown").setScale(1).setVisible(!1).setAlpha(.3).setDepth(30)}setVisible(e){this.countdownText&&this.countdownText.setVisible(e),this.countdownTexture&&this.countdownTexture.setVisible(e)}stop(){this.setVisible(!1),this.scene&&(this.scene.time.removeEvent(this.timer),this.scene.sound.stopByKey("metronomeHigh"),this.scene.sound.stopByKey("metronomeLow"),this.shrinkTween&&this.scene.tweens.remove(this.shrinkTween))}play(e,t,i){this.beat=0,this.stop(),this.timer=this.scene.time.addEvent({callback:this.tick.bind(this,e,t,i),delay:t,loop:!0,startAt:t})}tick(e,t,i){Z(i>=1,"Cannot display metronome for less than minimum bar count");const s=e*i,n=this.beat%e,o=0==n?"metronomeHigh":"metronomeLow";this.beat>=s?this.setVisible(!1):(this.countdownText.active&&this.scene.sound.play(o,{volume:ce.backgroundMusicVolume}),Z(s-e>=0),this.beat>=s-e&&this.countdownText.active&&ce.displayVisualMetronome&&this.display(n+1,t),this.beat++)}display(e,t){this.countdownText.setText(e.toString()),this.countdownText.setScale(1),this.countdownTexture.setScale(1),this.setVisible(!0),this.shrinkTween=this.scene.tweens.add({targets:[this.countdownText,this.countdownTexture],ease:"Power0",duration:.9*t,scale:0,repeat:0})}}class fe extends a{constructor(e){super(e),this.current_=0,this.requiredProgress=-1,this.nodeCount=1,this.tints=[],Z(this.current_>=0),this.tints=[],this.scene.add.existing(this),this.setVisible(!1)}setup(e,t,i,s){Z(i<=t),Z(s.length===t,"Must pass tints equal in number to nodes"),Z(t>0),Z(i>0),Z(e>=0),this.current_=e,this.nodeCount=t,this.tints=s,this.requiredProgress=i;const n=768/this.nodeCount;this.clear(),this.createMultiple({quantity:this.nodeCount,key:"progressSegment",visible:!0,setXY:{x:this.scene.scale.width/2-384+n/2,y:0,stepX:n},setOrigin:{x:.5,y:0}}),this.propertyValueSet("displayWidth",n),this.propertyValueSet("displayHeight",43),this.setDepth(61),this.redraw()}setToStarting(){this.current_=0,Z(this.current_>=0),this.redraw()}redraw(){if(this.current<=this.nodeCount){this.getChildren().forEach(((e,t)=>{e.clearTint()}));const e=-1===this.requiredProgress?this.nodeCount:this.requiredProgress-1,t=this.current;this.getChildren().forEach(((i,s)=>{const n=i;R.tintByNode&&n.setTint(this.tints[s]),s<t&&(s<=e?n.setTint(R.completedTint):n.setTint(R.extraTint)),s===e&&(t>e?n.setTint(R.completedRequiredTint):n.setTint(R.requiredTint))}),this)}}canProgress(){const e=-1===this.requiredProgress;return e&&this.current>=this.nodeCount||!e&&this.current>=this.requiredProgress}changeBy(e){this.current_=Math.max(0,Math.min(this.current+e,this.nodeCount))}get current(){return this.current_}}function ve(e,t,i){null!=e&&(e.setVisible(t),Object.hasOwn(e,"text")&&null!=e.text&&e.text.setVisible(t),t?e.setInteractive(i):e.disableInteractive())}class we extends g{constructor(e,t,i,s,n=()=>{},o="button",a="pinch",r=.5,h=.5){if(super(e.matter.world,i,s,o,void 0,{render:{visible:!0},label:"button-"+o}),this.resetTint=!0,this.scene=e,this.scene.add.existing(this),this.setOrigin(r,h),this.sound=this.scene.sound.add(a,{volume:ce.pinchVolume}),""!==t){const e=this.getCenter();this.text=this.scene.add.text(e.x,e.y,t,P).setOrigin(.5,.5)}ve(this,!0),this.setSensor(!0),this.setDepth(93),this.setOnPinch(n),this.on("destroy",(()=>{this.scene.hand.removePinchCheck(C,this),this.sound&&(this.sound.isPlaying?this.sound.on("complete",(()=>{this.sound&&this.sound.destroy()})):this.sound.destroy())}))}removePinchCallbacks(){this.scene.hand.removePinchCheck(C,this)}setOnPinch(e){this.setPinchCallbacks({startPinch:e,startHover:()=>{(this.resetTint||16777215==this.tint)&&(this.text&&this.text.visible&&this.text.setTintFill(B),this.setTintFill(L))},endHover:()=>{(this.resetTint||this.tint==B)&&(this.text&&this.text.visible&&this.text.clearTint(),this.clearTint())}})}setPinchCallbacks(e){const t=()=>{var t;null===(t=e.startPinch)||void 0===t||t.call(e),this.sound.play({volume:ce.pinchVolume})},i={startPinch:()=>{ce.uiPinchesEnabled&&t()},pinched:()=>{var t;ce.uiPinchesEnabled&&(null===(t=e.pinched)||void 0===t||t.call(e))},endPinch:()=>{var t;ce.uiPinchesEnabled&&(null===(t=e.endPinch)||void 0===t||t.call(e))},startHover:()=>{var t;ce.uiPinchesEnabled&&(null===(t=e.startHover)||void 0===t||t.call(e))},endHover:()=>{var t;ce.uiPinchesEnabled&&(null===(t=e.endHover)||void 0===t||t.call(e))}};this.scene.hand.addPinchCheck(C,this,i),this.on("pointerdown",t),e.startHover&&this.on("pointermove",e.startHover),e.endHover&&this.on("pointerout",e.endHover)}}class be extends l{constructor(e,t){super(e,"infoHUD"),this.scene=e,this.level=t,this.on("destroy",(()=>{this.trackText&&this.trackText.destroy(),this.difficultyText&&this.difficultyText.destroy(),this.bpmText&&this.bpmText.destroy(),this.layerText&&this.layerText.destroy(),this.loopText&&this.loopText.destroy(),this.infoBackground&&this.infoBackground.destroy(),this.skipButton&&this.skipButton.destroy()}))}setup(){this.addTexts(),this.addSkipButton(),this.setVisible(!1)}addSkipButton(){this.skipButton=new we(this.scene,"SKIP LAYER",this.scene.width-200,this.scene.height-100,(()=>{ve(this.skipButton,!1),this.level.transitionLayers()})),this.skipButton.setScale(.8),this.skipButton.text.setScale(.8),this.skipButton.setPosition(this.scene.width-this.skipButton.displayWidth/2,this.scene.height-this.skipButton.displayHeight/2);const e=this.skipButton.getCenter();this.skipButton.text.setPosition(e.x,e.y),this.updateSkipButtonAvailability(!1)}setVisible(e){this.trackText&&this.trackText.setVisible(e),this.difficultyText&&this.difficultyText.setVisible(e),this.bpmText&&this.bpmText.setVisible(e),this.layerText&&this.layerText.setVisible(e),this.loopText&&this.loopText.setVisible(e),this.infoBackground&&this.infoBackground.setVisible(e),this.skipButton&&(this.skipButton.setVisible(e),this.skipButton.text&&this.skipButton.text.setVisible(e)),this.updateSkipButtonAvailability(e)}addText(e,t){return this.scene.add.text(e.position.x,e.position.y,t,{font:e.font,color:e.color}).setScale(e.scale).setDepth(e.depth)}getLoopText(){let e="Loop: "+this.level.score.getLoopCount().toString();return ce.skipLayersAutomatically&&(e+="/"+ce.skipLayersAutomaticallyAfterLoop.toString()),e}addTexts(){this.loopText=this.addText({position:new o(.85*this.scene.width,.22*this.scene.height),color:"white",font:"20px Courier New",scale:1,depth:40},this.getLoopText());const e="Track: "+this.level.track.data.displayName;this.trackText=this.addText({position:new o(.85*this.scene.width,.02*this.scene.height),color:"white",font:"20px Courier New",scale:1,depth:40},e);const t="Layer: "+(this.level.activeLayerIndex+1).toString()+"/"+this.level.playableLayers.length.toString();let i=J;switch(this.level.bpmIndex){case 0:i=K;break;case 1:i=j;break;case 2:i=H}Z(i!=J,"Extend the switch statement to have a difficulty text for the given track bpmIndex"),this.difficultyText=this.addText({position:new o(.85*this.scene.width,.07*this.scene.height),color:"white",font:"20px Courier New",scale:1,depth:40},"Difficulty: "+i),this.bpmText=this.addText({position:new o(.85*this.scene.width,.12*this.scene.height),color:"white",font:"20px Courier New",scale:1,depth:40},"BPM: "+this.level.track.getBPM()),this.layerText=this.addText({position:new o(.85*this.scene.width,.17*this.scene.height),color:"white",font:"20px Courier New",scale:1,depth:40},t),this.infoBackground=this.scene.add.sprite(this.scene.width,0,"trackInfoBackground").setAlpha(.3).setOrigin(1,0)}updateLoopText(){this.loopText.setText(this.getLoopText()),this.updateSkipButtonAvailability(!0)}updateSkipButtonAvailability(e){const t=ce.showSkipButton&&this.level.score.getLoopCount()>=ce.skipButtonAppearsAfterLoop&&e;this.skipButton&&ve(this.skipButton,t)}}class xe{constructor(){this.targets=[]}start(){this.destroyTargets()}destroyTarget(e){e.destroy();const t=this.targets.indexOf(e,0);t>-1&&this.targets.splice(t,1)}destroyTargets(){const e=[...this.targets];for(const t of e)this.destroyTarget(t)}addTarget(e){this.targets.push(e)}getPreviousTargets(e){return this.targets.filter((t=>t.songTime<e.songTime))}}class Te extends g{constructor(e,t,i,s,n,a,r,h){const l=new o(i.x*e.width,i.y*e.height);super(e.matter.world,l.x,l.y,a.data.spriteKeyInner,void 0,{render:{visible:!0}}),this.scene=e,this.normalizedPosition=[i.x,i.y],this.lifetime=s,this.fingerId=r,this.nodeIndex=h,this.spriteScale=ce.targetSize,this.scene.add.existing(this),this.songTime=this.lifetime+t,this.lateDuration=ce.lateTimeDuration,this.onTimeDuration=ce.onTimeDuration,this.earlyDuration=this.lifetime-this.onTimeDuration/2,this.sound=this.scene.sound.add(n,{volume:ce.pinchVolume}),this.setScale(this.spriteScale),this.setTint(f[this.fingerId]),this.setDepth(95),ve(this,!0);const d=this.displayWidth/2;this.normalizedRadius=d/e.width,this.setCircle(d,{label:a.level.trackKey+"-"+a.data.id+"-node-"+h.toString()}),this.setSensor(!0),ce.postProcessingDisabled||(this.glow=this.postFX.addGlow(I,0,0,!1,.05,24)),this.outerRing=this.scene.add.sprite(l.x,l.y,a.data.spriteKeyOuter),this.outerRing.setScale(.5*this.spriteScale),this.outerRing.setDepth(96),this.targetText=new c(this.scene,0,0,J,{}).setOrigin(.5,.5),this.addTargetText(),this.setupTweens(),this.on("destroy",(()=>{this.scene&&this.scene.hand&&this.scene.hand.removePinchCheck(this.fingerId,this),this.off("pointerdown"),this.rotateTween&&this.scene.tweens.remove(this.rotateTween),this.earlyTween&&this.scene.tweens.remove(this.earlyTween),this.onTimeTween&&this.scene.tweens.remove(this.onTimeTween),this.lateTween&&this.scene.tweens.remove(this.lateTween),this.deathTween&&this.scene.tweens.remove(this.deathTween),this.glowTween&&this.scene.tweens.remove(this.glowTween),this.glow&&this.glow.destroy(),this.targetText&&this.targetText.destroy(),this.outerRing&&this.outerRing.destroy(),this.sound&&(this.sound.isPlaying?this.sound.on("complete",(()=>{this.sound&&this.sound.destroy()})):this.sound.destroy())}))}setOnTargetMiss(e){this.onTargetMiss=e}setOnTargetHit(e){this.scene.hand.addPinchCheck(this.fingerId,this,{startPinch:e}),ce.mousePinchesEnabled&&this.once("pointerdown",e)}addTargetText(){this.targetText=this.scene.add.text(this.x,this.y,(this.nodeIndex+1).toString(),{font:"30px Courier New",color:"white"}).setOrigin(.5,.5),this.targetText.setDepth(97)}createTween(e,t,i){for(const i of e)i.tint=t.color;return this.scene.tweens.add({targets:e,displayWidth:this.displayWidth*t.scale,displayHeight:this.displayHeight*t.scale,ease:t.ease,duration:i,repeat:0})}setupTweens(){this.rotateTween=this.scene.tweens.add({targets:[this],rotation:2*Math.PI,ease:"linear",duration:1e3,repeat:-1}),this.earlyTween=this.createTween([this.outerRing],A,this.earlyDuration),this.earlyTween.on("complete",(()=>{this.onTimeTween=this.createTween([this],Object.assign(Object.assign({},N),{scale:1}),this.onTimeDuration),!ce.postProcessingDisabled&&this.glow&&(this.glowTween=this.scene.tweens.add({targets:this.glow,outerStrength:4,yoyo:!0,duration:this.onTimeDuration/2,ease:D})),this.onTimeTween.on("complete",(()=>{this.glow&&this.glow.destroy(),this.lateTween=this.createTween([this,this.outerRing],Object.assign(Object.assign({},M),{scale:1}),this.lateDuration),this.lateTween.on("complete",(()=>{ve(this,!1),this.deathTween=this.createTween([this,this.outerRing,this.targetText],F,400),this.onTargetMiss&&this.deathTween.on("complete",this.onTargetMiss)}))}))}))}}class ke{constructor(e,t){this.level=e,this.data=t}getDuration(){return this.level.track.songTimePositionToTime({bar:this.data.lengthInBars+1,step:1,tick:0})}}class Se extends ke{constructor(e,t,i){super(t,i),this.nextNodeIndex=0,this.songTime_=0,this.oldTimePosition=0,this.startTime=0,this.time=0,this.ready=!1,this.scene=e,this.data=i,this.targetManager=new xe}init(e){this.scene=e,this.metronome=new ye(this.scene),this.progress=new fe(this.scene),this.infoHud=new be(this.scene,this.level)}get songTime(){return this.songTime_}unload(){this.infoHud&&this.infoHud.destroy()}start(e){this.targetManager.start(),this.level.score.delay=e,this.ready=!0,this.startTime=this.time+e,this.nextNodeIndex=0,this.oldTimePosition=0;const t=Math.max(this.data.previewTime.bar,1),i=[];this.data.nodes.forEach(((e,t)=>{const s=ce.indexFingerOnly?x:e.finger;i.push(f[s])})),this.progress.setup(0,this.data.nodes.length,this.data.progressCount,i),this.metronome.setup(),this.infoHud.setup(),this.progress.setVisible(!0),this.infoHud.setVisible(!0),this.metronome.play(this.level.track.data.timeSignatureNumerator,this.level.track.beatLength,t)}createTarget(e,t,i){const s=ce.indexFingerOnly?x:e.finger,n=new Te(this.scene,this.songTime_,new o(e.normalizedPosition[0],e.normalizedPosition[1]),this.getPreviewTime(),this.level.track.getSoundKey(this.data,e.soundKey),this,s,i);n.setOnTargetMiss((()=>{this.level.score.missedPinch(n),this.progress.changeBy(-1),this.progress.redraw(),this.level.streak.stop(),this.targetManager.destroyTarget(n),this.checkForTransition(t,i)})),n.setOnTargetHit((()=>{const e=this.targetManager.getPreviousTargets(n);for(const i of e)Z(i!=n),this.progress.changeBy(-1),this.level.score.skippedPinch(i),this.checkForTransition(t,i.nodeIndex),this.targetManager.destroyTarget(i);e.length>0&&this.level.streak.stop();const s=this.songTime-n.songTime,o=n.onTimeDuration/2,a=s>o;s<-o?(this.level.streak.stop(),this.progress.changeBy(0),this.level.score.earlyPinch(n,this.songTime)):a?(this.level.streak.stop(),this.progress.changeBy(0),this.level.score.latePinch(n,this.songTime)):(this.level.streak.changeBy(1),this.progress.changeBy(1),this.level.score.onTimePinch(n,this.songTime,this.level.streak.current)),this.progress.redraw(),this.level.streak.check(),ce.sonificationEnabled&&n.sound.play({volume:ce.pinchVolume}),this.targetManager.destroyTarget(n),this.checkForTransition(t,i)})),this.targetManager.addTarget(n)}checkForTransition(e,t){t==this.data.nodes.length-1&&this.level.activeLayerIndex==e&&(ce.skipLayersAutomatically&&this.level.score.getLoopCount()>=ce.skipLayersAutomaticallyAfterLoop||this.progress.canProgress()&&!ce.disableLayerProgression?this.level.transitionLayers():(this.level.score.incrementLoopCount(),this.progress.setToStarting(),this.infoHud.updateLoopText(),ce.autoSaveCSV&&pe(this.level.score.levelStats)))}handleTargetCreation(){if(!this.ready)return;const e=this.getDuration();let t=this.songTime_+this.getPreviewTime();if(this.songTime_>0&&(t%=e),this.data.nodes.length<=this.nextNodeIndex){if(!(t<this.oldTimePosition))return;this.nextNodeIndex=0}const i=this.data.nodes[this.nextNodeIndex];this.level.track.songTimePositionToTime(i.timePosition)%e<=t&&(null!=i.finger&&this.createTarget(i,this.level.activeLayerIndex,this.nextNodeIndex),this.nextNodeIndex++),this.oldTimePosition=t}preDelayStop(){this.ready=!1,this.metronome.stop(),this.targetManager.destroyTargets()}postDelayStop(){this.infoHud.setVisible(!1),this.progress.setVisible(!1)}stop(){this.preDelayStop(),this.postDelayStop()}update(e){this.time=e,this.songTime_=this.ready?this.time-this.startTime:0,this.handleTargetCreation()}getPreviewTime(){return this.level.track.songTimePositionToTime({bar:this.data.previewTime.bar+1,step:this.data.previewTime.step+1,tick:this.data.previewTime.tick})}}class Pe extends l{constructor(e){super(e,"streak"),this.current_=0,this.onFire=!1,this.hsv=Phaser.Display.Color.HSVColorWheel(),this.streakText=this.scene.add.text(.05*e.width,.05*e.height,J,{font:z.font,color:z.color}).setOrigin(.5,.5).setVisible(!1).setScale(z.scale).setDepth(z.depth).setStroke(z.color,z.strokeThickness).setShadow(z.shadowOffset.x,z.shadowOffset.y,z.shadowColor,z.shadowBlurRadius,!0,!0),this.on("destroy",(()=>{this.onFireTween&&this.onFireTween.destroy(),this.flame&&this.flame.destroy(),this.streakText&&this.streakText.destroy()}))}get current(){return this.current_}changeBy(e){this.current_=Math.max(0,this.current+e)}check(){1===this.current_?this.start():this.current_>1?this.continue():this.stop()}updateStreakText(){this.streakText.setText("Streak: "+this.current_.toString())}start(){this.updateStreakText(),this.streakText.setVisible(!0)}stop(){this.current_=0,this.onFire=!1,this.onFireTween&&this.scene.tweens.remove(this.onFireTween),this.streakText&&this.streakText.clearTint(),this.streakText&&this.streakText.setVisible(!1),this.flame&&this.flame.destroy()}continue(){this.updateStreakText();const e=this.onFire;this.onFire=this.current_>=2,!e&&this.onFire&&(Z(!0,"Streak color wheel extent must be from 1 to 255"),this.onFireTween=this.scene.tweens.addCounter({from:0,to:30,duration:1e3,yoyo:!0,onUpdate:e=>{if(this&&this.hsv){const t=Math.floor(e.getValue()),i=this.hsv[t].color,s=this.hsv[30-t].color;this.streakText&&this.streakText.setTint(i,i,s,s)}},onStop:()=>{this.onFireTween&&this.scene.tweens.remove(this.onFireTween)}}),ce.postProcessingDisabled||(this.flame&&this.flame.destroy(),this.streakText&&(this.flame=this.scene.add.particles(this.streakText.x,this.streakText.y,"flare",_),Z(0!=z.depth),this.flame.setDepth(z.depth-1))))}}class Ce{constructor(){this.total=1,this.required=1,this.correct=0,this.early=0,this.late=0,this.miss=0,this.loop=1,this.hits=[]}}class Le{constructor(e){this.maxStreak=0,this.layersStats=[],this.id=`${e.data.displayName.replace(/\s/g,"")}@${e.getBPM()}bpm_${(new Date).toLocaleString("en-GB").replace(/\s/g,"").replace(/,/g,"_").replace(/[:/]/g,"-")}`}}class Be{constructor(e,t){this.scene=e,this.levelStats=new Le(t),this.layerStats=new Ce}getLoopCount(){return this.layerStats.loop}incrementLoopCount(){this.layerStats.correct=0,this.layerStats.early=0,this.layerStats.late=0,this.layerStats.miss=0,this.layerStats.loop++}saveLayerScores(){this.levelStats.layersStats.push(this.layerStats)}resetLayerScores(e,t){this.layerStats=new Ce,this.layerStats.total=e,this.layerStats.required=t}addHit(e,t,i){this.layerStats.hits.push({loopNumber:this.getLoopCount(),noteID:e.nodeIndex+1,pinchType:e.fingerId,correctTime:e.songTime+this.delay,playerTime:t,classification:i,normalizedTargetRadius:e.normalizedRadius,normalizedTargetPosition:e.normalizedPosition,normalizedFingerRadius:this.scene.hand.getNormalizedFingerRadius(),normalizedPinkyFingerPosition:this.scene.hand.getNormalizedFingerPosition(S),normalizedRingFingerPosition:this.scene.hand.getNormalizedFingerPosition(k),normalizedMiddleFingerPosition:this.scene.hand.getNormalizedFingerPosition(T),normalizedIndexFingerPosition:this.scene.hand.getNormalizedFingerPosition(x),normalizedThumbFingerPosition:this.scene.hand.getNormalizedFingerPosition(b)})}onTimePinch(e,t,i){this.addHit(e,t+this.delay,"correct"),this.layerStats.correct++,this.levelStats.maxStreak=Math.max(i,this.levelStats.maxStreak)}earlyPinch(e,t){this.addHit(e,t+this.delay,"early"),this.layerStats.early++}latePinch(e,t){this.addHit(e,t+this.delay,"late"),this.layerStats.late++}skippedPinch(e){this.addHit(e,-1e3,"skipped"),this.layerStats.miss++}missedPinch(e){this.addHit(e,-1e3,"missed"),this.layerStats.miss++}}class Ee{constructor(e,t){this.trackKey_=J,this.finishCallback=()=>{},this.abortCallback=()=>{},this.activeLayerIndex=0,this.playableLayers=[],this.activeAudioTracks=[],this.bpmIndex_=-1,this.scene=e,this.trackKey_=t,this.track=new me(e,this.trackKey_)}preload(e){this.scene=e,this.preloadPreview(),this.track.preload(e),this.preloadLayers()}unload(){this.track.unload()}setBPM(e){Z(-1!=e,"BPM must be set before starting the level"),this.track.setBPM(e),this.bpmIndex_=e}get bpmIndex(){return this.bpmIndex_}get trackKey(){return this.trackKey_}init(e){this.scene=e,this.streak=new Pe(this.scene),this.score=new Be(e,this.track),this.playableLayers.forEach((e=>{e.init(this.scene)}))}getBackgroundTextureKey(){return this.trackKey+"/background.png"}getPreviewVideoKey(){return this.trackKey+"/preview.mp4"}hasCustomBackground(){return this.scene.textures.exists(this.getBackgroundTextureKey())}hasPreviewVideo(){return this.scene.cache.video.has(this.getPreviewVideoKey())}preloadPreview(){const e=p+this.getPreviewVideoKey(),t=p+this.getBackgroundTextureKey();this.scene.load.video(this.getPreviewVideoKey(),ee(e),!0),this.scene.load.image(this.getBackgroundTextureKey(),ee(t))}preloadLayers(){this.playableLayers=[],this.track.forEachLayer(void 0,((e,t)=>{const i=new Se(this.scene,this,e);this.playableLayers.push(i)}))}unloadLayers(){this.playableLayers.forEach((e=>{e.unload()})),this.track.unload()}start(e,t){this.activeLayerIndex=0,this.removeBackgroundAudio(),this.playableLayers.forEach((e=>{e.stop()})),this.streak.stop(),this.setBPM(this.bpmIndex_),this.finishCallback=e,this.abortCallback=t,this.scene.time.delayedCall(1e3,(()=>{this.startLayer()}))}addBackgroundAudio(e,t,i){Z(-1!=this.bpmIndex_,"Set BPM before adding background audio to level"),this.removeBackgroundAudio(),this.activeAudioTracks=this.track.addBackgroundAudioTracks(e,t,this.bpmIndex_,i)}removeBackgroundAudio(){this.activeAudioTracks.forEach((e=>{e.stop(),this.scene.sound.remove(e)})),this.activeAudioTracks=[]}playBackgroundAudio(){this.activeAudioTracks.forEach((e=>{e.setMute(!1),e.play()}))}setBackgroundAudioMute(e){this.activeAudioTracks.forEach((t=>{t.setMute(e)}))}startLayer(){const e=this.getActiveLayer(),t=this.activeLayerIndex;this.score.resetLayerScores(e.data.nodes.length,e.data.progressCount);const i=this.track.songTimePositionToTime({bar:2,step:1,tick:0}),s=Math.max(i,e.getPreviewTime());e.start(s);const n=[...e.data.backgroundLayers];ce.synchronizationEnabled&&n.push(e.data.id),this.addBackgroundAudio(this.scene,{loop:!0,volume:ce.backgroundMusicVolume},((e,t)=>n.includes(e.id))),this.scene.time.delayedCall(s,(()=>{this.activeLayerIndex==t&&this.playBackgroundAudio()}))}getActiveLayer(){return Z(this.activeLayerIndex<this.playableLayers.length,"Active layer index cannot exceed number of playable layers"),this.playableLayers[this.activeLayerIndex]}transitionLayers(){if(ce.autoSaveCSV&&pe(this.score.levelStats),this.activeLayerIndex<this.playableLayers.length){const e=this.getActiveLayer();e.preDelayStop(),this.removeBackgroundAudio(),this.activeLayerIndex++;const t=this.activeLayerIndex;if(this.activeLayerIndex>=this.playableLayers.length)return this.score.saveLayerScores(),e.postDelayStop(),void this.end();this.scene.time.delayedCall(1e3,(()=>{this.activeLayerIndex==t&&(this.score.saveLayerScores(),e.postDelayStop(),this.startLayer())}))}}stop(){this.removeBackgroundAudio(),this.streak.stop()}end(){this.stop(),this.finishCallback()}abort(){ce.autoSaveCSV&&(this.score.saveLayerScores(),pe(this.score.levelStats)),this.stop(),this.abortCallback()}update(e){this.activeLayerIndex<this.playableLayers.length&&this.getActiveLayer().update(e)}getAudioLoopTime(){return Z(this.activeAudioTracks.length>=1,"Cannot retrieve audio loop time when there are no active audio tracks"),this.activeAudioTracks.at(-1).duration}}var Oe=function(e,t,i,s){return new(i||(i=Promise))((function(n,o){function a(e){try{h(s.next(e))}catch(e){o(e)}}function r(e){try{h(s.throw(e))}catch(e){o(e)}}function h(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,r)}h((s=s.apply(e,t||[])).next())}))};let Ie;const De=[];let Ae=0;class Ne extends g{get normalizedPosition(){return this.normalizedPosition_}updatePosition(e,t){this.normalizedPosition_=[e,t],this.setPosition(e*this.scene.scale.width,t*this.scene.scale.height)}constructor(e,t,i,s,n="finger"){super(e.matter.world,0,0,n,void 0,{render:{visible:!0}}),this.normalizedPosition_=null,this.name=t,this.landmarkIndex=i,this.scene.add.existing(this),this.setScale(s),this.setTint(f[this.name]),this.setDepth(100);const o=this.displayWidth/2;this.normalizedRadius=o/e.scale.width,this.setCircle(o,{label:this.name}),this.setSensor(!0),ve(this,!1)}}var Me,Fe;!function(e){e[e.hover=0]="hover",e[e.pinch=1]="pinch"}(Me||(Me={})),function(e){e[e.start=0]="start",e[e.continue=1]="continue",e[e.end=2]="end"}(Fe||(Fe={}));class Ve extends l{constructor(e){super(e,"hand"),this.fingers=[],this.observers_=[],this.fingers=[],this.observers_=[];const t=(e,t)=>{const i=new Ne(this.scene,e,t,.3*ce.fingerSize);return this.fingers.push(i),i},i=t(b,4),s=(t(x,8),t(T,12),t(k,16),t(S,20),(e,t)=>{e((e=>{const s=this.getFinger(e.bodyB.label);if(null!=s)for(const e of this.observers)e.fingerName==s.name&&e.object&&e.object.input&&e.object.input.enabled&&e.object.emit(s.name+Me.pinch+t);else if(e.bodyB.gameObject){const s=e.bodyB.gameObject;for(const n of this.fingers){if(n==i)continue;const o={object:s,fingerName:n.name};if(!this.isObserver(o))continue;const a=this.scene.matter.overlap(e.bodyB,[n]);if(t===Fe.start&&a)s.emit(n.name+Me.hover+Fe.start),this.setObserverHover(o,!0);else if(t===Fe.continue){const e=this.wasObserverHovering(o);a&&e?(s.emit(n.name+Me.hover+Fe.continue),this.setObserverHover(o,!0)):a&&!e?(s.emit(n.name+Me.hover+Fe.start),this.setObserverHover(o,!0)):!a&&e&&(s.emit(n.name+Me.hover+Fe.end),this.setObserverHover(o,!1))}else t===Fe.end&&this.wasObserverHovering(o)&&(s.emit(n.name+Me.hover+Fe.end),this.setObserverHover(o,!1))}}}))});s(i.setOnCollide.bind(i),Fe.start),s(i.setOnCollideActive.bind(i),Fe.continue),s(i.setOnCollideEnd.bind(i),Fe.end),this.on("destroy",(()=>{for(const e of this.fingers)e&&e.destroy()}))}getNormalizedFingerRadius(){for(const e of this.fingers)if(e)return e.normalizedRadius;return null}getNormalizedFingerPosition(e){const t=this.getFinger(e);return void 0===t?null:t.normalizedPosition}getFinger(e){const t=this.fingers.findIndex((t=>t.name==e));if(-1!==t)return this.fingers[t]}getFingersOtherThan(e){const t=[];for(const i of this.fingers)i&&i.name==e||t.push(i);return t}get observers(){return this.observers_}isObserver(e){return null!=this.observers_.find((t=>t.fingerName===e.fingerName&&t.object==e.object))}wasObserverHovering(e){return Z(this.isObserver(e)),this.observers_.find((t=>t.fingerName===e.fingerName&&t.object==e.object)).wasHovering}setObserverHover(e,t){const i=this.observers_.findIndex((t=>t.fingerName===e.fingerName&&t.object==e.object));Z(-1!==i,"Cannot set observer hover before observer is pushed"),this.observers_[i].wasHovering=t}pushNewObserversOnly(e){this.isObserver(e)||(this.observers.push(e),this.setObserverHover(e,!1))}removeObserver(e){const t=this.observers_.findIndex((t=>t.fingerName===e.fingerName&&t.object==e.object));t>-1&&this.observers_.splice(t,1)}setFingerScale(e){for(const t of this.fingers)t.setScale(.3*e)}addPinchCheck(e,t,i){this.pushNewObserversOnly({object:t,fingerName:e});const s=e=>{const i=this.getFinger(b),s=this.getFinger(e);if(void 0===i)return!1;if(void 0===s)return!1;const n=this.scene.matter.overlap(t,[i]),o=this.scene.matter.overlap(t,[s]);return n&&o},n=e=>{const t=this.getFingersOtherThan(e),i=this.getFinger(b);if(void 0===i)return!1;for(const e of t)if(e!=i&&void 0!==e&&this.scene.matter.overlap(i,[e]))return!0;return!1};i.startPinch&&t.on(e+Me.pinch+Fe.start,(()=>{var t;s(e)&&(!ce.ignoreMultifingerPinches||ce.ignoreMultifingerPinches&&!n(e))&&(null===(t=i.startPinch)||void 0===t||t.call(i))})),i.pinched&&t.on(e+Me.pinch+Fe.continue,(()=>{var t;s(e)&&(!ce.ignoreMultifingerPinches||ce.ignoreMultifingerPinches&&!n(e))&&(null===(t=i.pinched)||void 0===t||t.call(i))})),i.endPinch&&t.on(e+Me.pinch+Fe.end,(()=>{var t;s(e)&&(!ce.ignoreMultifingerPinches||ce.ignoreMultifingerPinches&&!n(e))&&(null===(t=i.endPinch)||void 0===t||t.call(i))})),i.startHover&&t.on(e+Me.hover+Fe.start,(()=>{var e;null===(e=i.startHover)||void 0===e||e.call(i)})),i.hovering&&t.on(e+Me.hover+Fe.continue,(()=>{var e;null===(e=i.hovering)||void 0===e||e.call(i)})),i.endHover&&t.on(e+Me.hover+Fe.end,(()=>{var e;null===(e=i.endHover)||void 0===e||e.call(i)}))}removePinchCheck(e,t){this.removeObserver({fingerName:e,object:t}),t.off(e+Me.pinch+Fe.start),t.off(e+Me.pinch+Fe.continue),t.off(e+Me.pinch+Fe.end),t.off(e+Me.hover+Fe.start),t.off(e+Me.hover+Fe.continue),t.off(e+Me.hover+Fe.end)}update(){this.observers_=this.observers_.filter((e=>null!=e)),oe.update();const e=this.scene.matter.add.circle(this.scene.input.mousePointer.x,this.scene.input.mousePointer.y,1,{circleRadius:1,isSensor:!0,render:{visible:!1}});for(const t of this.fingers){const i=oe.getNormalizedLandmarkPosition(t.landmarkIndex),s=null!=i;if(s&&t.updatePosition(i.x,i.y),ve(t,s),!s&&e)for(const i of this.observers)null!=e&&null!=i.object&&i.object.active&&null!=this.scene&&(i.object.emit(t.name+Me.pinch+Fe.end),this.scene.matter.overlap(e,[i.object])||i.object.emit(t.name+Me.hover+Fe.end))}this.scene.matter.world.remove(e)}calculateHandDistance(e=0){const t=oe.getNormalizedLandmarkPosition(5,e),i=oe.getNormalizedLandmarkPosition(17,e),s=oe.getNormalizedLandmarkPosition(0,e);let n=0,a=0;if(null!=t&&null!=i){const e=new o((t.x+i.x)/2,(t.y+i.y)/2);n=i.distanceSq(t),null!=s&&(a=s.distanceSq(e))}if(0==n||0==a)return 0;let r=Math.max(Math.sqrt(n)/8.2,Math.sqrt(a)/10);return r*=10,8.2*.7/r}}const ze=new Set([[0,1],[0,5],[9,13],[13,17],[5,9],[0,17],[1,2],[2,3],[3,4],[5,6],[6,7],[7,8],[9,10],[10,11],[11,12],[13,14],[14,15],[15,16],[17,18],[18,19],[19,20]]);class _e extends u{constructor(e){super(e),this.bg=document.getElementById("background_image")}preload(){}enableCamera(e,t){ie.setVisibility(e),this.setOpacity(t)}create(){this.width=this.scale.width,this.height=this.scale.height,this.center=new o(this.width/2,this.height/2),this.enableCamera(ce.enableCameraVisibility,ce.cameraOpacity),Ie.setVisible(!1),document.getElementById("background_image"),this.bg.style.opacity="1",this.setBackgroundTexture("background"),Ie.clearTint(),this.sound.pauseOnBlur=!1,this.graphicsObject=this.add.graphics(),this.graphicsObject.setDepth(99),this.hand=new Ve(this),this.input.topOnly=!1}update(e,t){ie.video.width=this.game.canvas.clientWidth,ie.video.height=this.game.canvas.clientHeight,this.graphicsObject.clear(),this.hand.update(),function(e,t,i=0){e.setDepth(99),oe.forEachNormalizedLandmarkPosition((i=>{const s=new o(e.scene.scale.width,e.scene.scale.height);i.multiply(s),e.lineStyle(t.lineWidth,t.color,t.alpha)}),i)}(this.graphicsObject,w,0),function(e,t,i=0){e.setDepth(98),ze.forEach((s=>{const n=oe.getNormalizedLandmarkPosition(s[0],i);if(null!=n){const a=oe.getNormalizedLandmarkPosition(s[1],i);if(null!=a){const i=new o(e.scene.scale.width,e.scene.scale.height),s=n.multiply(i),r=a.multiply(i);e.lineStyle(t.lineWidth,t.color,t.alpha),e.lineBetween(s.x,s.y,r.x,r.y)}}}))}(this.graphicsObject,v,0)}setOpacity(e){if(null==e)return;Z(e>=0&&e<=1);const t=1-e;Ie&&Ie.setAlpha(t),this.bg&&(this.bg.style.opacity=t.toString())}setBackgroundTexture(e){this.bg&&(this.bg.style.backgroundSize="0 0"),Ie&&(Ie.setTexture(e),Ie.setDisplaySize(this.width,this.height),Ie.setVisible(!0))}}let Re=!1;class Ke extends we{constructor(e,t,i,s,n=()=>{},o,a,r=!1,h="pinch"){super(e,t,i,s,n,o,h),this.spriteKey=o,this.toggledSpriteKey=a,this.toggleState=r,this.setTexture(this.getSpriteKey()),this.on("destroy",(()=>{this.scene.hand.removePinchCheck(C,this),this.sound&&(this.sound.isPlaying?this.sound.on("complete",(()=>{this.sound&&this.sound.destroy()})):this.sound.destroy()),this.text&&(this.text.destroy(),this.text=void 0)}))}setToggleState(e){var t;this.toggleState=e,this.setTexture(this.getSpriteKey()),null===(t=this.toggleCallback)||void 0===t||t.call(this,this.toggleState)}addToggleCallback(e){this.toggleCallback=e,this.toggleCallback(this.toggleState)}toggle(){var e;this.toggleState=!this.toggleState,this.setTexture(this.getSpriteKey()),null===(e=this.toggleCallback)||void 0===e||e.call(this,this.toggleState)}getToggleState(){return this.toggleState}updateTint(){this.toggleState?this.setTintFill(E):this.clearTint()}getSpriteKey(){return this.toggleState?this.spriteKey:this.toggledSpriteKey}}class je extends Ke{constructor(e,t,i,s,n,o,a=()=>{},r,h,l=!1,d="pinch"){super(i,s,n,o,a,r,h,l,d),this.resetTint=!1,this.bpmIndex_=e,this.bpm=t;const c=this.getCenter();this.bpmText=this.scene.add.text(c.x,c.y+30,"BPM: "+this.bpm.toString(),{font:"20px Courier New"}).setOrigin(.5,.5),this.text&&(this.text.y-=10),this.updateTint(),this.on("destroy",(()=>{this.scene.hand.removePinchCheck(C,this),this.sound&&(this.sound.isPlaying?this.sound.on("complete",(()=>{this.sound&&this.sound.destroy()})):this.sound.destroy()),this.text&&(this.text.destroy(),this.text=void 0),this.bpmText&&this.bpmText.destroy()}))}updateTint(){this.toggleState?(this.text&&this.text.setTintFill(O),this.bpmText.setTintFill(O),this.setTintFill(E)):(this.text&&this.text.clearTint(),this.bpmText.clearTint(),this.clearTint())}get bpmIndex(){return this.bpmIndex_}}var He=n().Math.Vector2,$e=n().Math.RoundTo;class Ge extends r{constructor(e,t,i,s,n,o,a,r,h){super(e),this.isDragging=!1,this.range=new He(0,1),this.isInteger=!1,this.x=t.x,this.y=t.y,this.width=i.x,this.height=i.y,this.key=o,this.updateSliderCallback=r,this.range=a,this.value=.5,this.box=new d(0,0,i.x,i.y),this.handle=new d(0,0,i.y,i.y),this.updateHandle(),s&&(this.label=this.scene.add.text(this.x+s.x,this.y+s.y,J,{color:"#ffffff",fontSize:"24px"})),this.setInteractive(this.box,d.Contains),this.on("pointerdown",this.startDrag,this),this.scene.input.on("pointerup",(()=>{this.stopDrag(),null==h||h()}),this),this.scene.input.on("pointermove",this.doDrag,this),Z("number"==typeof n[this.key],"Type must be number, instead it was: "+typeof n[this.key]),this.setValue(n[this.key]),this.draw(),this.on("destroy",(()=>{this.label&&this.label.destroy()}))}reset(e){Z("number"==typeof e[this.key],"Type must be number"),this.setValue(e[this.key]),this.draw()}startDrag(){this.isDragging=!0}doDrag(e){this.isDragging&&(this.value=n().Math.Clamp((e.x-this.x-this.handle.width/2)/(this.width-this.handle.width),0,1),this.updateHandle(),this.draw())}stopDrag(){this.isDragging=!1}updateHandle(){this.handle.x=this.value*(this.width-this.handle.width)}draw(){this.clear(),this.input&&(this.input.enabled||this.setInteractive(this.box,d.Contains),this.updateSliderCallback(this)),this.fillStyle(11184810),this.fillRectShape(this.box),this.fillStyle(16777215),this.fillRectShape(this.handle)}getStringValue(){const e=this.getValue();return this.isInteger?e.toFixed(0):e.toFixed(2)}getValue(){const e=this.value*(this.range.y-this.range.x)+this.range.x;return this.isInteger?$e(e,0):e}setIsInteger(e){return this.isInteger=e,this.draw(),this}setValue(e){this.value=(e-this.range.x)/(this.range.y-this.range.x),this.updateHandle(),this.draw()}hide(e){return this.clear(),this.input&&this.disableInteractive(),this.label&&this.label.active&&(e?this.label.setText(e):this.label.setText("")),this}}class qe extends r{constructor(e,t,i,s,n,o,a,r){super(e),this.labelText=J,this.x=t.x,this.y=t.y,this.key=a,s&&(this.labelText=n,this.label=this.scene.add.text(t.x+s.x,t.y+s.y,this.labelText,{color:"#ffffff",fontSize:"24px"})),this.toggleCallback=r,Z("boolean"==typeof o[this.key]),this.isChecked_=o[this.key],this.box=new d(0,0,i,i),this.check=new d(.25*i,.25*i,.5*i,.5*i),this.setInteractive(this.box,d.Contains),this.toggleCallback(this),this.on("pointerdown",this.toggleCheck,this),this.draw(),this.on("destroy",(()=>{this.label&&this.label.destroy()}))}reset(e){Z("boolean"==typeof e[this.key]),this.isChecked_=e[this.key],this.toggleCallback(this),this.draw()}resetLabel(){this.label&&this.label.setText(this.labelText)}setLabel(e){this.label&&this.label.setText(e),this.draw()}toggleCheck(){this.isChecked_=!this.isChecked_,this.toggleCallback(this),this.draw()}draw(){this.clear(),this.input&&!this.input.enabled&&this.setInteractive(this.box,d.Contains),this.lineStyle(2,16777215),this.strokeRectShape(this.box),this.isChecked_&&(this.fillStyle(16777215),this.fillRectShape(this.check))}setToggled(e){"boolean"==typeof e&&(this.isChecked_=e,this.toggleCallback(this),this.draw())}hide(){return this.clear(),this.disableInteractive(),this.label&&this.label.setText(""),this}get isChecked(){return this.isChecked_}}var We=i(223),Ue=i(43),Ye=i(769),Xe=function(e,t,i,s){return new(i||(i=Promise))((function(n,o){function a(e){try{h(s.next(e))}catch(e){o(e)}}function r(e){try{h(s.throw(e))}catch(e){o(e)}}function h(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,r)}h((s=s.apply(e,t||[])).next())}))};let Je,Ze;const Qe={type:n().WEBGL,width:1920,height:1080,scale:{mode:n().Scale.ScaleModes.HEIGHT_CONTROLS_WIDTH,autoCenter:n().Scale.CENTER_BOTH},transparent:!0,physics:{default:"matter",matter:{debug:!1,gravity:{x:0,y:0}}},scene:[class extends u{constructor(){super("electron")}create(){return Oe(this,void 0,void 0,(function*(){yield new Promise(((e,t)=>{e()})).then((()=>{this.scene.start("loading")}))}))}},class extends u{constructor(){super({key:"loading",pack:{files:[{type:"json",key:"levelList",url:ee(m)},{type:"json",key:"defaultConfig",url:ee("data/default_config.json")}]}})}preload(){this.load.image("finger",ee("assets/sprites/finger.png")),this.load.image("button",ee("assets/ui/button.png")),this.load.image("targetOuter",ee("assets/sprites/target_outer.png")),this.load.image("targetInner",ee("assets/sprites/target_inner.png")),this.load.audio("pinch",ee("assets/sounds/ui/menu_ding.mp3")),this.load.image("title",ee("assets/ui/title.png")),this.load.image("background",ee("assets/ui/background.png")),this.load.image("levelBackground",ee("assets/ui/level_background.png")),this.load.image("levelChange",ee("assets/ui/level_change.png")),this.load.image("mute",ee("assets/ui/mute.png")),this.load.image("unmute",ee("assets/ui/unmute.png")),this.load.image("videoBackground",ee("assets/ui/video_background.png")),this.load.image("optionsBackground",ee("assets/ui/options_background.png")),this.load.image("calibrationBackground",ee("assets/ui/calibration_background.png")),this.load.image("defaultVideoBackground",ee("assets/ui/default_video_background.png")),this.load.image("songNameBackground",ee("assets/ui/song_name_background.png")),this.load.image("trackInfoBackground",ee("assets/ui/track_info_background.png")),this.load.image("countdown",ee("assets/sprites/countdown.png")),this.load.audio("metronomeHigh",ee("assets/sounds/metronome/high.mp3")),this.load.audio("metronomeLow",ee("assets/sounds/metronome/low.mp3")),this.load.image("scoreboardBackground1",ee("assets/ui/scoreboard_background1.png")),this.load.image("scoreboardBackground2",ee("assets/ui/scoreboard_background2.png")),this.load.image("progressSegment",ee("assets/ui/progress_segment.png")),this.load.image("flare",ee("assets/sprites/flare.png")),this.load.image("flare",ee("assets/sprites/flare.png")),this.cache.json.get("levelList").forEach(((e,t)=>{De.push(new Ee(this,e))}))}create(){return Oe(this,void 0,void 0,(function*(){Ie=this.add.sprite(this.scale.width/2,this.scale.height/2,"background").setVisible(!1);const e=this.add.text(this.scale.width/2,this.scale.height/2,"",{font:"50px Courier New",color:"#00ff00"}).setOrigin(.5,.5).setShadow(1,1).setDepth(1e3);var t;yield ie.init(U,this.game.canvas.clientWidth,this.game.canvas.clientHeight,this.updateText.bind(this,e)).catch((t=>{this.updateText(e,t)})),ie.found()&&(yield oe.init(this.updateText.bind(this,e)).catch((t=>this.updateText(e,t))),oe.found()&&(ie.setVisibility(U.visible),yield ut().then((e=>{console.info("INFO: Week number: "+e.toString()),Ae=e})).catch((t=>this.updateText(e,t))),this.scene.launch(q),oe.precache(this.updateText.bind(this,e)),this.updateText(e,"LOADING CONFIG DATA..."),Z(this.cache.json.has("defaultConfig"),"Failed to load default config data"),t=this.cache.json.get("defaultConfig"),de=t,console.info("INFO: Default config set to:"),console.info(de),Ze?yield ct().then((e=>{const[t,i]=e;console.info('INFO: Playing as "'+at()+'" with config: "'+i+'"'),ue(t)})).catch((t=>{this.updateText(e,t)})):ue(de),this.updateText(e,"LOADING GAME DATA..."),this.scene.get(q).load.on("complete",(()=>{this.updateText(e,"STARTING INITIAL SCENE..."),e&&e.destroy()}))))}))}updateText(e,t){console.info("INFO: "+t);let i=t;t instanceof DOMException&&(i="NotFoundError"==t.name?"WEBCAM NOT FOUND":"PermissionError"==t.name?"WEBCAM PERMISSION DENIED":"NotADirectoryError"==t.name?t.message:t.name+": "+t.message),e.setText(i)}},class extends _e{constructor(){super("mainMenu")}preload(){De.forEach((e=>{e.preload(this)}))}create(){super.create(),De.forEach((e=>{e.setBPM(0)})),this.calibration=new we(this,"SETUP\nCAMERA",this.center.x-500,800,(()=>{this.scene.start("calibration")})),this.options=new we(this,"OPTIONS",this.center.x+500,800,(()=>{this.scene.start("options")})),this.levelSelect=new we(this,"SELECT\nLEVEL",this.center.x,800,(()=>{this.scene.start("levelSelect")})),this.title=this.add.sprite(this.center.x,360,"title")}update(e,t){super.update(e,t)}},class extends _e{constructor(){super("continueScene"),this.index=0,this.sequence=[]}getLevel(e){const t=De.filter((t=>t.trackKey==e));return Z(0!=t.length,"Failed to find level with track key: "+e),Z(1==t.length,"Found multiple levels identical track key: "+e),t[0]}preload(){super.preload(),De.forEach((e=>{e.preload(this)})),this.sequence=this.getTestSequence(),Z(2==this.sequence.length,"Failed to identify test sequence")}getTestSequence(){return Z(null!=Je,"Failed to identify current user number"),Math.floor((Je-1)/4)%2==0?["Trained","Untrained"]:["Untrained","Trained"]}create(e){let t,i;super.create(),Re&&(ce.autoSaveCSV&&pe(e.score.levelStats),this.index++),Re=!1,this.getLevel("Tryout").setBPM(0),this.getLevel("Trained").setBPM(2),this.getLevel("Untrained").setBPM(2),this.getLevel("Nosound").setBPM(2);const s=(e,s)=>{i=this.getLevel(e),t="START\n"+s.toUpperCase()};let n="Invalid Week";if(0==Ae)0==this.index?(n="TRYOUT",ce.skipLayersAutomaticallyAfterLoop=2,s("Tryout",n)):1==this.index?(n="PRETEST 1",s(this.sequence[0],n),ce.skipLayersAutomaticallyAfterLoop=8):2==this.index?(n="PRETEST 2",s(this.sequence[1],n),ce.skipLayersAutomaticallyAfterLoop=8):this.index>=3&&(n="PRETESTS COMPLETED");else if(Ae>=1&&Ae<=3){if(n="WEEK "+Ae.toString()+" TRAINING",0==this.index?(ce.skipLayersAutomaticallyAfterLoop=16,i=this.getLevel("Trained"),t="START WEEK "+Ae.toString()+"\n"+"TRAINING".toUpperCase()):(n="TRAINING SESSION COMPLETED",Ze&&dt().then((e=>{console.info("INFO: "+e)})).catch((e=>{console.info("ERROR: "+e)}))),i)switch(Ae){case 1:i.setBPM(0);break;case 2:i.setBPM(1);break;case 3:i.setBPM(2)}}else-1==Ae?(ce.skipLayersAutomaticallyAfterLoop=8,0==this.index?(n="POSTTEST 1",s(this.sequence[0],n)):1==this.index?(n="POSTTEST 2",s(this.sequence[1],n)):2==this.index?(ce.sonificationEnabled=!1,ce.synchronizationEnabled=!1,ce.pinchVolume=0,ce.backgroundMusicVolume=0,n="POSTTEST 3",s("Nosound",n)):n="POSTTESTS COMPLETED"):n="Thanks for participating!";this.title=this.add.text(this.center.x,360,n,{font:"110px Courier New",color:"white"}).setOrigin(.5,.5),t&&(this.start=new we(this,t,this.center.x+330,800,(()=>{i&&this.scene.start("level",i)})),this.calibration=new we(this,"SETUP\nCAMERA",this.center.x-330,800,(()=>{this.scene.start("calibration")})))}update(e,t){super.update(e,t)}},class extends _e{constructor(){super("options"),this.options=[]}saveAndExit(){ie.setVisibility(ce.enableCameraVisibility),this.rotateTween&&this.rotateTween.destroy(),this.glowTween&&this.glowTween.destroy(),this.glow&&this.glow.destroy(),this.scene.start("mainMenu")}create(){super.create(),this.onTimeDurationLimits=new o(50,1e3),this.createOptions()}normalizeDuration(e){if(e<0)return.001;const t=(e-this.onTimeDurationLimits.x)/(this.onTimeDurationLimits.y-this.onTimeDurationLimits.x);return 1-Math.max(0,Math.min(1,t))}setGlowTimeScale(e){this.glowTween.setTimeScale(this.normalizeDuration(e))}createOptions(){Z(null!=ce,"Failed to fetch configuration data");const e=new o(.26*this.width,.03*this.height),t=.15*this.width;this.back=new we(this,"BACK",this.center.x-t,this.height-100,(()=>{this.saveAndExit()})),this.resetConfig=new we(this,"RESET TO\nDEFAULT",this.center.x+t,this.height-100,(()=>{console.info("INFO: Reset config to default"),ue(de,!1);for(const e of this.options)e.reset(ce);this.setGlowTimeScale(ce.onTimeDuration/2),ie.setVisibility(ce.enableCameraVisibility)})),this.input.keyboard.on(V,(()=>{this.saveAndExit()})),this.add.sprite(.09*this.width,.05*this.height,"optionsBackground").setOrigin(0,0).setAlpha(.8).setDisplaySize(.28*this.width,.185*this.height),this.add.sprite(.09*this.width,.26*this.height,"optionsBackground").setOrigin(0,0).setAlpha(.8).setDisplaySize(.28*this.width,.27*this.height),this.add.sprite(.09*this.width,.55*this.height,"optionsBackground").setOrigin(0,0).setAlpha(.8).setDisplaySize(.28*this.width,.23*this.height),this.add.sprite(.63*this.width,.05*this.height,"optionsBackground").setOrigin(0,0).setAlpha(.8).setDisplaySize(.28*this.width,.185*this.height),this.add.sprite(.63*this.width,.26*this.height,"optionsBackground").setOrigin(0,0).setAlpha(.8).setDisplaySize(.28*this.width,.27*this.height),this.add.sprite(.63*this.width,.55*this.height,"optionsBackground").setOrigin(0,0).setAlpha(.8).setDisplaySize(.28*this.width,.23*this.height),this.targetExample=this.add.sprite(.5*this.width,.1*this.height+.08*this.height*0+.15*this.height,"targetInner").setTint(f[b]).setScale(ce.targetSize),this.rotateTween=this.tweens.add({targets:[this.targetExample],rotation:2*Math.PI,ease:"Power0",duration:1e3,repeat:-1}),this.glow=this.targetExample.postFX.addGlow(I,0,0,!1,.05,24);const i=ce.onTimeDuration/2;this.glowTween=this.tweens.add({targets:this.glow,outerStrength:4,yoyo:!0,duration:i,ease:D,repeat:-1}),this.setGlowTimeScale(i),ce.postProcessingDisabled&&this.glowTween&&this.glowTween.pause();const s=new Ge(this,new o(.1*this.width,.1*this.height+.08*this.height*0),e,new o(0,G.y),ce,"targetSize",new o(.5,3),(e=>{e.label.setText("Target Scale: "+e.getStringValue());const t=e.getValue();ge(e.key,t),this.targetExample.setScale(t)}));this.options.push(s),this.add.existing(s);const n=new Ge(this,new o(.1*this.width,.1*this.height+.08*this.height*1),e,new o(0,G.y),ce,"fingerSize",new o(.5,3),(e=>{e.label&&e.label.setText("Finger Scale: "+e.getStringValue());const t=e.getValue();ge(e.key,t),this.hand.setFingerScale(t)}));this.options.push(n),this.add.existing(n);const a=e=>{null!=e&&e.active&&(e.label&&e.label.active&&e.label.setText("Camera Opacity: "+e.getStringValue()),ge(e.key,e.getValue()),this.setOpacity(ce[e.key]))},r=new Ge(this,new o(.1*this.width,.32*this.height+.08*this.height*0),e,G,ce,"cameraOpacity",new o(.01,1),a),h=new qe(this,new o(.1*this.width,.32*this.height+.08*this.height*0+$.y),25,void 0,J,ce,"enableCameraVisibility",(e=>{ge(e.key,e.isChecked),ie.setVisibility(e.isChecked),e.isChecked?r.draw():(r.setValue(ce.cameraOpacity),a(r),this.setOpacity(0),r.hide("Show Camera"))}));this.options.push(r),this.options.push(h),this.add.existing(r),this.add.existing(h);const l=new Ge(this,new o(.1*this.width,.32*this.height+.08*this.height*1),e,G,ce,"skipButtonAppearsAfterLoop",new o(1,16),(e=>{e.label.setText("Skip Button After Loop: "+e.getStringValue()),ge(e.key,e.getValue())})).setIsInteger(!0),d=new qe(this,new o(.1*this.width,.32*this.height+.08*this.height*1+$.y),25,void 0,J,ce,"showSkipButton",(e=>{ge(e.key,e.isChecked),e.isChecked?l.draw():l.hide("Show Layer Skip Button")}));this.options.push(l),this.options.push(d),this.add.existing(l),this.add.existing(d);const c=new Ge(this,new o(.1*this.width,.32*this.height+.08*this.height*2),e,G,ce,"skipLayersAutomaticallyAfterLoop",new o(1,16),(e=>{e.label.setText("Skip Layers After Loop: "+e.getStringValue()),ge(e.key,e.getValue())})).setIsInteger(!0),u=new qe(this,new o(.1*this.width,.32*this.height+.08*this.height*2+$.y),25,void 0,J,ce,"skipLayersAutomatically",(e=>{ge(e.key,e.isChecked),e.isChecked?c.draw():c.hide("Skip Layers Automatically")}));this.options.push(c),this.options.push(u),this.add.existing(c),this.add.existing(u);const g=new qe(this,new o(.1*this.width,.57*this.height+.08*this.height*0),25,new o(-$.x,0),"Disable Layer Progression",ce,"disableLayerProgression",(e=>{ge(e.key,e.isChecked)}));this.options.push(g),this.add.existing(g);const p=new qe(this,new o(.1*this.width,.57*this.height+.08*this.height*1),25,new o(-$.x,0),"Index Finger Pinches Only",ce,"indexFingerOnly",(e=>{ge(e.key,e.isChecked)}));this.options.push(p),this.add.existing(p);const m=new qe(this,new o(.1*this.width,.57*this.height+.08*this.height*2),25,new o(-$.x,0),"Disable Post-Processing",ce,"postProcessingDisabled",(e=>{ge(e.key,e.isChecked),e.isChecked?(this.glowTween&&(this.glowTween.restart(),this.glowTween.pause()),this.glow&&this.targetExample.postFX.disable()):e.isChecked||(this.glowTween&&this.targetExample&&this.glowTween.resume(),this.glow&&this.targetExample.postFX.enable())}));this.options.push(m),this.add.existing(m);const y=new Ge(this,new o(.64*this.width,.1*this.height+.08*this.height*0),e,new o(0,G.y),ce,"onTimeDuration",this.onTimeDurationLimits,(e=>{e.label.setText("On Time Duration: "+e.getStringValue()+" ms"),ge(e.key,e.getValue()),this.setGlowTimeScale(ce.onTimeDuration/2)})).setIsInteger(!0);this.options.push(y),this.add.existing(y);const v=new Ge(this,new o(.64*this.width,.1*this.height+.08*this.height*1),e,new o(0,G.y),ce,"lateTimeDuration",new o(50,1e3),(e=>{e.label.setText("Late Time Duration: "+e.getStringValue()+" ms"),ge(e.key,e.getValue())})).setIsInteger(!0);this.options.push(v),this.add.existing(v);const w=new Ge(this,new o(.64*this.width,.3*this.height+.07*this.height*0),e,new o(0,G.y),ce,"pinchVolume",new o(0,1),(e=>{e.label.setText("Pinch Volume: "+e.getStringValue()),ge(e.key,e.getValue())}));this.options.push(w),this.add.existing(w);const x=new Ge(this,new o(.64*this.width,.3*this.height+.07*this.height*1),e,new o(0,G.y),ce,"backgroundMusicVolume",new o(0,1),(e=>{e.label.setText("Track Volume: "+e.getStringValue()),ge(e.key,e.getValue())}));this.options.push(x),this.add.existing(x);const T=new qe(this,new o(.64*this.width,.33*this.height+.08*this.height*1),25,new o(-$.x,0),"Enable UI Pinches",ce,"uiPinchesEnabled",(e=>{ge(e.key,e.isChecked)}));this.options.push(T),this.add.existing(T);const k=new qe(this,new o(.64*this.width,.33*this.height+.08*this.height*1.5),25,new o(-$.x,0),"Enable Mouse Pinches",ce,"mousePinchesEnabled",(e=>{ge(e.key,e.isChecked)}));this.options.push(k),this.add.existing(k);const S=new qe(this,new o(.64*this.width,.33*this.height+.08*this.height*2),25,new o(-$.x,0),"Ignore Multifinger Pinches",ce,"ignoreMultifingerPinches",(e=>{ge(e.key,e.isChecked)}));this.options.push(S),this.add.existing(S);const P=new qe(this,new o(.64*this.width,.57*this.height+.08*this.height*0),25,new o(-$.x,0),"Display Visual Metronome",ce,"displayVisualMetronome",(e=>{ge(e.key,e.isChecked)}));this.options.push(P),this.add.existing(P);const C=new qe(this,new o(.64*this.width,.57*this.height+.08*this.height*.5),25,new o(-$.x,0),"Enable Sonification",ce,"sonificationEnabled",(e=>{ge(e.key,e.isChecked)}));this.options.push(C),this.add.existing(C);const L=new qe(this,new o(.64*this.width,.57*this.height+.08*this.height*1),25,new o(-$.x,0),"Enable Synchronization",ce,"synchronizationEnabled",(e=>{ge(e.key,e.isChecked)}));this.options.push(L),this.add.existing(L);const B=new qe(this,new o(.64*this.width,.57*this.height+.08*this.height*1.5),25,new o(-$.x,0),"Enable Unplayable Backing Tracks",ce,"unplayableBackingTracksEnabled",(e=>{ge(e.key,e.isChecked)}));this.options.push(B),this.add.existing(B);const E=new qe(this,new o(.64*this.width,.57*this.height+.08*this.height*2),25,new o(-$.x,0),"Enable Playable Backing Tracks",ce,"playableBackingTracksEnabled",(e=>{ge(e.key,e.isChecked)}));this.options.push(E),this.add.existing(E)}update(e,t){super.update(e,t)}},class extends _e{constructor(){super("levelSelect"),this.currentLevelIndex=0,this.difficultyButtons=[],this.videoOffsetY=124,Z(this.currentLevelIndex>=0,"Level select default level must be >= 0")}preload(){Z(this.currentLevelIndex<De.length,"Cannot set defaut level select index above the number of levels")}create(){super.create(),this.play=new we(this,"PLAY",this.center.x,this.height-100,(()=>{this.startLevel(this.getCurrentLevel())})),this.previousLevel=new we(this,"",this.center.x-450,75,(()=>{this.updateLevel(-1)}),"levelChange"),this.previousLevel.setFlipX(!0),this.nextLevel=new we(this,"",this.center.x+450,75,(()=>{this.updateLevel(1)}),"levelChange"),this.back=new we(this,"BACK",200,this.height-100,(()=>{this.scene.start("mainMenu"),this.exit()}));const e=new o(75);this.mute=new Ke(this,"",this.width-e.x,this.height-e.y,(()=>{this.mute.toggle()}),"mute","unmute",!0),this.input.keyboard.on(V,(()=>{this.scene.start("mainMenu"),this.exit()})),this.add.sprite(this.center.x,this.center.y-this.videoOffsetY,"videoBackground"),this.add.sprite(this.center.x,0,"songNameBackground").setOrigin(.5,0),this.songName=this.add.text(this.center.x,75,J,{font:"50px Courier New",color:"white"}).setOrigin(.5,.5),this.updateLevel(0),this.mute.addToggleCallback((e=>{this.setBackgroundAudioMute(!e)}))}exit(){for(const e of this.difficultyButtons)e&&e.destroy();this.stopAudio()}startLevel(e){this.exit(),this.scene.start("level",e)}createDifficultyButtons(e){for(const e of this.difficultyButtons)e&&e.destroy();this.difficultyButtons=[];const t=e.track.data.bpm,i=[new o(this.center.x-384,766),new o(this.center.x,766),new o(this.center.x+384,766)];Z(i.length>=t.length,"positions array length must at least match the number of track bpms");const s=[K,j,H];for(let n=0;n<t.length;n++){const o=new je(n,t[n],this,s[n],i[n].x,i[n].y,(()=>{for(const e of this.getDifficultyButtons())e!=o&&e.setToggleState(!1);o.setToggleState(!0)}),"button","button",0==n);o.setScale(.8),o.updateTint(),o.addToggleCallback((t=>{o.updateTint(),t&&(e.setBPM(o.bpmIndex),this.startPreview(e))})),this.difficultyButtons.push(o)}}getDifficultyButtons(){return this.difficultyButtons}setBackgroundAudioMute(e){for(const t of De)t.setBackgroundAudioMute(e)}startVideo(e){if(this.videoPreview&&this.videoPreview.destroy(),e.hasPreviewVideo()){this.videoPreview=this.add.video(this.center.x,this.center.y-this.videoOffsetY,e.getPreviewVideoKey()),this.videoPreview;const t=e.track.data.bpm[e.bpmIndex]/e.track.data.bpm[0];this.videoPreview.video&&(this.videoPreview.video.playbackRate=t),this.videoPreview.play(!0)}else this.videoPreview=this.add.sprite(this.center.x,this.center.y-this.videoOffsetY,"defaultVideoBackground");this.videoPreview.setScale(.6)}startPreview(e){this.stopAudio(),e.addBackgroundAudio(this,{loop:!0,volume:.5*ce.backgroundMusicVolume}),e.playBackgroundAudio(),e.setBackgroundAudioMute(!this.mute.getToggleState());let t=0;e.activeAudioTracks.length>=1&&e.hasPreviewVideo()?t=1e3*e.getAudioLoopTime():(this.startVideo(e),e.hasPreviewVideo()&&(t=this.videoPreview.getDuration())),0!=t&&e.hasPreviewVideo()&&(this.videoRefreshEvent=this.time.addEvent({delay:t,callback:()=>{this.startVideo(e)},callbackScope:this,loop:!0,startAt:t}))}stopAudio(){this.videoRefreshEvent&&this.videoRefreshEvent.destroy();for(const e of De)e.removeBackgroundAudio()}updateLevel(e){this.cycleLevel(e);const t=this.getCurrentLevel();this.songName.setText(t.track.data.displayName),Z(0<t.track.data.bpm.length,"Default difficulty button index must be in range of default track BPM"),t.setBPM(0),this.startPreview(t),this.createDifficultyButtons(t)}cycleLevel(e){const t=De.length;this.currentLevelIndex=((this.currentLevelIndex+e)%t+t)%t}getCurrentLevel(){return Z(this.currentLevelIndex<De.length,"Current level index out of range of this.levels array"),De[this.currentLevelIndex]}getCurrentLevelKey(){return"level"+(this.currentLevelIndex+1).toString()}update(e,t){super.update(e,t)}},class extends _e{constructor(){super("level")}preload(){this.level=this.scene.settings.data}create(){super.create(),this.level.init(this),this.level.hasCustomBackground()?this.setBackgroundTexture(this.level.getBackgroundTextureKey()):this.setBackgroundTexture("levelBackground"),this.input.keyboard.on(V,(()=>{this.level.abort()})),this.level.start((()=>{Re=!0,this.scene.start(W,this.level)}),(()=>{this.scene.start(q)}))}update(e,t){super.update(e,t),this.level.update(e)}},class extends _e{constructor(){super("scoreboard")}exit(){this.level.removeBackgroundAudio(),this.scene.start("mainMenu")}preload(){this.level=this.scene.settings.data,this.levelStats=this.level.score.levelStats,ce.autoSaveCSV&&pe(this.level.score.levelStats)}create(){super.create(),this.back=new we(this,"BACK",this.center.x,this.height-100,(()=>{this.exit()}));const e=new o(75);this.mute=new Ke(this,"",this.width-e.x,this.height-e.y,(()=>{this.mute.toggle()}),"mute","unmute",!0),this.level.addBackgroundAudio(this,{loop:!0,volume:.5*ce.backgroundMusicVolume}),this.level.playBackgroundAudio(),this.mute.addToggleCallback((e=>{this.level.setBackgroundAudioMute(!e)})),this.input.keyboard.on(V,(()=>{this.exit()})),ce.autoSaveCSV||(this.save=new we(this,"SAVE CSV",200,this.height-100,(()=>{!function(e){const t=new Blob([ae(e)],{type:"text/plain;charset=utf-8"});le().saveAs(t,e.id+".csv")}(this.levelStats)}))),this.add.sprite(0,0,"scoreboardBackground1").setScale(1.35,1.25).setAlpha(.6).setPosition(this.center.x,.25*this.height);const t=this.add.text(this.center.x,0,"Scoreboard",{color:"#01c303",font:"96px Courier New"});t.setStroke("#000",6),t.setPosition(this.center.x-t.width/2,.07*this.height);const i=this.levelStats.layersStats.reduce(((e,t)=>e+t.total),0),s=this.levelStats.layersStats.reduce(((e,t)=>e+t.correct),0),n=this.levelStats.layersStats.reduce(((e,t)=>e+t.miss),0),a=this.levelStats.layersStats.reduce(((e,t)=>e+t.early),0),r=this.levelStats.layersStats.reduce(((e,t)=>e+t.late),0),h=this.add.text(this.center.x,0,`Total Correct: ${s.toString()}/${i.toString()}\nLongest Streak: ${this.levelStats.maxStreak}\nMissed: ${n}\nEarly: ${a}\nLate: ${r}`,{color:"#ffffff",align:"center",font:"48px Courier New"});h.setPosition(this.center.x-h.width/2,.19*this.height);const l=[.25,.5,.75],d=l;this.level.track.forEachLayer(void 0,((e,t)=>{this.add.sprite(0,0,"scoreboardBackground2").setScale(1.35,1.15).setAlpha(.6).setPosition(this.width*l[t],.63*this.height);const i=this.add.text(0,0,`${s=e.id,s&&s[0].toUpperCase()+s.slice(1)||""}`,{color:"#01c303",align:"center",font:"72px Courier New",fontStyle:"bold"});var s;i.setStroke("#000",4),i.setPosition(this.width*d[t]-i.width/2,.53*this.height);const n=this.levelStats.layersStats[t];let o=0,a=0,r=0;n&&(o=n.correct,a=n.total,r=n.loop);const h=this.add.text(0,0,`\nCorrect: ${o.toString()}/${a.toString()}\nLoops: ${r.toString()}`,{color:"#ffffff",align:"center",font:"48px Courier New"});h.setPosition(this.width*d[t]-h.width/2,.575*this.height+.01)}))}update(e,t){super.update(e,t)}},class extends _e{constructor(){super("calibration")}exit(){this.scene.start(q)}create(){super.create(),this.enableCamera(!0,.8),this.back=new we(this,"BACK",this.center.x,this.height-100,(()=>{this.exit()})),this.setBackgroundTexture("calibrationBackground"),this.input.keyboard.on(V,(()=>{this.exit()})),this.distanceText=this.add.text(this.center.x,.1*this.height,J,{color:"white",font:"50px Courier New"}).setOrigin(.5,.5).setShadow(5,5,"rgba(0,0,0,0.5)",15)}update(e,t){super.update(e,t);const i=this.hand.calculateHandDistance();let s="Hand Not Recognized";if(i>0){let e=65280;i>40?(s="Too Far - Estimated Distance: ",e=16711680):i<20?(s="Too Close - Estimated Distance: ",e=255):s="Optimal - Estimated Distance: ",Ie.setTint(e),s+=i.toFixed(0)+" cm"}else Ie.clearTint();this.distanceText&&this.distanceText.active&&this.distanceText.setText(s)}}]};function et(){document.body.removeChild(document.getElementById("login_screen")),new(n().Game)(Qe)}const tt=(0,We.Wp)({apiKey:"AIzaSyAHkhSVhXo1qrE3lYqXEh2ozwOgZJhk960",authDomain:"pizzicato-1f765.firebaseapp.com",projectId:"pizzicato-1f765",storageBucket:"pizzicato-1f765.firebasestorage.app",messagingSenderId:"196367706867",appId:"1:196367706867:web:bb5cac34655842ac462586",databaseURL:"https://pizzicato-1f765-default-rtdb.europe-west1.firebasedatabase.app/"}),it=(0,Ue.xI)(tt),st=(0,Ye.C3)(tt),nt={config:"sonification",lastLogin:"Has not logged in yet",name:"",experimentStart:"",week:0,trainingsCompleted:0},ot="@pizzicato.com";function at(){return Ze?Ze.email.replace(ot,""):"guest"}function rt(){const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function ht(e){alert(e)}function lt(e,t){return Xe(this,void 0,void 0,(function*(){return new Promise(((i,s)=>{const n=(0,Ye.KR)(st,`users/${Ze.uid}/data/${e}`);(0,Ye.hZ)(n,t).then((()=>{i('Data written successfully for user "'+at()+'"')})).catch((e=>{s('Data not found for user "'+at()+'":'+e)}))}))}))}function dt(){return Xe(this,void 0,void 0,(function*(){return new Promise(((e,t)=>{const i=(0,Ye.KR)(st),s=`users/${Ze.uid}`;(0,Ye.Jt)((0,Ye.jf)(i,s)).then((n=>{if(n.exists()){const t=n.val();t.trainingsCompleted?++t.trainingsCompleted:t.trainingsCompleted=1,(0,Ye.yo)((0,Ye.jf)(i,s),t).then((()=>{e("Updated user completed trainings to "+t.trainingsCompleted.toString())}))}else t("User id snapshot does not exist")})).catch((e=>{t("Firebase get users failed: "+e)}))}))}))}function ct(){return Xe(this,void 0,void 0,(function*(){return new Promise(((e,t)=>{const i=(0,Ye.KR)(st);(0,Ye.Jt)((0,Ye.jf)(i,`users/${Ze.uid}`)).then((i=>{if(i.exists()){const s=i.val();(function(e){return Xe(this,void 0,void 0,(function*(){return new Promise(((t,i)=>{if(e){const s=(0,Ye.KR)(st);(0,Ye.Jt)((0,Ye.jf)(s,`configs/${e}`)).then((s=>{s.exists()?t(s.val()):i('Config "'+e+'" not found in database')})).catch((e=>{i("Firebase get configs failed: "+e)}))}else i("Undefined config name")}))}))})(s.config).then((i=>{s.config?e([i,s.config]):t("Undefined config name")})).catch((e=>{t("Failed to retrieve config: "+e)}))}else t("User id snapshot does not exist")})).catch((e=>{t("Firebase get users failed: "+e)}))}))}))}function ut(){return Xe(this,void 0,void 0,(function*(){return new Promise(((e,t)=>{const i=(0,Ye.KR)(st);(0,Ye.Jt)((0,Ye.jf)(i,`users/${Ze.uid}`)).then((i=>{if(i.exists()){const t=i.val();e(t.week)}else t("Failed to identify week number")})).catch((e=>{t("Firebase get users failed: "+e)}))}))}))}{const e='\n    <div id="login_screen">\n      <div class="login-container">\n        <h2>Experiment Login</h2>\n        <div class="input-group">\n          <input type="text" id="name" name="name" placeholder="Name" required>\n        </div>\n        <div class="input-group">\n          <input type="password" id="password" name="password" placeholder="Password" required>\n          <div class="show-password-box"><input type="checkbox" id="password_checkbox">Show Password</div>\n        </div>\n        <div class="button-group">\n          <button id="login_button" class="login-button">Login</button>\n        </div>\n      </div>\n    </div>\n    <div id="background_image"></div>\n  ';document.body.innerHTML+=e,document.getElementById("login_button").addEventListener("click",(function(){return Xe(this,void 0,void 0,(function*(){const[e,t,i,s]=function(){const e=document.getElementById("name").value,t=document.getElementById("password").value,i=(s=t).endsWith("pre")?s.slice(0,-3):s.endsWith("post")?s.slice(0,-4):s;var s;const n=function(e){return e+ot}(e);return function(e){return/^[A-Za-z][A-Za-z0-9_]{3,29}$/.test(e)}(e)&&function(e){return e.length>=6}(i)&&function(e){return/^[^@]+@\w+(\.\w+)+\w$/.test(e)}(n)?[e,n,i,t]:["","",""]}();(0,Ue.x9)(it,t,i).then((t=>{const i=function(e,t){const i=e.match(/(\d+)$/),s=i?parseInt(i[1],10):null,n=t.match(/(pre|post)$/i),o=n?n[1].toLowerCase():null;return null==s?null:null==o?{number:s,suffix:"training"}:{number:s,suffix:o}}(e,s);if(null==i)return void ht("Invalid participant info");Je=i.number;const n=function(e){if(e<0)throw new Error("Participant number cannot be negative.");switch(e%4){case 0:return"sonification";case 1:return"synchronization";case 2:return"both";case 3:return"nosound";default:return"unknown"}}(Je);Ze=t.user;const o=(0,Ye.KR)(st),a=(new Date).toUTCString(),r={lastLogin:a,config:n},h=`users/${Ze.uid}`;nt.name=e,nt.lastLogin=a,nt.config=n,nt.week=0,nt.trainingsCompleted=0,"pre"==i.suffix&&(nt.experimentStart=rt(),r.experimentStart=rt()),(0,Ye.Jt)((0,Ye.jf)(o,h)).then((e=>{if(e.exists()){const t=e.val(),s=function(e,t,i){if(e.trainingsCompleted=t.trainingsCompleted,"pre"==i)e.week=0;else if("post"==i||-1==t.week)e.week=-1;else{let i=t.experimentStart;null!=i&&""!=i||(i=e.experimentStart);const s=function(e,t){try{const i=new Date(e),s=new Date(t);if(isNaN(i.getTime())||isNaN(s.getTime()))return null;const n=s.getTime()-i.getTime(),o=Math.ceil(n/864e5);return o<=0?1:Math.ceil(o/7)}catch(e){return console.error("Error calculating week number:",e),null}}(i,rt());if(null==s)return ht("Failed to calculate experiment week number"),null;e.week=s}return e}(r,t,i.suffix);null!==s&&(0,Ye.yo)((0,Ye.jf)(o,h),s).then((()=>{if("training"==i.suffix){if(0==s.week)return void ht("Cannot login before pretest");if(-1==s.week)return void ht("Cannot login after posttest");if(void 0!==s.trainingsCompleted&&s.trainingsCompleted>=3*s.week)return void ht("Maximum of "+3..toString()+" trainings per week")}et()}))}else{if(""==nt.experimentStart)return void ht("Cannot login with the provided credentials prior to experiment start being set");(0,Ye.yo)((0,Ye.jf)(o,h),nt).then((()=>{et()}))}})).catch((e=>{console.info("LOGIN ERROR: "+e)}))})).catch((e=>{"auth/invalid-credential"===e.code?alert("Invalid username or password. Please try again."):"auth/user-disabled"===e.code?alert("This user account has been disabled."):"auth/user-not-found"===e.code?alert("User not found. Please check your credentials."):"auth/wrong-password"===e.code?alert("Incorrect password. Please try again."):console.error("Firebase sign-in error:",e)}))}))})),document.getElementById("password_checkbox").addEventListener("click",(function(){const e=document.getElementById("password");"password"===e.type?e.type="text":e.type="password"}))}}},i={};function s(e){var n=i[e];if(void 0!==n)return n.exports;var o=i[e]={exports:{}};return t[e].call(o.exports,o,o.exports,s),o.exports}s.m=t,e=[],s.O=(t,i,n,o)=>{if(!i){var a=1/0;for(d=0;d<e.length;d++){for(var[i,n,o]=e[d],r=!0,h=0;h<i.length;h++)(!1&o||a>=o)&&Object.keys(s.O).every((e=>s.O[e](i[h])))?i.splice(h--,1):(r=!1,o<a&&(a=o));if(r){e.splice(d--,1);var l=n();void 0!==l&&(t=l)}}return t}o=o||0;for(var d=e.length;d>0&&e[d-1][2]>o;d--)e[d]=e[d-1];e[d]=[i,n,o]},s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e={792:0};s.O.j=t=>0===e[t];var t=(t,i)=>{var n,o,[a,r,h]=i,l=0;if(a.some((t=>0!==e[t]))){for(n in r)s.o(r,n)&&(s.m[n]=r[n]);if(h)var d=h(s)}for(t&&t(i);l<a.length;l++)o=a[l],s.o(e,o)&&e[o]&&e[o][0](),e[o]=0;return s.O(d)},i=self.webpackChunkPizzicato=self.webpackChunkPizzicato||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))})();var n=s.O(void 0,[96],(()=>s(168)));n=s.O(n)})();