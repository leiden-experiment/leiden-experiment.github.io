(()=>{"use strict";var t,e={852:(t,e,s)=>{var i=s(440),n=s.n(i);function a(t){let e="layerID,noteID,loopNumber,playerTime,correctTime,classification\n";for(const s of t.layersStats){const i=t.layersStats.indexOf(s);for(const t of s.hits)e+=`${i},${t.noteID},${t.loopNumber},${o(t.playerTime)},${o(t.correctTime)},${t.classification}\n`}return e}function o(t,e=3){return parseFloat((t/1e3).toFixed(e))}const r=Phaser.Math.Vector2,h=Phaser.GameObjects.Group,l=Phaser.GameObjects.Graphics,c=Phaser.Time.TimerEvent,d=Phaser.GameObjects.GameObject,u=Phaser.Geom.Rectangle,g=(Phaser.Geom.Circle,Phaser.Input.Pointer,Phaser.GameObjects.Text),p=(Phaser.GameObjects.Sprite,Phaser.GameObjects.Video,Phaser.GameObjects.RenderTexture,Phaser.Events.EventEmitter,Phaser.GameObjects.Image,Phaser.Scene),v=(Phaser.Tilemaps.Tile,Phaser.Tweens.Tween,Phaser.GameObjects.Particles.ParticleEmitter,Phaser.Physics.Matter.Sprite),m=(Phaser.Physics.Arcade.Sprite,!0),y="finger",f="previewVideoBackground",b="songNameBackground",w="layerScoreBackground",T="scoreboardBackground",x="menuCalibrateButton",k="menuSelectButton",S="optionsButton",P="targetInner",L="background1",C="mainBackground",B="playButton",D="easyButton",O="mediumButton",H="hardButton",_="backButton",M="buttonDing",V="calibrationBackground",I="menuLogo",A="resetButton",E="muteButton",F="unmuteButton",K="leftArrow",j="rightArrow",N="saveCSVButton",W="defaultLevelbackground",z="defaultPreviewbackground",R="assets/sprites/defaultTargetInner.png",G="assets/ui/back_button.png",q="assets/sounds/ui/menu_ding.wav",$="assets/ui/mute_button.png",J="assets/ui/unmute_button.png",U="levels/",X=U+"list.json",Q=".ogg",Y="data/config.json",Z="data/default_config.json",tt={thumb:16777215,index:14948892,middle:9981603,ring:3636920,pinky:16220607},et={lineWidth:5,color:11393254,alpha:.5},st={lineWidth:5,color:11393254,alpha:1,radius:.1},it="thumb",nt="index",at=nt,ot=16777215,rt=14948892,ht=P,lt="targetOuter",ct=R,dt={scale:1.03,color:16777215,ease:"linear"},ut={scale:.78,color:5091146,ease:"linear"},gt={scale:.3,color:16744192,ease:"linear"},pt={scale:0,color:8421504,ease:"cubic.in"},vt="keydown-ESC",mt={font:"32px Courier",color:"#00ff00"},yt={position:ne(new r(.05,.05)),color:"white",scale:1,font:"30px Arial",depth:40,strokeThickness:0,shadowOffset:new r(2,2),shadowColor:"black",shadowBlurRadius:2},ft={color:[16436258,16291840,16266752,10421252],colorEase:"quad.out",lifespan:500,scale:{start:.7,end:0,ease:"sine.out"},speed:200,advance:500,frequency:50,blendMode:"ADD",duration:0},bt="flare",wt={position:ne(new r(.5,0)),size:ne(new r(.4,.04)),requiredTint:524543,completedRequiredTint:2840741,completedTint:ut.color,extraTint:ut.color,path:"assets/ui/progress_bar_segment.png",key:"segment",tintByNode:!1},Tt="metronome/high",xt="metronome/low",kt="countdown",St={position:ne(new r(.5,.5)),color:"white",scale:1,ease:"Power0",font:"240px Arial",depth:30},Pt={position:ne(new r(.835,0)),size:new r(.16*window.innerWidth,.2684*window.innerHeight),textureKey:"infoBackground",opacity:.3,path:"assets/ui/info_background.png"},Lt={position:ne(new r(.93,.9)),scale:new r(.3,.3),soundKey:M,textureKey:"skipButton",path:"assets/ui/skip_button.png"},Ct={position:ne(new r(.85,.02)),color:"white",font:"20px Arial",scale:1,depth:40},Bt={position:ne(new r(.85,.07)),color:"white",font:"20px Arial",scale:1,depth:40},Dt={position:ne(new r(.85,.12)),color:"white",font:"20px Arial",scale:1,depth:40},Ot={position:ne(new r(.85,.17)),color:"white",font:"20px Arial",scale:1,depth:40},Ht={position:ne(new r(.85,.22)),color:"white",font:"20px Arial",scale:1,depth:40},_t=new r(.5,.5),Mt=new r(.6,.6),Vt=new r(1.5,1.5),It=new r(-32,-32),At=new r(32,-32),Et=.07,Ft=.71,Kt=.75,jt="loading",Nt="level",Wt="scoreboard",zt="mainMenu",Rt="levelSelect",Gt="calibration",qt="options",$t=zt,Jt={visible:!1,flip:!0,opacity:0,width:window.innerWidth,height:window.innerHeight,objectFit:"fill"},Ut={video:{width:{ideal:640},height:{ideal:360}},audio:!1},Xt={baseOptions:{delegate:"GPU"},runningMode:"VIDEO",numHands:1,minHandDetectionConfidence:.5,minHandPresenceConfidence:.5,minTrackingConfidence:.5},Qt="UNDEFINED";var Yt=function(t,e,s,i){return new(s||(s=Promise))((function(n,a){function o(t){try{h(i.next(t))}catch(t){a(t)}}function r(t){try{h(i.throw(t))}catch(t){a(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,r)}h((i=i.apply(t,e||[])).next())}))};function Zt(t){return new Promise(((e,s)=>Yt(this,void 0,void 0,(function*(){var i;yield("GET",i=t,new Promise((function(t,e){let s=new XMLHttpRequest;s.open("GET",i),s.onload=function(){this.status>=200&&this.status<300?t(s):e({status:this.status,statusText:s.statusText})},s.onerror=function(){e({status:this.status,statusText:s.statusText})},s.send()}))).then((t=>{e(JSON.parse(t.responseText.toString("utf8")))})).catch((()=>{s()}))}))))}function te(t,e="no error message provided"){if(m&&!t)throw new Error("Assertion failed: "+e)}function ee(t,e=""){const s="".replace(/\\/g,"/")+e;return t=t.replace(/\\/g,"/"),"/"==Array.from(t)[0]?s+t:s+"/"+t}function se(t){return ee(t,"")}function ie(t){return se(t),!0}function ne(t){return t instanceof r?new r(t.x*window.innerWidth,t.y*window.innerHeight):new r(t[0]*window.innerWidth,t[1]*window.innerHeight)}const ae=s(213);let oe;function re(t){oe=t}function he(t){return new Promise(((e,s)=>{return i=this,n=void 0,o=function*(){yield Zt(se(t)).then((t=>{const s=t;re(s),e(s)})).catch((()=>{s()}))},new((a=void 0)||(a=Promise))((function(t,e){function s(t){try{h(o.next(t))}catch(t){e(t)}}function r(t){try{h(o.throw(t))}catch(t){e(t)}}function h(e){var i;e.done?t(e.value):(i=e.value,i instanceof a?i:new a((function(t){t(i)}))).then(s,r)}h((o=o.apply(i,n||[])).next())}));var i,n,a,o}))}var le=function(t,e,s,i){return new(s||(s=Promise))((function(n,a){function o(t){try{h(i.next(t))}catch(t){a(t)}}function r(t){try{h(i.throw(t))}catch(t){a(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,r)}h((i=i.apply(t,e||[])).next())}))};const ce=new class{init(t,e){return le(this,void 0,void 0,(function*(){return new Promise(((s,i)=>le(this,void 0,void 0,(function*(){e("Loading webcam..."),this.setupVideoElement(t),yield navigator.mediaDevices.getUserMedia(Ut).then((t=>{"srcObject"in this.video?(this.video.srcObject=t,this.video.addEventListener("loadeddata",(()=>{s(!0)}))):i("srcObject does not exist on older browsers")})).catch((t=>{i(t)}))}))))}))}found(){return null!=this.video.srcObject}setVisibility(t){this.video.style.visibility="",this.video.style.visibility=t?"shown":"hidden"}setWidth(t){this.video.width=t}setHeight(t){this.video.height=t}setupVideoElement(t){this.video=document.body.appendChild(document.createElement("video")),this.video.autoplay=!0,this.video.muted=!0,this.video.playsInline=!0,this.video.style.position="absolute",this.video.style.top="0",this.video.style.left="0",this.video.style.bottom="0",this.video.style.zIndex="-1",this.video.style.pointerEvents="none",this.video.style.objectFit=t.objectFit,this.setWidth(t.width),this.setHeight(t.height),t.flip&&(this.video.style.cssText+="-moz-transform: scale(-1, 1);          -webkit-transform: scale(-1, 1); -o-transform: scale(-1, 1);          transform: scale(-1, 1); filter: FlipH;"),this.setVisibility(!1)}get video(){return te(null!=this.video_),this.video_}set video(t){this.video_=t}};var de=s(260),ue=function(t,e,s,i){return new(s||(s=Promise))((function(n,a){function o(t){try{h(i.next(t))}catch(t){a(t)}}function r(t){try{h(i.throw(t))}catch(t){a(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,r)}h((i=i.apply(t,e||[])).next())}))};const ge=new class{constructor(){this.lastVideoTime=-1}init(t){return ue(this,void 0,void 0,(function*(){return new Promise(((e,s)=>ue(this,void 0,void 0,(function*(){let i;yield de.Ps.forVisionTasks(ee("models/wasm")).then((t=>i=t)).catch((t=>{s(t)})),t("Loading hand landmarker..."),Xt.baseOptions.modelAssetPath=se("models/hand_landmarker.task"),yield de.Vb.createFromOptions(i,Xt).then((t=>this.handLandmarker_=t)).catch((t=>{t instanceof Event&&"error"==t.type&&s("Failed to fetch vision_wasm_internal.js in specified wasm directory"),t instanceof TypeError&&s("Failed to fetch hand_landmark.task file"),s(t)})),e(!0)}))))}))}precache(t){t("Pre-caching landmarks..."),this.update()}found(){return null!=this.handLandmarker_}update(){this.lastVideoTime!=ce.video.currentTime&&(this.lastVideoTime=ce.video.currentTime,this.results_=this.handLandmarker.detectForVideo(ce.video,performance.now()))}get results(){return te(null!=this.results_),this.results_}get handLandmarker(){return te(null!=this.handLandmarker_),this.handLandmarker_}landmarksFound(t=0){return null!=this.results&&t<this.results.landmarks.length}landmarkFound(t,e=0){if(!this.landmarksFound(e))return!1;const s=this.results.landmarks[e][t];return s.x>=0&&s.x<=1&&s.y>=0&&s.y<=1}getLandmarkPosition(t,e=0){if(!this.landmarksFound(e))return;const s=this.results.landmarks[e][t],i=ne(new r(s.x,s.y));return new r(window.innerWidth-i.x,i.y)}forEachLandmarkPosition(t,e=0){for(let s=0;s<21;++s){const i=this.getLandmarkPosition(s,e);void 0!==i&&t(i)}}};var pe=function(t,e,s,i){return new(s||(s=Promise))((function(n,a){function o(t){try{h(i.next(t))}catch(t){a(t)}}function r(t){try{h(i.throw(t))}catch(t){a(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,r)}h((i=i.apply(t,e||[])).next())}))};let ve;function me(t,e){null!=t&&(t.setVisible(e),e?t.setInteractive():t.disableInteractive())}class ye extends v{constructor(t,e,s,i,n){super(t.matter.world,0,0,e,void 0,{render:{visible:!0}}),this.name=s,this.landmarkIndex=i,this.scene.add.existing(this),this.setScale(n),this.setTint(tt[this.name]),this.setDepth(100),this.setCircle(this.displayWidth/2,{label:this.name}),this.setSensor(!0),me(this,!1)}}var fe,be;!function(t){t[t.hover=0]="hover",t[t.pinch=1]="pinch"}(fe||(fe={})),function(t){t[t.start=0]="start",t[t.continue=1]="continue",t[t.end=2]="end"}(be||(be={}));class we extends d{getFinger(t){const e=this.fingers.findIndex((e=>e.name==t));if(-1!==e)return this.fingers[e]}get observers(){return this.observers_}isObserver(t){return void 0!==this.observers_.find((e=>e.fingerName===t.fingerName&&e.object==t.object))}wasObserverHovering(t){return te(this.isObserver(t)),this.observers_.find((e=>e.fingerName===t.fingerName&&e.object==t.object)).wasHovering}setObserverHover(t,e){const s=this.observers_.findIndex((e=>e.fingerName===t.fingerName&&e.object==t.object));te(-1!==s,"Cannot set observer hover before observer is pushed"),this.observers_[s].wasHovering=e}pushNewObserversOnly(t){this.isObserver(t)||(this.observers.push(t),this.setObserverHover(t,!1))}removeObserver(t){const e=this.observers_.findIndex((e=>e.fingerName===t.fingerName&&e.object==t.object));e>-1&&this.observers_.splice(e,1)}constructor(t){super(t,"hand"),this.fingers=[],this.observers_=[],this.fingers=[],this.observers_=[];const e=(t,e)=>{const s=new ye(this.scene,y,t,e,.3*oe.fingerSize);return this.fingers.push(s),s},s=e(it,4),i=(e(nt,8),e("middle",12),e("ring",16),e("pinky",20),(t,e)=>{t((t=>{const i=this.getFinger(t.bodyB.label);if(void 0!==i)for(const t of this.observers)t.fingerName==i.name&&null!=t.object&&t.object.input&&t.object.input.enabled&&t.object.emit(i.name+fe.pinch+e);else if(t.bodyB.gameObject){const i=t.bodyB.gameObject;for(const n of this.fingers){if(n==s)continue;const a={object:i,fingerName:n.name};if(!this.isObserver(a))continue;const o=this.scene.matter.overlap(t.bodyB,[n]);if(e===be.start&&o)i.emit(n.name+fe.hover+be.start),this.setObserverHover(a,!0);else if(e===be.continue){const t=this.wasObserverHovering(a);o&&t?(i.emit(n.name+fe.hover+be.continue),this.setObserverHover(a,!0)):o&&!t?(i.emit(n.name+fe.hover+be.start),this.setObserverHover(a,!0)):!o&&t&&(i.emit(n.name+fe.hover+be.end),this.setObserverHover(a,!1))}else e===be.end&&this.wasObserverHovering(a)&&(i.emit(n.name+fe.hover+be.end),this.setObserverHover(a,!1))}}}))});i(s.setOnCollide.bind(s),be.start),i(s.setOnCollideActive.bind(s),be.continue),i(s.setOnCollideEnd.bind(s),be.end)}setFingerScale(t){for(const e of this.fingers)e.setScale(.3*t)}addPinchCheck(t,e,s){this.pushNewObserversOnly({object:e,fingerName:t});const i=t=>{const s=this.getFinger(it),i=this.getFinger(t);if(void 0===s)return!1;if(void 0===i)return!1;const n=this.scene.matter.overlap(e,[s]),a=this.scene.matter.overlap(e,[i]);return n&&a};null!=s.startPinch&&e.on(t+fe.pinch+be.start,(()=>{var e;i(t)&&(null===(e=s.startPinch)||void 0===e||e.call(s))})),null!=s.pinched&&e.on(t+fe.pinch+be.continue,(()=>{var e;i(t)&&(null===(e=s.pinched)||void 0===e||e.call(s))})),null!=s.endPinch&&e.on(t+fe.pinch+be.end,(()=>{var e;i(t)&&(null===(e=s.endPinch)||void 0===e||e.call(s))})),null!=s.startHover&&e.on(t+fe.hover+be.start,(()=>{var t;null===(t=s.startHover)||void 0===t||t.call(s)})),null!=s.hovering&&e.on(t+fe.hover+be.continue,(()=>{var t;null===(t=s.hovering)||void 0===t||t.call(s)})),null!=s.endHover&&e.on(t+fe.hover+be.end,(()=>{var t;null===(t=s.endHover)||void 0===t||t.call(s)}))}removePinchCheck(t,e){this.removeObserver({fingerName:t,object:e}),e.off(t+fe.pinch+be.start),e.off(t+fe.pinch+be.continue),e.off(t+fe.pinch+be.end),e.off(t+fe.hover+be.start),e.off(t+fe.hover+be.continue),e.off(t+fe.hover+be.end)}update(){this.observers_=this.observers_.filter((t=>null!=t)),ge.update();const t=this.scene.matter.add.circle(this.scene.input.mousePointer.x,this.scene.input.mousePointer.y,1,{circleRadius:1,isSensor:!0,render:{visible:!1}});for(const e of this.fingers){const s=ge.getLandmarkPosition(e.landmarkIndex),i=void 0!==s;if(i&&e.setPosition(s.x,s.y),me(e,i),!i&&null!=t)for(const s of this.observers)null!=t&&null!=s.object&&s.object.active&&null!=this.scene&&(s.object.emit(e.name+fe.pinch+be.end),this.scene.matter.overlap(t,[s.object])||s.object.emit(e.name+fe.hover+be.end))}this.scene.matter.world.remove(t)}calculateHandDistance(t=0){const e=ge.getLandmarkPosition(5,t),s=ge.getLandmarkPosition(17,t),i=ge.getLandmarkPosition(0,t);let n=0,a=0;const o=innerWidth*innerHeight;if(void 0!==e&&void 0!==s){const t=new r((e.x+s.x)/2,(e.y+s.y)/2);n=Math.sqrt(Math.pow((s.x-e.x)/o,2)+Math.pow((s.y-e.y)/o,2)),void 0!==i&&(a=Math.sqrt(Math.pow((i.x-t.x)/o,2)+Math.pow((i.y-t.y)/o,2)))}return 0==n||0==a?0:8.2*.7/Math.max(n/8.2,a/10)/o*100}}const Te=new Set([[0,1],[0,5],[9,13],[13,17],[5,9],[0,17],[1,2],[2,3],[3,4],[5,6],[6,7],[7,8],[9,10],[10,11],[11,12],[13,14],[14,15],[15,16],[17,18],[18,19],[19,20]]);class xe extends p{constructor(t){super(t)}preload(){}create(t=oe.enableCameraVisibility,e=oe.cameraOpacity){ce.setVisibility(t),ve.setVisible(!0),this.clearBackgroundTint(),this.setBackgroundTexture(C),this.setOpacity(e),this.sound.pauseOnBlur=!1,this.graphics=this.add.graphics(),this.graphics.setDepth(99),this.hand=new we(this)}update(t,e){this.graphics.clear(),this.hand.update(),function(t,e,s=0){t.setDepth(99),ge.forEachLandmarkPosition((s=>{t.lineStyle(e.lineWidth,e.color,e.alpha),t.strokeCircle(s.x,s.y,e.radius)}),s)}(this.graphics,st,0),function(t,e,s=0){t.setDepth(98),Te.forEach((i=>{const n=ge.getLandmarkPosition(i[0],s);if(void 0!==n){const a=ge.getLandmarkPosition(i[1],s);void 0!==a&&(t.lineStyle(e.lineWidth,e.color,e.alpha),t.lineBetween(n.x,n.y,a.x,a.y))}}))}(this.graphics,et,0),ve.setDisplaySize(document.body.clientWidth,document.body.clientHeight+1)}setOpacity(t){null!=t&&(te(t>=0&&t<=1),ve.setAlpha(1-t))}setBackgroundTexture(t){ve.setTexture(t)}setBackgroundTint(t){ve.setTint(t)}clearBackgroundTint(){ve.clearTint()}}class ke extends v{constructor(t,e,s,i,n,a){super(t.matter.world,e.x,e.y,i,void 0,{render:{visible:!0},label:"button-"+i}),this.scene=t,this.scene.add.existing(this),this.sound=this.scene.sound.add(n,{volume:oe.sonificationLevel}),this.setSensor(!0),this.setOrigin(.5,.5),this.setScale(s.x,s.y),this.setDepth(93),me(this,a),this.on("destroy",(()=>{this.scene.hand.removePinchCheck(at,this)}))}removePinchCallbacks(){this.scene.hand.removePinchCheck(at,this)}addPinchCallbacks(t){const e={startPinch:()=>{var e;null===(e=t.startPinch)||void 0===e||e.call(t),this.sound.play({volume:oe.sonificationLevel})},pinched:t.pinched,endPinch:t.endPinch,startHover:t.startHover,endHover:t.endHover};this.scene.hand.addPinchCheck(at,this,e),this.on("pointerdown",e.startPinch),e.startHover&&this.on("pointermove",e.startHover),e.endHover&&this.on("pointerout",e.endHover)}}class Se{constructor(t){this.trackKey=Qt,this.bpm=0,this.beatLength_=1,this.trackKey=t}get beatLength(){return this.beatLength_}setBPM(t){te(null!=this.data,"preload JSON before setting BPM"),te(t<this.data.bpm.length,"BPM index out of range"),this.bpm=this.data.bpm[t];const e=16/this.data.timeSignatureDenominator;this.beatLength_=this.songTimePositionToTime({bar:1,step:1+e,tick:0})}getBPM(){return te(null!=this.data,"preload JSON before retrieving BPM"),te(0!=this.bpm,"Track BPM has not been set"),this.bpm}preload(t){this.preloadJson(t)}unload(t){this.unloadJson(t)}preloadNotes(t){te(null!=this.trackDir,"Preload track before preloading notes"),this.forEachLayer(void 0,(e=>{e.nodes.forEach(((s,i)=>{const n=this.getSoundKey(e,s.soundKey),a=this.trackDir+e.id+"/"+s.soundKey+Q;t.cache.audio.exists(n)||""===s.soundKey||t.load.audio(n,se(a))}))}))}unloadNotes(t){this.forEachLayer(void 0,(e=>{e.nodes.forEach(((s,i)=>{t.cache.audio.remove(this.getSoundKey(e,s.soundKey))}))}))}preloadLoops(t){this.forEachLayer((e=>{te(void 0!==e.soundLoopKeys),te(e.soundLoopKeys.length>0),e.soundLoopKeys.forEach((s=>{const i=this.getSoundKey(e,s),n=this.trackDir+e.id+"/"+s+Q;t.cache.audio.exists(i)||""===s||t.load.audio(i,se(n))}))}))}unloadLoops(t){this.forEachLayer((e=>{e.soundLoopKeys.forEach((s=>{t.cache.audio.remove(this.getSoundKey(e,s))}))}))}getSoundKey(t,e){return te(void 0!==e),this.trackKey+"/"+t.id+"/"+e}forEachLayer(t,e){te(null!=this.data,"JSON has not finished preloading");let s=0;this.data.layers.forEach(((i,n)=>{i.playable||s++,null==t||t(i,n),i.playable&&(null==e||e(i,n-s))}))}addBackgroundAudioTracks(t,e,s,i){const n=[];return this.forEachLayer(((a,o)=>{(null==i||i(a,o))&&(te(void 0!==a.soundLoopKeys),te(s<a.soundLoopKeys.length,"BPM index out of range of layer sound loop keys"),n.push(t.sound.add(this.getSoundKey(a,a.soundLoopKeys[s]),e)))})),n}timeToSongTimePosition(t){te(0!=this.bpm,"set BPM before retrieving song times");const e=t/(6e4/this.bpm),s=Math.floor(e/this.data.timeSignatureNumerator)+1,i=e%this.data.timeSignatureNumerator,n=4*i%1;return{bar:s,step:Math.floor(i*(4/this.data.timeSignatureDenominator)*4)+1,tick:Math.floor(n*(this.data.timeBasePPQ/4))}}songTimePositionToTime(t){return te(0!=this.bpm,"set BPM before retrieving song times"),((t.bar-1)*this.data.timeSignatureNumerator+(t.step-1)/(4/this.data.timeSignatureDenominator*4)+t.tick/this.data.timeBasePPQ)*(6e4/this.bpm)}preloadJson(t){const e=U+this.trackKey+"/";this.trackDir=e;const s=(e,s,i)=>{this.data=i,this.parseJson(),this.preloadLoops(t)};t.cache.json.exists(this.trackKey)?s(0,0,t.cache.json.get(this.trackKey)):(t.load.json(this.trackKey,se(e+"info.json")),t.load.on("filecomplete-json-"+this.trackKey,s,this))}unloadJson(t){this.unloadLoops(t),t.cache.json.remove(this.trackKey)}parseJson(){this.setTimePositionDefaults(),this.sortNodes()}setTimePositionDefaults(){this.forEachLayer(void 0,(t=>{const e=(t,e,s,i)=>{t.bar||(t.bar=e),t.step||(t.step=s),t.tick||(t.tick=i)};te(t.progressCount<=t.nodes.length,"Progress count threshold for layer '"+t.id+"' of track '"+this.trackKey+"' cannot be higher than the node count."),e(t.previewTime,0,0,0),t.nodes.forEach((t=>{e(t.timePosition,1,1,0)}))}))}sortNodes(){this.forEachLayer(void 0,(t=>{t.nodes.sort(((t,e)=>t.timePosition.bar!==e.timePosition.bar?t.timePosition.bar-e.timePosition.bar:t.timePosition.step!==e.timePosition.step?t.timePosition.step-e.timePosition.step:t.timePosition.tick-e.timePosition.tick))}))}}class Pe extends v{static preload(t){t.load.image(ht,se(ct)),t.load.image(lt,se("assets/sprites/defaultTargetOuter.png"))}static unload(t){t.textures.remove(ht),t.textures.remove(lt)}constructor(t,e,s,i,n,a,o,r){super(t.matter.world,s.x,s.y,a.data.spriteKeyInner,void 0,{render:{visible:!0}}),this.scene=t,this.lifetime=i,this.fingerId=o,this.nodeIndex=r,this.spriteScale=oe.targetSize,this.scene.add.existing(this),this.songTime=this.lifetime+e,this.lateDuration=oe.lateTimeDuration,this.onTimeDuration=oe.onTimeDuration,this.earlyDuration=this.lifetime-this.onTimeDuration/2,this.sound=this.scene.sound.add(n,{volume:oe.sonificationLevel}),this.setScale(this.spriteScale),this.setTint(tt[this.fingerId]),this.setDepth(95),me(this,!0),this.setCircle(this.displayWidth/2,{label:a.level.trackKey+"-"+a.data.id+"-node-"+r.toString()}),this.setSensor(!0),oe.fancyEffectsDisabled||(this.glow=this.postFX.addGlow(16777215,0,0,!1,.05,24)),this.outerRing=this.scene.add.sprite(s.x,s.y,a.data.spriteKeyOuter),this.outerRing.setScale(.5*this.spriteScale),this.outerRing.setDepth(96),this.targetText=new g(this.scene,0,0,Qt,{}),this.addTargetText(),this.setupTweens()}setOnTargetMiss(t){this.onTargetMiss=t}setOnTargetHit(t){this.scene.hand.addPinchCheck(this.fingerId,this,{startPinch:t}),this.once("pointerdown",t)}addTargetText(){this.targetText=this.scene.add.text(this.x,this.y,(this.nodeIndex+1).toString(),{font:"20px Arial",color:"white"}),this.targetText.setOrigin(.5,.5),this.targetText.setDepth(97)}createTween(t,e,s){for(const s of t)s.tint=e.color;return this.scene.tweens.add({targets:t,displayWidth:this.displayWidth*e.scale,displayHeight:this.displayHeight*e.scale,ease:e.ease,duration:s,repeat:0})}setupTweens(){oe.fancyEffectsDisabled||(this.rotateTween=this.scene.tweens.add({targets:[this],rotation:2*Math.PI,ease:"linear",duration:1e3,repeat:-1})),this.earlyTween=this.createTween([this.outerRing],dt,this.earlyDuration),this.earlyTween.on("complete",(()=>{this.onTimeTween=this.createTween([this],Object.assign(Object.assign({},ut),{scale:1}),this.onTimeDuration),oe.fancyEffectsDisabled||null==this.glow||(this.glowTween=this.scene.tweens.add({targets:this.glow,outerStrength:4,yoyo:!0,duration:this.onTimeDuration/2,ease:"linear"})),this.onTimeTween.on("complete",(()=>{null!=this.glow&&this.glow.destroy(),this.lateTween=this.createTween([this,this.outerRing],Object.assign(Object.assign({},gt),{scale:1}),this.lateDuration),this.lateTween.on("complete",(()=>{me(this,!1),this.deathTween=this.createTween([this,this.outerRing,this.targetText],pt,400),null!=this.onTargetMiss&&this.deathTween.on("complete",this.onTargetMiss)}))}))}))}destroyTarget(){this.scene.hand.removePinchCheck(this.fingerId,this),this.off("pointerdown"),null!=this.rotateTween&&this.scene.tweens.remove(this.rotateTween),null!=this.earlyTween&&this.scene.tweens.remove(this.earlyTween),null!=this.onTimeTween&&this.scene.tweens.remove(this.onTimeTween),null!=this.lateTween&&this.scene.tweens.remove(this.lateTween),null!=this.deathTween&&this.scene.tweens.remove(this.deathTween),null!=this.glowTween&&this.scene.tweens.remove(this.glowTween),null!=this.glow&&this.glow.destroy(),null!=this.targetText&&this.targetText.destroy(),this.outerRing.destroy(),this.destroy()}}class Le extends d{constructor(t){super(t,"metronome"),this.beat=0,this.timer=new c({}),this.countdownText=this.scene.add.text(St.position.x,St.position.y,Qt,{font:St.font,color:St.color}).setOrigin(.5,.5).setScale(St.scale).setDepth(St.depth),this.setVisible(!1)}preload(){this.scene.load.image(kt,se("assets/sprites/countdown.png")),this.scene.load.audio(Tt,se("assets/sounds/metronome/high.ogg")),this.scene.load.audio(xt,se("assets/sounds/metronome/low.ogg"))}unload(){this.scene.cache.audio.remove(Tt),this.scene.cache.audio.remove(xt)}setup(){this.countdownTexture=this.scene.add.sprite(St.position.x,St.position.y,kt).setScale(1).setVisible(!1).setOrigin(.5,.5).setAlpha(.3).setDepth(30)}setVisible(t){null!=this.countdownText&&this.countdownText.setVisible(t),null!=this.countdownTexture&&this.countdownTexture.setVisible(t)}stop(){this.setVisible(!1),null!=this.scene&&(this.scene.time.removeEvent(this.timer),this.scene.sound.stopByKey(Tt),this.scene.sound.stopByKey(xt),null!=this.shrinkTween&&this.scene.tweens.remove(this.shrinkTween))}play(t,e,s){this.beat=0,this.stop(),this.timer=this.scene.time.addEvent({callback:this.tick.bind(this,t,e,s),delay:e,loop:!0,startAt:e})}tick(t,e,s){te(s>=1,"Cannot display metronome for less than minimum bar count");const i=t*s,n=this.beat%t,a=0==n?Tt:xt;this.beat>=i?this.setVisible(!1):(this.countdownText.active&&this.scene.sound.play(a,{volume:oe.backgroundMusicLevel}),te(i-t>=0),this.beat>=i-t&&this.countdownText.active&&!oe.disableVisualMetronome&&this.display(n+1,e),this.beat++)}display(t,e){this.countdownText.setText(t.toString()),this.countdownText.setScale(St.scale),this.countdownTexture.setScale(1),this.setVisible(!0),this.shrinkTween=this.scene.tweens.add({targets:[this.countdownText,this.countdownTexture],ease:St.ease,duration:.9*e,scale:0,repeat:0})}}class Ce extends h{constructor(t){super(t),this.current_=0,this.requiredProgress=-1,this.nodeCount=1,this.tints=[],te(this.current_>=0),this.tints=[],this.scene.add.existing(this),this.setVisible(!1)}preload(){this.scene.load.image(wt.key,se(wt.path))}setup(t,e,s,i){te(s<=e),te(i.length===e,"Must pass tints equal in number to nodes"),te(e>0),te(s>0),te(t>=0),this.current_=t,this.nodeCount=e,this.tints=i,this.requiredProgress=s;const n=wt.size.x/this.nodeCount;this.clear(),this.createMultiple({quantity:this.nodeCount,key:wt.key,visible:!0,setXY:{x:wt.position.x-wt.size.x/2+n/2,y:wt.position.y+wt.size.y/2,stepX:n}}),this.propertyValueSet("displayWidth",n),this.propertyValueSet("displayHeight",wt.size.y),this.setDepth(61),this.redraw()}setToStarting(){this.current_=0,te(this.current_>=0),this.redraw()}redraw(){if(this.current<=this.nodeCount){this.getChildren().forEach(((t,e)=>{t.clearTint()}));const t=-1===this.requiredProgress?this.nodeCount:this.requiredProgress-1,e=this.current;this.getChildren().forEach(((s,i)=>{const n=s;wt.tintByNode&&n.setTint(this.tints[i]),i<e&&(i<=t?n.setTint(wt.completedTint):n.setTint(wt.extraTint)),i===t&&(e>t?n.setTint(wt.completedRequiredTint):n.setTint(wt.requiredTint))}),this)}}canProgress(){const t=-1===this.requiredProgress;return t&&this.current>=this.nodeCount||!t&&this.current>=this.requiredProgress}changeBy(t){this.current_=Math.max(0,Math.min(this.current+t,this.nodeCount))}get current(){return this.current_}}class Be extends d{constructor(t,e){super(t,"infoHUD"),this.scene=t,this.level=e}setup(){this.addTexts(),this.addSkipButton(),this.setVisible(!1)}addSkipButton(){this.skipButton=new ke(this.scene,Lt.position,Lt.scale,Lt.textureKey,Lt.soundKey,!1),this.skipButton.addPinchCallbacks({startPinch:()=>{me(this.skipButton,!1),this.level.transitionLayers()},startHover:()=>{this.skipButton.setTintFill(ot)},endHover:()=>{this.skipButton.clearTint()}}),this.updateSkipButtonAvailability(!1)}preload(){this.scene.load.image(Lt.textureKey,se(Lt.path)),this.scene.load.image(Pt.textureKey,se(Pt.path))}setVisible(t){null!=this.trackText&&this.trackText.setVisible(t),null!=this.difficultyText&&this.difficultyText.setVisible(t),null!=this.bpmText&&this.bpmText.setVisible(t),null!=this.layerText&&this.layerText.setVisible(t),null!=this.loopText&&this.loopText.setVisible(t),null!=this.infoBackground&&this.infoBackground.setVisible(t),this.updateSkipButtonAvailability(t)}addText(t,e){return this.scene.add.text(t.position.x,t.position.y,e,{font:t.font,color:t.color}).setScale(t.scale).setDepth(t.depth)}getLoopText(){return"Loop: "+this.level.score.getLoopCount().toString()}addTexts(){this.loopText=this.addText(Ht,this.getLoopText());const t="Track: "+this.level.track.data.displayName;this.trackText=this.addText(Ct,t);const e="Layer: "+(this.level.activeLayerIndex+1).toString()+"/"+this.level.playableLayers.length.toString();let s=Qt;switch(this.level.bpmIndex){case 0:s="Easy";break;case 1:s="Medium";break;case 2:s="Hard"}te(s!=Qt,"Extend the switch statement to have a difficulty text for the given track bpmIndex"),this.difficultyText=this.addText(Bt,"Difficulty: "+s),this.bpmText=this.addText(Dt,"BPM: "+this.level.track.getBPM()),this.layerText=this.addText(Ot,e),this.infoBackground=this.scene.add.sprite(Pt.position.x,Pt.position.y,Pt.textureKey).setAlpha(Pt.opacity).setOrigin(0,0).setDisplaySize(Pt.size.x,Pt.size.y)}updateLoopText(){this.loopText.setText(this.getLoopText()),this.updateSkipButtonAvailability(!0)}updateSkipButtonAvailability(t){const e=oe.enableSkipButton&&this.level.score.getLoopCount()>=oe.skipLoopThreshold&&t;null!=this.skipButton&&me(this.skipButton,e)}}class De{constructor(){this.targets=[]}start(){this.destroyTargets()}destroyTarget(t){t.destroyTarget();const e=this.targets.indexOf(t,0);e>-1&&this.targets.splice(e,1)}destroyTargets(){const t=[...this.targets];for(const e of t)this.destroyTarget(e)}addTarget(t){this.targets.push(t)}getPreviousTargets(t){return this.targets.filter((e=>e.songTime<t.songTime))}}class Oe{constructor(t,e){this.level=t,this.data=e}getDuration(){return this.level.track.songTimePositionToTime({bar:this.data.lengthInBars+1,step:1,tick:0})}}class He extends Oe{constructor(t,e,s){super(e,s),this.nextNodeIndex=0,this.songTime_=0,this.oldTimePosition=0,this.startTime=0,this.time=0,this.ready=!1,this.scene=t,this.data=s,this.metronome=new Le(this.scene),this.progress=new Ce(this.scene),this.infoHud=new Be(this.scene,this.level),this.targetManager=new De}get songTime(){return this.songTime_}preload(){this.infoHud.preload(),this.metronome.preload(),this.progress.preload()}unload(){this.metronome.unload(),this.infoHud.destroy()}start(t){this.targetManager.start(),this.level.score.delay=t,this.ready=!0,this.startTime=this.time+t,this.nextNodeIndex=0,this.oldTimePosition=0;const e=Math.max(this.data.previewTime.bar,1),s=[];this.data.nodes.forEach(((t,e)=>{const i=oe.indexFingerOnly?nt:t.finger;s.push(tt[i])})),this.progress.setup(0,this.data.nodes.length,this.data.progressCount,s),this.metronome.setup(),this.infoHud.setup(),this.progress.setVisible(!0),this.infoHud.setVisible(!0),this.metronome.play(this.level.track.data.timeSignatureNumerator,this.level.track.beatLength,e)}createTarget(t,e,s){const i=oe.indexFingerOnly?nt:t.finger,n=new Pe(this.scene,this.songTime_,ne(t.normalizedPosition),this.getPreviewTime(),this.level.track.getSoundKey(this.data,t.soundKey),this,i,s);n.setOnTargetMiss((()=>{this.level.score.missedPinch(n),this.progress.changeBy(-1),this.progress.redraw(),this.level.streak.stop(),this.targetManager.destroyTarget(n),this.checkForTransition(e,s)})),n.setOnTargetHit((()=>{const t=this.targetManager.getPreviousTargets(n);for(const e of t)te(e!=n),this.progress.changeBy(-1),this.level.score.skippedPinch(e),this.targetManager.destroyTarget(e);t.length>0&&this.level.streak.stop();const i=this.songTime-n.songTime,a=n.onTimeDuration/2,o=i>a;i<-a?(this.level.streak.stop(),this.progress.changeBy(0),this.level.score.earlyPinch(n,this.songTime)):o?(this.level.streak.stop(),this.progress.changeBy(0),this.level.score.latePinch(n,this.songTime)):(this.level.streak.changeBy(1),this.progress.changeBy(1),this.level.score.onTimePinch(n,this.songTime,this.level.streak.current)),this.progress.redraw(),this.level.streak.check(),oe.disableSonification||n.sound.play({volume:oe.sonificationLevel}),this.targetManager.destroyTarget(n),this.checkForTransition(e,s)})),this.targetManager.addTarget(n)}checkForTransition(t,e){e==this.data.nodes.length-1&&this.level.activeLayerIndex==t&&(oe.enableAutoSkip&&this.level.score.getLoopCount()>=oe.autoSkipThreshold||this.progress.canProgress()&&!oe.disableLayerProgression?this.level.transitionLayers():(this.level.score.incrementLoopCount(),this.progress.setToStarting(),this.infoHud.updateLoopText(),oe.autoSaveCSV&&this.level.score.levelStats))}handleTargetCreation(){if(!this.ready)return;const t=this.getDuration();let e=this.songTime_+this.getPreviewTime();if(this.songTime_>0&&(e%=t),this.data.nodes.length<=this.nextNodeIndex){if(!(e<this.oldTimePosition))return;this.nextNodeIndex=0}const s=this.data.nodes[this.nextNodeIndex];this.level.track.songTimePositionToTime(s.timePosition)%t<=e&&(void 0!==s.finger&&this.createTarget(s,this.level.activeLayerIndex,this.nextNodeIndex),this.nextNodeIndex++),this.oldTimePosition=e}preDelayStop(){this.ready=!1,this.metronome.stop(),this.targetManager.destroyTargets()}postDelayStop(){this.infoHud.setVisible(!1),this.progress.setVisible(!1)}stop(){this.preDelayStop(),this.postDelayStop()}update(t){this.time=t,this.songTime_=this.ready?this.time-this.startTime:0,this.handleTargetCreation()}getPreviewTime(){return this.level.track.songTimePositionToTime({bar:this.data.previewTime.bar+1,step:this.data.previewTime.step+1,tick:this.data.previewTime.tick})}}class _e extends d{constructor(t){super(t,"streak"),this.current_=0,this.onFire=!1,this.hsv=Phaser.Display.Color.HSVColorWheel(),this.streakText=this.scene.add.text(yt.position.x,yt.position.y,Qt,{font:yt.font,color:yt.color}).setVisible(!1).setOrigin(.5,.5).setScale(yt.scale).setDepth(yt.depth).setStroke(yt.color,yt.strokeThickness).setShadow(yt.shadowOffset.x,yt.shadowOffset.y,yt.shadowColor,yt.shadowBlurRadius,!0,!0)}preload(){this.scene.load.image(bt,se("assets/sprites/flare.png"))}unload(){this.scene.textures.remove(bt)}get current(){return this.current_}changeBy(t){this.current_=Math.max(0,this.current+t)}check(){1===this.current_?this.start():this.current_>1?this.continue():this.stop()}updateStreakText(){this.streakText.setText("Streak: "+this.current_.toString())}start(){this.updateStreakText(),this.streakText.setVisible(!0)}stop(){this.current_=0,this.onFire=!1,null!=this.onFireTween&&this.scene.tweens.remove(this.onFireTween),null!=this.streakText&&this.streakText.clearTint(),null!=this.streakText&&this.streakText.setVisible(!1),null!=this.flame&&this.flame.destroy()}continue(){this.updateStreakText();const t=this.onFire;this.onFire=this.current_>=2,!t&&this.onFire&&(te(!0,"Streak color wheel extent must be from 1 to 255"),this.onFireTween=this.scene.tweens.addCounter({from:0,to:30,duration:1e3,yoyo:!0,onUpdate:t=>{if(null!=this&&null!=this.hsv){const e=Math.floor(t.getValue()),s=this.hsv[e].color,i=this.hsv[30-e].color;null!=this.streakText&&this.streakText.setTint(s,s,i,i)}},onStop:()=>{null!=this.onFireTween&&this.scene.tweens.remove(this.onFireTween)}}),oe.fancyEffectsDisabled||(null!=this.flame&&this.flame.destroy(),null!=this.streakText&&(this.flame=this.scene.add.particles(this.streakText.x,this.streakText.y,bt,ft),te(0!=yt.depth),this.flame.setDepth(yt.depth-1))))}}class Me{constructor(){this.total=1,this.required=1,this.correct=0,this.early=0,this.late=0,this.miss=0,this.loop=1,this.hits=[]}}class Ve{constructor(t){this.maxStreak=0,this.layersStats=[],this.id=`${t.data.displayName.replace(/\s/g,"")}@${t.getBPM()}bpm_${(new Date).toLocaleString("en-GB").replace(/\s/g,"").replace(/,/g,"_").replace(/[:/]/g,"-")}`}}class Ie{constructor(t){this.levelStats=new Ve(t),this.layerStats=new Me}getLoopCount(){return this.layerStats.loop}incrementLoopCount(){this.layerStats.correct=0,this.layerStats.early=0,this.layerStats.late=0,this.layerStats.miss=0,this.layerStats.loop++}saveLayerScores(){this.levelStats.layersStats.push(this.layerStats)}resetLayerScores(t,e){this.layerStats=new Me,this.layerStats.total=t,this.layerStats.required=e}addHit(t,e,s){this.layerStats.hits.push({loopNumber:this.getLoopCount(),noteID:t.nodeIndex+1,correctTime:t.songTime+this.delay,playerTime:e,classification:s})}onTimePinch(t,e,s){this.addHit(t,e+this.delay,"correct"),this.layerStats.correct++,this.levelStats.maxStreak=Math.max(s,this.levelStats.maxStreak)}earlyPinch(t,e){this.addHit(t,e+this.delay,"early"),this.layerStats.early++}latePinch(t,e){this.addHit(t,e+this.delay,"late"),this.layerStats.late++}skippedPinch(t){this.addHit(t,-1e3,"skipped"),this.layerStats.miss++}missedPinch(t){this.addHit(t,-1e3,"missed"),this.layerStats.miss++}}class Ae{constructor(t){this.trackKey_=Qt,this.finishCallback=()=>{},this.abortCallback=()=>{},this.activeLayerIndex=0,this.playableLayers=[],this.activeAudioTracks=[],this.bpmIndex_=-1,this.trackKey_=t,this.track=new Se(this.trackKey_)}setBPM(t){te(-1!=t,"BPM must be set before starting the level"),this.track.setBPM(t),this.bpmIndex_=t}get bpmIndex(){return this.bpmIndex_}get trackKey(){return this.trackKey_}init(t){this.scene=t,this.streak=new _e(this.scene),this.score=new Ie(this.track),this.preloadLayers()}hasCustomBackground(){return ie(U+this.getBackgroundTextureKey())}hasPreviewVideo(){return ie(U+this.getPreviewVideoKey())}getBackgroundTextureKey(){return this.trackKey+"/background.png"}getPreviewVideoKey(){return this.trackKey+"/preview.mp4"}preloadTrack(t){const e=U+this.getPreviewVideoKey(),s=U+this.getBackgroundTextureKey();ie(e)&&t.load.video(this.getPreviewVideoKey(),se(e),!0),ie(s)&&t.load.image(this.getBackgroundTextureKey(),se(s)),this.track.preload(t)}unloadTrack(t){this.track.unload(t)}preloadLayers(){this.track.preloadNotes(this.scene),Pe.preload(this.scene),this.streak.preload(),this.playableLayers=[],this.track.forEachLayer(void 0,((t,e)=>{const s=new He(this.scene,this,t);s.preload(),this.playableLayers.push(s)}))}unloadLayers(){this.playableLayers.forEach((t=>{t.unload()})),this.track.unloadNotes(this.scene),Pe.unload(this.scene),this.streak.unload()}start(t,e){this.activeLayerIndex=0,this.removeBackgroundAudio(this.scene),this.playableLayers.forEach((t=>{t.stop()})),this.streak.stop(),this.setBPM(this.bpmIndex_),this.finishCallback=t,this.abortCallback=e,this.scene.time.delayedCall(1e3,(()=>{this.startLayer()}))}addBackgroundAudio(t,e,s){te(-1!=this.bpmIndex_,"Set BPM before adding background audio to level"),this.removeBackgroundAudio(t),this.activeAudioTracks=this.track.addBackgroundAudioTracks(t,e,this.bpmIndex_,s)}removeBackgroundAudio(t){this.activeAudioTracks.forEach((e=>{e.stop(),t.sound.remove(e)})),this.activeAudioTracks=[]}playBackgroundAudio(){this.activeAudioTracks.forEach((t=>{t.setMute(!1),t.play()}))}setBackgroundAudioMute(t){this.activeAudioTracks.forEach((e=>{e.setMute(t)}))}startLayer(){const t=this.getActiveLayer(),e=this.activeLayerIndex;this.score.resetLayerScores(t.data.nodes.length,t.data.progressCount);const s=this.track.songTimePositionToTime({bar:2,step:1,tick:0}),i=Math.max(s,t.getPreviewTime());t.start(i);const n=[...t.data.backgroundLayers];oe.disableSonification&&n.push(t.data.id),this.addBackgroundAudio(this.scene,{loop:!0,volume:oe.backgroundMusicLevel},((t,e)=>n.includes(t.id))),this.scene.time.delayedCall(i,(()=>{this.activeLayerIndex==e&&this.playBackgroundAudio()}))}getActiveLayer(){return te(this.activeLayerIndex<this.playableLayers.length,"Active layer index cannot exceed number of playable layers"),this.playableLayers[this.activeLayerIndex]}transitionLayers(){if(oe.autoSaveCSV&&this.score.levelStats,this.activeLayerIndex<this.playableLayers.length){const t=this.getActiveLayer();t.preDelayStop(),this.removeBackgroundAudio(this.scene),this.activeLayerIndex++;const e=this.activeLayerIndex;if(this.activeLayerIndex>=this.playableLayers.length)return this.score.saveLayerScores(),t.postDelayStop(),void this.end();this.scene.time.delayedCall(1e3,(()=>{this.activeLayerIndex==e&&(this.score.saveLayerScores(),t.postDelayStop(),this.startLayer())}))}}stop(){this.removeBackgroundAudio(this.scene),this.streak.stop(),this.unloadLayers()}end(){this.stop(),this.finishCallback()}abort(){this.stop(),this.abortCallback()}update(t){this.activeLayerIndex<this.playableLayers.length&&this.getActiveLayer().update(t)}getAudioLoopTime(){return this.activeAudioTracks.at(-1).duration}}class Ee extends ke{constructor(t,e,s,i,n,a,o,r=!0){super(t,e,s,i,a,o),this.onSpriteKey=i,this.offSpriteKey=n,this.toggleState=r,this.setTexture(this.getSpriteKey())}setToggleState(t){var e;this.toggleState=t,this.setTexture(this.getSpriteKey()),null===(e=this.toggleCallback)||void 0===e||e.call(this,this.toggleState)}addToggleCallback(t){this.toggleCallback=t,this.toggleCallback(this.toggleState)}toggle(){var t;this.toggleState=!this.toggleState,this.setTexture(this.getSpriteKey()),null===(t=this.toggleCallback)||void 0===t||t.call(this,this.toggleState)}getToggleState(){return this.toggleState}updateTint(){this.toggleState?this.setTintFill(rt):this.clearTint()}getSpriteKey(){return this.toggleState?this.onSpriteKey:this.offSpriteKey}}class Fe extends Ee{constructor(t,e,s,i,n,a,o,r,h,l=!0){super(t,e,s,i,n,a,o,l),this.bpmTextOptions={font:"20px Courier New",color:16777215},this.bpmIndex_=r,this.bpm=h,this.bpmText=this.scene.add.text(0,0,Qt,{font:this.bpmTextOptions.font}),this.bpmText.setText("BPM: "+this.bpm.toString()),this.bpmText.setPosition(e.x-this.bpmText.displayWidth/2,e.y-this.bpmText.displayHeight/2+.023*window.innerHeight),this.updateTint(),this.on("destroy",(()=>{this.bpmText.destroy()}))}updateTint(){this.toggleState?(this.bpmText.setTintFill(rt),this.setTintFill(rt)):(this.bpmText.setTintFill(this.bpmTextOptions.color),this.clearTint())}get bpmIndex(){return this.bpmIndex_}}var Ke=n().Math.Vector2,je=n().Math.RoundTo;class Ne extends l{constructor(t,e,s,i,n,a,o,r){super(t),this.isDragging=!1,this.range=new Ke(0,1),this.isInteger=!1,this.x=e.x,this.y=e.y,this.width=s.x,this.height=s.y,this.key=a,this.updateSliderCallback=r,this.range=o,this.value=.5,this.box=new u(0,0,s.x,s.y),this.handle=new u(0,0,s.y,s.y),this.updateHandle(),null!=i&&(this.label=this.scene.add.text(this.x+i.x,this.y+i.y,Qt,{color:"#ffffff",fontSize:"24px"})),this.setInteractive(this.box,u.Contains),this.on("pointerdown",this.startDrag,this),this.scene.input.on("pointerup",this.stopDrag,this),this.scene.input.on("pointermove",this.doDrag,this),te("number"==typeof n[this.key]),this.setValue(n[this.key]),this.draw()}reset(t){te("number"==typeof t[this.key]),this.setValue(t[this.key]),this.draw()}startDrag(){this.isDragging=!0}doDrag(t){this.isDragging&&(this.value=n().Math.Clamp((t.x-this.x-this.handle.width/2)/(this.width-this.handle.width),0,1),this.updateHandle(),this.draw())}stopDrag(){this.isDragging=!1}updateHandle(){this.handle.x=this.value*(this.width-this.handle.width)}draw(){this.clear(),null!=this.input&&(this.input.enabled||this.setInteractive(this.box,u.Contains),this.updateSliderCallback(this)),this.fillStyle(11184810),this.fillRectShape(this.box),this.fillStyle(16777215),this.fillRectShape(this.handle)}getStringValue(){const t=this.getValue();return this.isInteger?t.toFixed(0):t.toFixed(2)}getValue(){const t=this.value*(this.range.y-this.range.x)+this.range.x;return this.isInteger?je(t,0):t}setIsInteger(t){return this.isInteger=t,this.draw(),this}setValue(t){this.value=(t-this.range.x)/(this.range.y-this.range.x),this.updateHandle(),this.draw()}hide(t){return this.clear(),null!=this.input&&this.disableInteractive(),null!=this.label&&null!=this.label&&this.label.active&&(null!=t?this.label.setText(t):this.label.setText("")),this}}class We extends l{constructor(t,e,s,i,n,a,o,r){super(t),this.labelText=Qt,this.x=e.x,this.y=e.y,this.key=o,null!=i&&(this.labelText=n,this.label=this.scene.add.text(e.x+i.x,e.y+i.y,this.labelText,{color:"#ffffff",fontSize:"24px"})),this.toggleCallback=r,te("boolean"==typeof a[this.key]),this.isChecked_=a[this.key],this.box=new u(0,0,s,s),this.check=new u(.25*s,.25*s,.5*s,.5*s),this.setInteractive(this.box,u.Contains),this.toggleCallback(this),this.on("pointerdown",this.toggleCheck,this),this.draw()}reset(t){te("boolean"==typeof t[this.key]),this.isChecked_=t[this.key],this.toggleCallback(this),this.draw()}resetLabel(){null!=this.label&&this.label.setText(this.labelText)}setLabel(t){null!=this.label&&this.label.setText(t),this.draw()}toggleCheck(){this.isChecked_=!this.isChecked_,this.toggleCallback(this),this.draw()}draw(){this.clear(),null==this.input||this.input.enabled||this.setInteractive(this.box,u.Contains),this.lineStyle(2,16777215),this.strokeRectShape(this.box),this.isChecked_&&(this.fillStyle(16777215),this.fillRectShape(this.check))}setToggled(t){"boolean"==typeof t&&(this.isChecked_=t,this.toggleCallback(this),this.draw())}hide(){return this.clear(),this.disableInteractive(),null!=this.label&&this.label.setText(""),this}get isChecked(){return this.isChecked_}}var ze=function(t,e,s,i){return new(s||(s=Promise))((function(n,a){function o(t){try{h(i.next(t))}catch(t){a(t)}}function r(t){try{h(i.throw(t))}catch(t){a(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,r)}h((i=i.apply(t,e||[])).next())}))};const Re=window.innerWidth,Ge=window.innerHeight,qe=.5*Re,$e=.1*Re,Je=.64*Re,Ue=.1*Ge,Xe=.08*Ge,Qe=.32*Ge,Ye=.08*Ge,Ze=.57*Ge,ts=.08*Ge,es=new r(.26*Re,.03*Ge),ss={type:n().WEBGL,scale:{mode:n().Scale.RESIZE},transparent:!0,physics:{default:"matter",matter:{debug:!1,gravity:{x:0,y:0}}},scene:[class extends p{constructor(){super("electron")}create(){return pe(this,void 0,void 0,(function*(){yield new Promise(((t,e)=>{t()})).then((()=>{this.scene.start(jt)}))}))}},class extends p{constructor(){super(jt)}preload(){this.load.image(y,se("assets/sprites/finger.png")),this.load.image(C,se("assets/ui/menu_background.png"))}create(){return pe(this,void 0,void 0,(function*(){ve=this.add.sprite(0,0,C).setOrigin(0,0).setAlpha(.9).setDisplaySize(window.innerWidth,window.innerHeight);const t=this.add.text(this.cameras.main.worldView.x+this.cameras.main.width/2,this.cameras.main.worldView.y+this.cameras.main.height/2,"",mt).setShadow(1,1).setDepth(1e3).setOrigin(.5);yield ce.init(Jt,this.updateText.bind(this,t)).catch((e=>{this.updateText(t,e)})),ce.found()&&(this.updateText(t,"Loading config data..."),yield he(Y),yield ge.init(this.updateText.bind(this,t)).catch((e=>this.updateText(t,e))),ge.found()&&(ce.setVisibility(Jt.visible),this.scene.launch($t),ge.precache(this.updateText.bind(this,t)),this.updateText(t,"Loading game..."),this.scene.get($t).load.on("complete",(()=>{t.destroy()}))))}))}updateText(t,e){console.info("INFO: "+e);let s=e;e instanceof DOMException&&(s="NotFoundError"==e.name?"Webcam not found":"PermissionError"==e.name?"Permission denied":"NotADirectoryError"==e.name?e.message:e.name+": "+e.message),t.setText(s)}},class extends xe{constructor(){super(zt),this.levels=[]}preload(){const t=Object.create(null,{preload:{get:()=>super.preload}});return e=this,s=void 0,n=function*(){t.preload.call(this),this.load.audio(M,se(q)),this.load.image(I,se("assets/ui/menu_logo.png")),this.load.image(S,se("assets/ui/menu_options.png")),this.load.image(k,se("assets/ui/menu_select_level.png")),this.load.image(x,se("assets/ui/menu_setup_camera.png")),yield function(t){return new Promise(((e,s)=>Yt(this,void 0,void 0,(function*(){yield Zt(se(t)).then((t=>{e(t)})).catch((()=>{s([])}))}))))}(se(X)).then((t=>{t.forEach(((t,e)=>{this.levels.push(new Ae(t))})),this.levels.forEach((t=>{t.preloadTrack(this)}))}))},new((i=void 0)||(i=Promise))((function(t,a){function o(t){try{h(n.next(t))}catch(t){a(t)}}function r(t){try{h(n.throw(t))}catch(t){a(t)}}function h(e){var s;e.done?t(e.value):(s=e.value,s instanceof i?s:new i((function(t){t(s)}))).then(o,r)}h((n=n.apply(e,s||[])).next())}));var e,s,i,n}create(){super.create(),this.levels.forEach((t=>{t.setBPM(0)}));const t=window.innerWidth,e=window.innerHeight,s=.5*t;this.menuCalibrate=new ke(this,new r(s-.25*t,Kt*e),Mt,x,M,!0),this.levels.length>0&&(this.menuSelectLevel=new ke(this,new r(s,Kt*e),Mt,k,M,!0),this.menuSelectLevel.addPinchCallbacks({startPinch:()=>{this.scene.start(Rt,this.levels)},startHover:()=>{this.menuSelectLevel.setTintFill(ot)},endHover:()=>{this.menuSelectLevel.clearTint()}})),this.menuOptions=new ke(this,new r(s+.25*t,Kt*e),Mt,S,M,!0),this.menuLogo=this.add.sprite(0,0,I).setOrigin(0,0).setScale(.7,.7),this.menuLogo.setPosition(s-this.menuLogo.displayWidth/2,.25*e),this.menuCalibrate.addPinchCallbacks({startPinch:()=>{this.scene.start(Gt)},startHover:()=>{this.menuCalibrate.setTintFill(ot)},endHover:()=>{this.menuCalibrate.clearTint()}}),this.menuOptions.addPinchCallbacks({startPinch:()=>{this.scene.start(qt)},startHover:()=>{this.menuOptions.setTintFill(ot)},endHover:()=>{this.menuOptions.clearTint()}})}update(t,e){super.update(t,e)}},class extends xe{constructor(){super(qt),this.options=[],he(Y).then((t=>ze(this,void 0,void 0,(function*(){this.configData=t,yield he(Z).then((t=>{this.defaultData=t}))}))))}saveAndExit(){var t;t=this.configData,se(Y),JSON.stringify(t),re(t),ce.setVisibility(this.configData.enableCameraVisibility),null!=this.rotateTween&&this.rotateTween.destroy(),this.scene.start(zt)}preload(){return ze(this,void 0,void 0,(function*(){this.load.audio(M,se(q)),this.load.image(L,se("assets/ui/options_background.png")),this.load.image(_,se(G)),this.load.image(A,se("assets/ui/reset_button.png")),this.load.image(P,se(R))}))}create(){const t=Object.create(null,{create:{get:()=>super.create}});return ze(this,void 0,void 0,(function*(){t.create.call(this),this.createOptions()}))}createOptions(){this.backToMenu=new ke(this,new r(qe-.1*Re,.9*Ge),Mt,_,M,!0),this.resetConfig=new ke(this,new r(qe+.1*Re,.9*Ge),Mt,A,M,!0),this.input.keyboard.on(vt,(()=>{this.saveAndExit()})),this.add.sprite(.09*Re,.05*Ge,L).setOrigin(0,0).setAlpha(.8).setDisplaySize(.28*Re,.185*Ge),this.add.sprite(.09*Re,.26*Ge,L).setOrigin(0,0).setAlpha(.8).setDisplaySize(.28*Re,.27*Ge),this.add.sprite(.09*Re,.55*Ge,L).setOrigin(0,0).setAlpha(.8).setDisplaySize(.28*Re,.23*Ge),this.add.sprite(.63*Re,.05*Ge,L).setOrigin(0,0).setAlpha(.8).setDisplaySize(.28*Re,.185*Ge),this.add.sprite(.63*Re,.26*Ge,L).setOrigin(0,0).setAlpha(.8).setDisplaySize(.28*Re,.27*Ge),this.add.sprite(.63*Re,.55*Ge,L).setOrigin(0,0).setAlpha(.8).setDisplaySize(.28*Re,.23*Ge);const t=this.add.sprite(.5*Re,Ue+0*Xe+.15*Ge,P).setTint(tt[it]).setScale(this.configData.targetSize);this.rotateTween=this.tweens.add({targets:[t],rotation:2*Math.PI,ease:"Power0",duration:1e3,repeat:-1}),this.configData.fancyEffectsDisabled&&null!=this.rotateTween&&this.rotateTween.pause();const e=new Ne(this,new r($e,Ue+0*Xe),es,new r(0,At.y),this.configData,"targetSize",new r(.5,3),(e=>{e.label.setText("Target Scale: "+e.getStringValue());const s=e.getValue();this.configData[e.key]=s,t.setScale(s)}));this.options.push(e),this.add.existing(e);const s=new Ne(this,new r($e,Ue+1*Xe),es,new r(0,At.y),this.configData,"fingerSize",new r(.5,3),(t=>{null!=t.label&&t.label.setText("Finger Scale: "+t.getStringValue());const e=t.getValue();this.configData[t.key]=e,this.hand.setFingerScale(e)}));this.options.push(s),this.add.existing(s);const i=t=>{null!=t&&t.active&&(null!=t.label&&t.label.active&&t.label.setText("Camera Opacity: "+t.getStringValue()),this.configData[t.key]=t.getValue(),this.setOpacity(this.configData[t.key]))},n=new Ne(this,new r($e,Qe+0*Ye),es,At,this.configData,"cameraOpacity",new r(.01,1),i),a=new We(this,new r($e,Qe+0*Ye+It.y),25,void 0,Qt,this.configData,"enableCameraVisibility",(t=>{this.configData[t.key]=t.isChecked,ce.setVisibility(t.isChecked),t.isChecked?n.draw():(n.setValue(this.defaultData.cameraOpacity),i(n),this.setOpacity(0),n.hide("Show Camera"))}));this.options.push(n),this.options.push(a),this.add.existing(n),this.add.existing(a);const o=new Ne(this,new r($e,Qe+1*Ye),es,At,this.configData,"skipLoopThreshold",new r(1,16),(t=>{t.label.setText("Skip Button After Loop: "+t.getStringValue()),this.configData[t.key]=t.getValue()})).setIsInteger(!0),h=new We(this,new r($e,Qe+1*Ye+It.y),25,void 0,Qt,this.configData,"enableSkipButton",(t=>{this.configData[t.key]=t.isChecked,t.isChecked?o.draw():o.hide("Show Layer Skip Button")}));this.options.push(o),this.options.push(h),this.add.existing(o),this.add.existing(h);const l=new Ne(this,new r($e,Qe+2*Ye),es,At,this.configData,"autoSkipThreshold",new r(1,16),(t=>{t.label.setText("Skip Layers After Loop: "+t.getStringValue()),this.configData[t.key]=t.getValue()})).setIsInteger(!0),c=new We(this,new r($e,Qe+2*Ye+It.y),25,void 0,Qt,this.configData,"enableAutoSkip",(t=>{this.configData[t.key]=t.isChecked,t.isChecked?l.draw():l.hide("Skip Layers Automatically")}));this.options.push(l),this.options.push(c),this.add.existing(l),this.add.existing(c);const d=new We(this,new r($e,Ze+0*ts),25,new r(-It.x,0),"Disable Layer Progression",this.configData,"disableLayerProgression",(t=>{this.configData[t.key]=t.isChecked}));this.options.push(d),this.add.existing(d);const u=new We(this,new r($e,Ze+1*ts),25,new r(-It.x,0),"Index Finger Pinches Only",this.configData,"indexFingerOnly",(t=>{this.configData[t.key]=t.isChecked}));this.options.push(u),this.add.existing(u);const g=new We(this,new r($e,Ze+2*ts),25,new r(-It.x,0),"Disable Fancy Effects",this.configData,"fancyEffectsDisabled",(e=>{this.configData[e.key]=e.isChecked,e.isChecked?null!=this.rotateTween&&this.rotateTween.pause():e.isChecked||null!=this.rotateTween&&null!=t&&this.rotateTween.resume()}));this.options.push(g),this.add.existing(g);const p=new Ne(this,new r(Je,Ue+0*Xe),es,new r(0,At.y),this.configData,"onTimeDuration",new r(50,1e3),(t=>{t.label.setText("On Time Duration: "+t.getStringValue()+" ms"),this.configData[t.key]=t.getValue()})).setIsInteger(!0);this.options.push(p),this.add.existing(p);const v=new Ne(this,new r(Je,Ue+1*Xe),es,new r(0,At.y),this.configData,"lateTimeDuration",new r(50,1e3),(t=>{t.label.setText("Late Time Duration: "+t.getStringValue()+" ms"),this.configData[t.key]=t.getValue()})).setIsInteger(!0);this.options.push(v),this.add.existing(v);const m=new Ne(this,new r(Je,Qe+0*Ye),es,new r(0,At.y),this.configData,"sonificationLevel",new r(0,1),(t=>{t.label.setText("Pinch Volume: "+t.getStringValue()),this.configData[t.key]=t.getValue()}));this.options.push(m),this.add.existing(m);const y=new Ne(this,new r(Je,Qe+1*Ye),es,new r(0,At.y),this.configData,"backgroundMusicLevel",new r(0,1),(t=>{t.label.setText("Track Volume: "+t.getStringValue()),this.configData[t.key]=t.getValue()}));this.options.push(y),this.add.existing(y);const f=new We(this,new r(Je,Ze+0*ts),25,new r(-It.x,0),"Disable Visual Metronome",this.configData,"disableVisualMetronome",(t=>{this.configData[t.key]=t.isChecked}));this.options.push(f),this.add.existing(f);const b=new We(this,new r(Je,Ze+1*ts),25,new r(-It.x,0),"Disable Sonification",this.configData,"disableSonification",(t=>{this.configData[t.key]=t.isChecked}));this.options.push(b),this.add.existing(b),this.backToMenu.addPinchCallbacks({startPinch:()=>{this.saveAndExit()},startHover:()=>{this.backToMenu.setTintFill(ot)},endHover:()=>{this.backToMenu.clearTint()}}),this.resetConfig.addPinchCallbacks({startPinch:()=>ze(this,void 0,void 0,(function*(){this.configData=yield he(Z);for(const t of this.options)t.reset(this.configData)})),startHover:()=>{this.resetConfig.setTintFill(ot)},endHover:()=>{this.resetConfig.clearTint()}})}update(t,e){super.update(t,e)}},class extends xe{constructor(){super(Rt),this.currentLevelIndex=0,this.difficultyButtons=[],this.levels=[],te(this.currentLevelIndex>=0,"Level select default level must be >= 0")}preload(){this.levels=this.scene.settings.data,te(this.currentLevelIndex<this.levels.length,"Cannot set defaut level select index above the number of levels"),this.load.image(D,se("assets/ui/easy_button.png")),this.load.image(O,se("assets/ui/medium_button.png")),this.load.image(H,se("assets/ui/hard_button.png")),this.load.image(E,se($)),this.load.image(F,se(J)),this.load.image(_,se(G)),this.load.image(B,se("assets/ui/play_button.png")),this.load.image(K,se("assets/ui/left_arrow.png")),this.load.image(j,se("assets/ui/right_arrow.png")),this.load.image(z,se("assets/ui/default_preview_background.png")),this.load.image(f,se("assets/ui/video_background.png")),this.load.image(b,se("assets/ui/song_name_background.png"))}create(){super.create();const t=window.innerWidth,e=window.innerHeight,s=.5*t;this.play=new ke(this,new r(s,.9*e),Mt,B,M,!0),this.previousLevel=new ke(this,new r(s-.235*t,Et*e),new r(.4,.4),K,M,!0),this.nextLevel=new ke(this,new r(s+.235*t,Et*e),new r(.4,.4),j,M,!0),this.backToMenu=new ke(this,new r(s-.4*t,.9*e),Mt,_,M,!0),this.muteButton=new Ee(this,new r(s+.45*t,.9*e),new r(1.5,1.5),E,F,M,!0,!0),this.input.keyboard.on(vt,(()=>{this.scene.start(zt),this.exit()})),this.add.sprite(.5*window.innerWidth,.5*window.innerHeight-.1*window.innerHeight,f).setScale(_t.x,_t.y).setOrigin(.5,.5),this.backToMenu.addPinchCallbacks({startPinch:()=>{this.scene.start(zt),this.exit()},startHover:()=>{this.backToMenu.setTintFill(ot)},endHover:()=>{this.backToMenu.clearTint()}}),this.play.addPinchCallbacks({startPinch:()=>{this.startLevel(this.getCurrentLevel())},startHover:()=>{this.play.setTintFill(ot)},endHover:()=>{this.play.clearTint()}}),this.add.sprite(s,e*Et,b).setTintFill(0).setScale(.4,.4).setOrigin(.5,.5),this.songName=this.add.text(s,e*Et,Qt,{font:"50px Courier New"}).setColor("white").setOrigin(.5,.5),this.updateLevel(0),this.previousLevel.addPinchCallbacks({startPinch:()=>{this.updateLevel(-1)},startHover:()=>{this.previousLevel.setTintFill(ot)},endHover:()=>{this.previousLevel.clearTint()}}),this.nextLevel.addPinchCallbacks({startPinch:()=>{this.updateLevel(1)},startHover:()=>{this.nextLevel.setTintFill(ot)},endHover:()=>{this.nextLevel.clearTint()}}),this.muteButton.addToggleCallback((t=>{this.setBackgroundAudioMute(!t)})),this.muteButton.addPinchCallbacks({startPinch:()=>{this.muteButton.toggle()},startHover:()=>{this.muteButton.setTintFill(ot)},endHover:()=>{this.muteButton.clearTint()}})}exit(){this.stopAudio()}startLevel(t){this.exit(),this.scene.start(Nt,t)}createDifficultyButtons(t){const e=window.innerWidth,s=window.innerHeight,i=.5*e;for(const t of this.difficultyButtons)t.destroy();this.difficultyButtons=[];const n=t.track.data.bpm,a=[D,O,H],o=[new r(i-.2*e,Ft*s),new r(i,Ft*s),new r(i+.2*e,Ft*s)];te(a.length>=n.length,"buttonKeys array length must at least match the number of track bpms"),te(o.length>=n.length,"positions array length must at least match the number of track bpms");for(let e=0;e<n.length;e++){const s=e,i=n[e],h=a[e],l=0==e,c=new Fe(this,o[e],new r(.4,.4),h,h,M,!0,s,i,l);c.addToggleCallback((e=>{c.updateTint(),e&&(t.setBPM(c.bpmIndex),this.startPreview(t))})),c.addPinchCallbacks({startPinch:()=>{for(const t of this.getDifficultyButtons())t!=c&&t.setToggleState(!1);c.setToggleState(!0)},startHover:()=>{c.setTintFill(ot)},endHover:()=>{c.updateTint()}}),this.difficultyButtons.push(c)}}getDifficultyButtons(){return this.difficultyButtons}setBackgroundAudioMute(t){for(const e of this.levels)e.setBackgroundAudioMute(t)}startVideo(t){if(null!=this.videoPreview&&this.videoPreview.destroy(),t.hasPreviewVideo()){this.videoPreview=this.add.video(.5*window.innerWidth,.5*window.innerHeight-.1*window.innerHeight,t.getPreviewVideoKey()).setScale(_t.x,_t.y).setOrigin(.5,.5);const e=t.track.data.bpm[t.bpmIndex]/t.track.data.bpm[0];this.videoPreview.video&&(this.videoPreview.video.playbackRate=e),this.videoPreview.play(!0)}else this.videoPreview=this.add.sprite(.5*window.innerWidth,.5*window.innerHeight-.1*window.innerHeight,z).setScale(_t.x,_t.y).setOrigin(.5,.5)}startPreview(t){this.stopAudio(),t.addBackgroundAudio(this,{loop:!0,volume:.5*oe.backgroundMusicLevel}),t.playBackgroundAudio(),t.setBackgroundAudioMute(!this.muteButton.getToggleState());const e=1e3*t.getAudioLoopTime();this.videoRefreshEvent=this.time.addEvent({delay:e,callback:()=>{this.startVideo(t)},callbackScope:this,loop:!0,startAt:e})}stopAudio(){this.videoRefreshEvent&&this.videoRefreshEvent.destroy();for(const t of this.levels)t.removeBackgroundAudio(this)}updateLevel(t){this.cycleLevel(t);const e=this.getCurrentLevel();this.songName.setText(e.track.data.displayName),this.startPreview(e),this.createDifficultyButtons(e)}cycleLevel(t){const e=this.levels.length;this.currentLevelIndex=((this.currentLevelIndex+t)%e+e)%e}getCurrentLevel(){return te(this.currentLevelIndex<this.levels.length,"Current level index out of range of this.levels array"),this.levels[this.currentLevelIndex]}getCurrentLevelKey(){return"level"+(this.currentLevelIndex+1).toString()}update(t,e){super.update(t,e)}},class extends xe{constructor(){super(Nt)}preload(){this.level=this.scene.settings.data,this.level.init(this),this.load.image(W,se("assets/ui/default_level_background.png"))}create(){super.create(),this.level.hasCustomBackground()?this.setBackgroundTexture(this.level.getBackgroundTextureKey()):this.setBackgroundTexture(W),this.input.keyboard.on(vt,(()=>{this.level.abort()})),this.level.start((()=>{this.scene.start(Wt,this.level)}),(()=>{this.scene.start(zt)}))}update(t,e){super.update(t,e),this.level.update(t)}},class extends xe{constructor(){super(Wt)}exit(){this.level.removeBackgroundAudio(this),this.scene.start(zt)}preload(){this.load.audio(M,se(q)),this.load.image(_,se(G)),this.load.image(E,se($)),this.load.image(F,se(J)),this.load.image(N,se("assets/ui/save_csv_button.png")),this.load.image(w,se("assets/ui/layer_score_background.png")),this.load.image(T,se("assets/ui/scoreboard_background.png")),this.level=this.scene.settings.data,this.levelStats=this.level.score.levelStats,oe.autoSaveCSV&&this.level.score.levelStats}create(){super.create();const t=window.innerWidth,e=window.innerHeight,s=.5*t,i=Math.min(t/1920,e/1080);this.backToMenu=new ke(this,new r(s,.9*e),Mt,_,M,!0),this.muteButton=new Ee(this,new r(s+.45*t,.9*e),Vt,E,F,M,!0,!0),this.level.addBackgroundAudio(this,{loop:!0,volume:.5*oe.backgroundMusicLevel}),this.level.playBackgroundAudio(),this.muteButton.addToggleCallback((t=>{this.level.setBackgroundAudioMute(!t)})),this.muteButton.addPinchCallbacks({startPinch:()=>{this.muteButton.toggle()},startHover:()=>{this.muteButton.setTintFill(ot)},endHover:()=>{this.muteButton.clearTint()}}),this.input.keyboard.on(vt,(()=>{this.exit()})),oe.autoSaveCSV||(this.saveButton=new ke(this,new r(s-.4*t,.9*e),new r(.6,.6),N,M,!0),this.saveButton.addPinchCallbacks({startPinch:()=>{var t,e;t=this.levelStats,e=new Blob([a(t)],{type:"text/plain;charset=utf-8"}),ae.saveAs(e,t.id+".csv")},startHover:()=>{this.saveButton.setTintFill(ot)},endHover:()=>{this.saveButton.clearTint()}})),this.add.sprite(0,0,T).setOrigin(.5,.5).setScale(1.35*i,1.25*i).setAlpha(.6).setPosition(s,.25*e);const n=this.add.text(s,0,"Scoreboard",{color:"#01c303",font:96*i+"px Arial"});n.setStroke("#000",6*i),n.setPosition(s-n.width/2,.07*e);const o=this.levelStats.layersStats.reduce(((t,e)=>t+e.total),0),h=this.levelStats.layersStats.reduce(((t,e)=>t+e.correct),0),l=this.levelStats.layersStats.reduce(((t,e)=>t+e.miss),0),c=this.levelStats.layersStats.reduce(((t,e)=>t+e.early),0),d=this.levelStats.layersStats.reduce(((t,e)=>t+e.late),0),u=this.add.text(s,0,`Total Correct: ${h.toString()}/${o.toString()}\nLongest Streak: ${this.levelStats.maxStreak}\nMissed: ${l}\nEarly: ${c}\nLate: ${d}`,{color:"#ffffff",align:"center",font:48*i+"px Arial"});u.setPosition(s-u.width/2,.19*e);const g=[.25,.5,.75],p=g;this.level.track.forEachLayer(void 0,((s,n)=>{this.add.sprite(0,0,w).setOrigin(.5,.5).setScale(1.35*i,1.15*i).setAlpha(.6).setPosition(t*g[n],.63*e);const a=this.add.text(0,0,`${o=s.id,o&&o[0].toUpperCase()+o.slice(1)||""}`,{color:"#01c303",align:"center",font:72*i+"px Arial",fontStyle:"bold"});var o;a.setStroke("#000",4*i),a.setPosition(t*p[n]-a.width/2,.53*e);const r=this.levelStats.layersStats[n];let h=0,l=0,c=0;null!=r&&(h=r.correct,l=r.total,c=r.loop);const d=this.add.text(0,0,`\nCorrect: ${h.toString()}/${l.toString()}\nLoops: ${c.toString()}`,{color:"#ffffff",align:"center",font:48*i+"px Arial"});d.setPosition(t*p[n]-d.width/2,.575*e+.01)})),this.backToMenu.addPinchCallbacks({startPinch:()=>{this.exit()},startHover:()=>{this.backToMenu.setTintFill(ot)},endHover:()=>{this.backToMenu.clearTint()}})}update(t,e){super.update(t,e)}},class extends xe{constructor(){super(Gt)}exit(){this.scene.start(zt)}preload(){this.load.image(_,se(G)),this.load.audio(M,se(q)),this.load.image(V,se("assets/ui/calibration_background.png"))}create(){super.create(!0,.8);const t=window.innerWidth,e=window.innerHeight,s=.5*t;this.backToMenu=new ke(this,new r(s,.9*e),Mt,_,M,!0),this.setBackgroundTexture(V),this.input.keyboard.on(vt,(()=>{this.exit()})),this.distanceText=this.add.text(s,.1*e,Qt,{color:"white",font:"60px Arial"}).setShadow(5,5,"rgba(0,0,0,0.5)",15).setOrigin(.5,.5),this.backToMenu.addPinchCallbacks({startPinch:()=>{this.exit()},startHover:()=>{this.backToMenu.setTintFill(ot)},endHover:()=>{this.backToMenu.clearTint()}})}update(t,e){super.update(t,e);const s=this.hand.calculateHandDistance();let i="Hand Not Recognized";if(s>0){let t=65280;s>40?(i="Too Far - Estimated Distance: ",t=16711680):s<20?(i="Too Close - Estimated Distance: ",t=255):i="Just Right - Estimated Distance: ",this.setBackgroundTint(t),i+=s.toFixed(0)+" cm"}else this.clearBackgroundTint();null!=this.distanceText&&this.distanceText.active&&this.distanceText.setText(i)}}]};new(n().Game)(ss)}},s={};function i(t){var n=s[t];if(void 0!==n)return n.exports;var a=s[t]={exports:{}};return e[t].call(a.exports,a,a.exports,i),a.exports}i.m=e,t=[],i.O=(e,s,n,a)=>{if(!s){var o=1/0;for(c=0;c<t.length;c++){for(var[s,n,a]=t[c],r=!0,h=0;h<s.length;h++)(!1&a||o>=a)&&Object.keys(i.O).every((t=>i.O[t](s[h])))?s.splice(h--,1):(r=!1,a<o&&(o=a));if(r){t.splice(c--,1);var l=n();void 0!==l&&(e=l)}}return e}a=a||0;for(var c=t.length;c>0&&t[c-1][2]>a;c--)t[c]=t[c-1];t[c]=[s,n,a]},i.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return i.d(e,{a:e}),e},i.d=(t,e)=>{for(var s in e)i.o(e,s)&&!i.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),(()=>{var t={792:0};i.O.j=e=>0===t[e];var e=(e,s)=>{var n,a,[o,r,h]=s,l=0;if(o.some((e=>0!==t[e]))){for(n in r)i.o(r,n)&&(i.m[n]=r[n]);if(h)var c=h(i)}for(e&&e(s);l<o.length;l++)a=o[l],i.o(t,a)&&t[a]&&t[a][0](),t[a]=0;return i.O(c)},s=self.webpackChunkPizzicato=self.webpackChunkPizzicato||[];s.forEach(e.bind(null,0)),s.push=e.bind(null,s.push.bind(s))})();var n=i.O(void 0,[96],(()=>i(852)));n=i.O(n)})();